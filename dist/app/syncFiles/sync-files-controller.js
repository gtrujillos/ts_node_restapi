var a73_0x346a=['utf8','parse','CountingInfo','Out','EndTime','create','passCountingsModel','uploadEvent','file','path','filename','.json','createReadStream','finish','size','eventos','hora','YYYYMMDD\x20HHmmss\x20Z','longitud','replace','velocidad','puerta','ingresos','locationPointsModel','__importDefault','__esModule','defineProperty','ftp','../../infrastructure/controller-utils','moment','default','syncFtp','bind','downloadFtp','processFtp','ready','log','list','colombia','name','endsWith','json','models','syncFilesModel','findOrCreate','push','connect','ipd','then','file_name','get','colombia/','end','media/','.txt','pipe','createWriteStream','status','save','fileName','error','existsSync','statSync','fileName:\x20','fileSizeInBytes:\x20','readFile'];(function(_0x1196c6,_0x44e6fa){var _0x18d0d0=function(_0x300794){while(--_0x300794){_0x1196c6['push'](_0x1196c6['shift']());}};_0x18d0d0(++_0x44e6fa);}(a73_0x346a,0x162));var a73_0x979c=function(_0x1f235e,_0x2449ab){_0x1f235e=_0x1f235e-0x0;var _0x4c87e2=a73_0x346a[_0x1f235e];return _0x4c87e2;};'use strict';var __importDefault=this&&this[a73_0x979c('0x0')]||function(_0x2dfc04){return _0x2dfc04&&_0x2dfc04[a73_0x979c('0x1')]?_0x2dfc04:{'default':_0x2dfc04};};Object[a73_0x979c('0x2')](exports,a73_0x979c('0x1'),{'value':!![]});const ftp_1=__importDefault(require(a73_0x979c('0x3')));const fs_1=__importDefault(require('fs'));const controller_utils_1=__importDefault(require(a73_0x979c('0x4')));const sequelize_utils_1=__importDefault(require('../../infrastructure/sequelize-utils'));const moment_1=__importDefault(require(a73_0x979c('0x5')));const UPLOAD_PATH='media';class SyncFilesController extends controller_utils_1[a73_0x979c('0x6')]{constructor(_0x546c48){super(_0x546c48,null);this['syncFtp']=this[a73_0x979c('0x7')][a73_0x979c('0x8')](this);this[a73_0x979c('0x9')]=this[a73_0x979c('0x9')][a73_0x979c('0x8')](this);this[a73_0x979c('0xa')]=this[a73_0x979c('0xa')]['bind'](this);}[a73_0x979c('0x7')](_0x51ad6c,_0x5028b8,_0x57242e){console['log']('connecting');const _0x14f8ef=[];const _0x2b5203=new ftp_1[(a73_0x979c('0x6'))]();_0x2b5203['on'](a73_0x979c('0xb'),function(){console[a73_0x979c('0xc')]('connected');_0x2b5203[a73_0x979c('0xd')](a73_0x979c('0xe'),![],function(_0x3e9b33,_0x41d667){if(_0x3e9b33){console[a73_0x979c('0xc')](_0x3e9b33);}else{for(const _0x52d24a of _0x41d667){if(_0x52d24a[a73_0x979c('0xf')][a73_0x979c('0x10')](a73_0x979c('0x11'))&&_0x52d24a['size']>0x0){sequelize_utils_1[a73_0x979c('0x6')][a73_0x979c('0x12')][a73_0x979c('0x13')][a73_0x979c('0x14')]({'where':{'file_name':_0x52d24a[a73_0x979c('0xf')]}})['spread']((_0x11e162,_0x531d0c)=>{if(_0x531d0c){_0x14f8ef[a73_0x979c('0x15')](_0x11e162);}});}}}});});_0x2b5203['on']('error',function(_0x53557e){});_0x2b5203[a73_0x979c('0x16')]({'host':'ftp.vivotek.com','port':0x15,'user':'ipd','password':a73_0x979c('0x17')});_0x5028b8[a73_0x979c('0x11')]({'data':[]});}[a73_0x979c('0x9')](_0x5b17a6,_0x34732b,_0x12614d){sequelize_utils_1[a73_0x979c('0x6')][a73_0x979c('0x12')]['syncFilesModel']['findOne']({'where':{'status':null}})[a73_0x979c('0x18')](_0x3ecc2f=>{if(_0x3ecc2f){const _0x312aca=new ftp_1[(a73_0x979c('0x6'))]();_0x312aca['on'](a73_0x979c('0xb'),function(){console[a73_0x979c('0xc')]('connected:'+_0x3ecc2f[a73_0x979c('0x19')]);_0x312aca[a73_0x979c('0x1a')](a73_0x979c('0x1b')+_0x3ecc2f[a73_0x979c('0x19')],function(_0x1729d9,_0xcbd622){_0x312aca[a73_0x979c('0x1c')]();if(_0x1729d9){}else{const _0x5c506e=a73_0x979c('0x1d')+_0x3ecc2f[a73_0x979c('0x19')]+a73_0x979c('0x1e');_0xcbd622[a73_0x979c('0x1f')](fs_1[a73_0x979c('0x6')][a73_0x979c('0x20')](_0x5c506e));_0x3ecc2f[a73_0x979c('0x21')]=0x1;_0x3ecc2f[a73_0x979c('0x22')]();console[a73_0x979c('0xc')]('Downloaded:\x20'+_0x3ecc2f[a73_0x979c('0x23')]);}});});_0x312aca['on'](a73_0x979c('0x24'),function(_0x3a6c60){});_0x312aca[a73_0x979c('0x16')]({'host':'ftp.vivotek.com','port':0x15,'user':'ipd','password':'ipd'});}else{}});_0x34732b['json']({'data':[]});}[a73_0x979c('0xa')](_0x19d1f2,_0x37a189,_0x2455fd){sequelize_utils_1[a73_0x979c('0x6')][a73_0x979c('0x12')]['syncFilesModel']['findOne']({'where':{'status':0x1}})[a73_0x979c('0x18')](_0x2a7a66=>{if(_0x2a7a66){const _0x3bca32='media/'+_0x2a7a66[a73_0x979c('0x19')]+a73_0x979c('0x1e');if(fs_1[a73_0x979c('0x6')][a73_0x979c('0x25')](_0x3bca32)){const _0x4e63ac=fs_1[a73_0x979c('0x6')][a73_0x979c('0x26')](_0x3bca32);const _0x4b1710=_0x4e63ac['size'];console['log'](a73_0x979c('0x27')+_0x3bca32);console[a73_0x979c('0xc')](a73_0x979c('0x28')+_0x4b1710);if(_0x4b1710>0x0){fs_1[a73_0x979c('0x6')][a73_0x979c('0x29')](_0x3bca32,a73_0x979c('0x2a'),function(_0x4c9259,_0x15da79){if(_0x4c9259){_0x2a7a66[a73_0x979c('0x21')]=null;}else{try{const _0x13dfa5=JSON[a73_0x979c('0x2b')](_0x15da79);for(const _0x5d299c of _0x13dfa5['Data'][0x0][a73_0x979c('0x2c')]){const _0xba9e1=_0x5d299c['In'];const _0x40cd3d=_0x5d299c[a73_0x979c('0x2d')];const _0x57948f=Date[a73_0x979c('0x2b')](_0x5d299c[a73_0x979c('0x2e')]);if(_0xba9e1>0x0){sequelize_utils_1[a73_0x979c('0x6')]['models']['passCountingsModel'][a73_0x979c('0x2f')]({'amount':_0xba9e1,'counted_at':_0x57948f});}if(_0x40cd3d>0x0){sequelize_utils_1[a73_0x979c('0x6')][a73_0x979c('0x12')][a73_0x979c('0x30')][a73_0x979c('0x2f')]({'amount':_0x40cd3d*-0x1,'counted_at':_0x57948f});}}_0x2a7a66[a73_0x979c('0x21')]=0x2;}catch(_0x1420be){_0x2a7a66['status']=null;}}_0x2a7a66[a73_0x979c('0x22')]();});}else{_0x2a7a66[a73_0x979c('0x21')]=null;_0x2a7a66['save']();}}else{_0x2a7a66[a73_0x979c('0x21')]=null;_0x2a7a66[a73_0x979c('0x22')]();}}else{}});_0x37a189[a73_0x979c('0x11')]({'data':[]});}[a73_0x979c('0x31')](_0x2bba4e,_0x2fd56c,_0x32722a){const _0x3648e9=require('zlib');const _0x2bd9ea=_0x2bba4e[a73_0x979c('0x32')][a73_0x979c('0x33')];const _0x371da5=UPLOAD_PATH+'/'+_0x2bba4e[a73_0x979c('0x32')][a73_0x979c('0x34')]+a73_0x979c('0x35');const _0x45e3bd=fs_1[a73_0x979c('0x6')][a73_0x979c('0x36')](_0x2bd9ea);const _0x1b6f35=fs_1[a73_0x979c('0x6')][a73_0x979c('0x20')](_0x371da5);const _0x290def=_0x3648e9['createGunzip']();console[a73_0x979c('0xc')](_0x2bba4e['file']);_0x45e3bd[a73_0x979c('0x1f')](_0x290def)[a73_0x979c('0x1f')](_0x1b6f35)['on'](a73_0x979c('0x37'),_0x192467=>{if(_0x192467)return console[a73_0x979c('0x24')](_0x192467);else{const _0x2032ce=fs_1['default'][a73_0x979c('0x26')](_0x2bd9ea);const _0x2a0384=_0x2032ce[a73_0x979c('0x38')];if(_0x2a0384>0x0){fs_1[a73_0x979c('0x6')][a73_0x979c('0x29')](_0x371da5,'utf8',function(_0x192467,_0x3babbd){if(_0x192467){return console[a73_0x979c('0x24')](_0x192467);}else{try{const _0x45bb55=JSON[a73_0x979c('0x2b')](_0x3babbd);console[a73_0x979c('0xc')](_0x45bb55);const _0x1d5fcb=_0x45bb55['eventos'][0x0]['fecha'];const _0x40e456=_0x45bb55[a73_0x979c('0x39')][0x0][a73_0x979c('0x3a')];const _0x32a136=moment_1['default'](_0x1d5fcb+'\x20'+_0x40e456+'\x20-05:00',a73_0x979c('0x3b'));const _0x1b004c=parseFloat(_0x45bb55[a73_0x979c('0x39')][0x0]['latitud']['replace'](',','.'));const _0x50ff47=parseFloat(_0x45bb55[a73_0x979c('0x39')][0x0][a73_0x979c('0x3c')][a73_0x979c('0x3d')](',','.'));const _0x273300=_0x45bb55[a73_0x979c('0x39')][0x0][a73_0x979c('0x3e')];const _0x284e1e=_0x45bb55[a73_0x979c('0x39')][0x0][a73_0x979c('0x3f')][0x0][a73_0x979c('0x40')];const _0x2f7c1d=_0x45bb55[a73_0x979c('0x39')][0x0][a73_0x979c('0x3f')][0x0]['salidas'];console['log'](_0x1b004c);console[a73_0x979c('0xc')](_0x50ff47);console[a73_0x979c('0xc')](_0x273300);console[a73_0x979c('0xc')](_0x284e1e);console[a73_0x979c('0xc')](_0x2f7c1d);console[a73_0x979c('0xc')](_0x32a136);if(_0x284e1e>0x0){sequelize_utils_1[a73_0x979c('0x6')]['models'][a73_0x979c('0x30')][a73_0x979c('0x2f')]({'amount':_0x284e1e,'counted_at':_0x32a136});}sequelize_utils_1[a73_0x979c('0x6')][a73_0x979c('0x12')][a73_0x979c('0x41')][a73_0x979c('0x2f')]({'device_id':null,'lat':''+_0x1b004c,'lon':''+_0x50ff47,'tracked_at':_0x32a136});}catch(_0x51b31d){return console[a73_0x979c('0x24')](_0x51b31d);}}});}}});_0x2fd56c['json']({'status':0x1,'data':_0x2bba4e[a73_0x979c('0x32')]});}}exports[a73_0x979c('0x6')]=SyncFilesController;