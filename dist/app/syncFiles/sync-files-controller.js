var a73_0x50ab=['media/','pipe','createWriteStream','status','save','fileName','error','then','.txt','existsSync','statSync','utf8','parse','Data','Out','EndTime','passCountingsModel','create','zlib','path','.json','createReadStream','createGunzip','file','finish','eventos','hora','\x20-05:00','latitud','replace','longitud','velocidad','puerta','ingresos','salidas','locationPointsModel','__esModule','defineProperty','ftp','../../infrastructure/controller-utils','../../infrastructure/sequelize-utils','media','default','syncFtp','bind','downloadFtp','processFtp','log','connecting','connected','colombia','name','endsWith','json','size','models','syncFilesModel','findOrCreate','spread','connect','ftp.vivotek.com','ipd','findOne','connected:','file_name','colombia/','end'];(function(_0x27c9bd,_0xf28890){var _0x4e265f=function(_0x522035){while(--_0x522035){_0x27c9bd['push'](_0x27c9bd['shift']());}};_0x4e265f(++_0xf28890);}(a73_0x50ab,0x67));var a73_0x5d02=function(_0x53156f,_0x37bd79){_0x53156f=_0x53156f-0x0;var _0x88688=a73_0x50ab[_0x53156f];return _0x88688;};'use strict';var __importDefault=this&&this['__importDefault']||function(_0x44c224){return _0x44c224&&_0x44c224[a73_0x5d02('0x0')]?_0x44c224:{'default':_0x44c224};};Object[a73_0x5d02('0x1')](exports,a73_0x5d02('0x0'),{'value':!![]});const ftp_1=__importDefault(require(a73_0x5d02('0x2')));const fs_1=__importDefault(require('fs'));const controller_utils_1=__importDefault(require(a73_0x5d02('0x3')));const sequelize_utils_1=__importDefault(require(a73_0x5d02('0x4')));const moment_1=__importDefault(require('moment'));const UPLOAD_PATH=a73_0x5d02('0x5');class SyncFilesController extends controller_utils_1[a73_0x5d02('0x6')]{constructor(_0x38466c){super(_0x38466c,null);this[a73_0x5d02('0x7')]=this[a73_0x5d02('0x7')][a73_0x5d02('0x8')](this);this[a73_0x5d02('0x9')]=this['downloadFtp']['bind'](this);this['processFtp']=this[a73_0x5d02('0xa')]['bind'](this);}[a73_0x5d02('0x7')](_0x39d582,_0x3b1a09,_0x1383a7){console[a73_0x5d02('0xb')](a73_0x5d02('0xc'));const _0x2f3e1c=[];const _0x207386=new ftp_1[(a73_0x5d02('0x6'))]();_0x207386['on']('ready',function(){console[a73_0x5d02('0xb')](a73_0x5d02('0xd'));_0x207386['list'](a73_0x5d02('0xe'),![],function(_0x5cde30,_0x304f80){if(_0x5cde30){console[a73_0x5d02('0xb')](_0x5cde30);}else{for(const _0x54552b of _0x304f80){if(_0x54552b[a73_0x5d02('0xf')][a73_0x5d02('0x10')](a73_0x5d02('0x11'))&&_0x54552b[a73_0x5d02('0x12')]>0x0){sequelize_utils_1['default'][a73_0x5d02('0x13')][a73_0x5d02('0x14')][a73_0x5d02('0x15')]({'where':{'file_name':_0x54552b[a73_0x5d02('0xf')]}})[a73_0x5d02('0x16')]((_0x15a0b6,_0x5db95f)=>{if(_0x5db95f){_0x2f3e1c['push'](_0x15a0b6);}});}}}});});_0x207386['on']('error',function(_0x3d49d4){});_0x207386[a73_0x5d02('0x17')]({'host':a73_0x5d02('0x18'),'port':0x15,'user':a73_0x5d02('0x19'),'password':'ipd'});_0x3b1a09['json']({'data':[]});}[a73_0x5d02('0x9')](_0x26e0fb,_0x174392,_0x4efe16){sequelize_utils_1[a73_0x5d02('0x6')][a73_0x5d02('0x13')][a73_0x5d02('0x14')][a73_0x5d02('0x1a')]({'where':{'status':null}})['then'](_0x1fb15b=>{if(_0x1fb15b){const _0x5250ab=new ftp_1[(a73_0x5d02('0x6'))]();_0x5250ab['on']('ready',function(){console['log'](a73_0x5d02('0x1b')+_0x1fb15b[a73_0x5d02('0x1c')]);_0x5250ab['get'](a73_0x5d02('0x1d')+_0x1fb15b[a73_0x5d02('0x1c')],function(_0x32f5e2,_0x565df9){_0x5250ab[a73_0x5d02('0x1e')]();if(_0x32f5e2){}else{const _0xf2b4ca=a73_0x5d02('0x1f')+_0x1fb15b['file_name']+'.txt';_0x565df9[a73_0x5d02('0x20')](fs_1[a73_0x5d02('0x6')][a73_0x5d02('0x21')](_0xf2b4ca));_0x1fb15b[a73_0x5d02('0x22')]=0x1;_0x1fb15b[a73_0x5d02('0x23')]();console[a73_0x5d02('0xb')]('Downloaded:\x20'+_0x1fb15b[a73_0x5d02('0x24')]);}});});_0x5250ab['on'](a73_0x5d02('0x25'),function(_0x1e142d){});_0x5250ab[a73_0x5d02('0x17')]({'host':'ftp.vivotek.com','port':0x15,'user':'ipd','password':a73_0x5d02('0x19')});}else{}});_0x174392[a73_0x5d02('0x11')]({'data':[]});}[a73_0x5d02('0xa')](_0x4fb087,_0x156b36,_0x5aab6c){sequelize_utils_1['default'][a73_0x5d02('0x13')]['syncFilesModel']['findOne']({'where':{'status':0x1}})[a73_0x5d02('0x26')](_0x5810df=>{if(_0x5810df){const _0x27cfb8='media/'+_0x5810df[a73_0x5d02('0x1c')]+a73_0x5d02('0x27');if(fs_1[a73_0x5d02('0x6')][a73_0x5d02('0x28')](_0x27cfb8)){const _0x4d3e7d=fs_1[a73_0x5d02('0x6')][a73_0x5d02('0x29')](_0x27cfb8);const _0x1efa8f=_0x4d3e7d[a73_0x5d02('0x12')];console[a73_0x5d02('0xb')]('fileName:\x20'+_0x27cfb8);console[a73_0x5d02('0xb')]('fileSizeInBytes:\x20'+_0x1efa8f);if(_0x1efa8f>0x0){fs_1['default']['readFile'](_0x27cfb8,a73_0x5d02('0x2a'),function(_0x402e4c,_0x21cdb4){if(_0x402e4c){_0x5810df[a73_0x5d02('0x22')]=null;}else{try{const _0x1609fc=JSON[a73_0x5d02('0x2b')](_0x21cdb4);for(const _0x20ccc0 of _0x1609fc[a73_0x5d02('0x2c')][0x0]['CountingInfo']){const _0xd6d74d=_0x20ccc0['In'];const _0x2e672a=_0x20ccc0[a73_0x5d02('0x2d')];const _0x8f3d4b=Date['parse'](_0x20ccc0[a73_0x5d02('0x2e')]);if(_0xd6d74d>0x0){sequelize_utils_1[a73_0x5d02('0x6')][a73_0x5d02('0x13')][a73_0x5d02('0x2f')]['create']({'amount':_0xd6d74d,'counted_at':_0x8f3d4b});}if(_0x2e672a>0x0){sequelize_utils_1[a73_0x5d02('0x6')][a73_0x5d02('0x13')][a73_0x5d02('0x2f')][a73_0x5d02('0x30')]({'amount':_0x2e672a*-0x1,'counted_at':_0x8f3d4b});}}_0x5810df[a73_0x5d02('0x22')]=0x2;}catch(_0x150e27){_0x5810df[a73_0x5d02('0x22')]=null;}}_0x5810df[a73_0x5d02('0x23')]();});}else{_0x5810df[a73_0x5d02('0x22')]=null;_0x5810df['save']();}}else{_0x5810df[a73_0x5d02('0x22')]=null;_0x5810df[a73_0x5d02('0x23')]();}}else{}});_0x156b36['json']({'data':[]});}['uploadEvent'](_0x79a1c2,_0xb358bc,_0x376c71){const _0x409620=require(a73_0x5d02('0x31'));const _0x47a87e=_0x79a1c2['file'][a73_0x5d02('0x32')];const _0x55e724=UPLOAD_PATH+'/'+_0x79a1c2['file']['filename']+a73_0x5d02('0x33');const _0x575657=fs_1[a73_0x5d02('0x6')][a73_0x5d02('0x34')](_0x47a87e);const _0x51117e=fs_1[a73_0x5d02('0x6')]['createWriteStream'](_0x55e724);const _0x438380=_0x409620[a73_0x5d02('0x35')]();console['log'](_0x79a1c2[a73_0x5d02('0x36')]);_0x575657['pipe'](_0x438380)[a73_0x5d02('0x20')](_0x51117e)['on'](a73_0x5d02('0x37'),_0x16b292=>{if(_0x16b292)return console[a73_0x5d02('0x25')](_0x16b292);else{const _0x49631a=fs_1[a73_0x5d02('0x6')][a73_0x5d02('0x29')](_0x47a87e);const _0x51c557=_0x49631a[a73_0x5d02('0x12')];if(_0x51c557>0x0){fs_1[a73_0x5d02('0x6')]['readFile'](_0x55e724,'utf8',function(_0x16b292,_0x33777f){if(_0x16b292){return console[a73_0x5d02('0x25')](_0x16b292);}else{try{const _0x1d5906=JSON[a73_0x5d02('0x2b')](_0x33777f);console[a73_0x5d02('0xb')](_0x1d5906);const _0xdd1b22=_0x1d5906['eventos'][0x0]['fecha'];const _0x42c7d5=_0x1d5906[a73_0x5d02('0x38')][0x0][a73_0x5d02('0x39')];const _0xb00808=moment_1[a73_0x5d02('0x6')](_0xdd1b22+'\x20'+_0x42c7d5+a73_0x5d02('0x3a'),'YYYYMMDD\x20HHmmss\x20Z');const _0x2d49c1=parseFloat(_0x1d5906['eventos'][0x0][a73_0x5d02('0x3b')][a73_0x5d02('0x3c')](',','.'));const _0x41d719=parseFloat(_0x1d5906[a73_0x5d02('0x38')][0x0][a73_0x5d02('0x3d')]['replace'](',','.'));const _0x18918e=_0x1d5906[a73_0x5d02('0x38')][0x0][a73_0x5d02('0x3e')];const _0x358e41=_0x1d5906[a73_0x5d02('0x38')][0x0][a73_0x5d02('0x3f')][0x0][a73_0x5d02('0x40')];const _0x47d401=_0x1d5906[a73_0x5d02('0x38')][0x0][a73_0x5d02('0x3f')][0x0][a73_0x5d02('0x41')];console[a73_0x5d02('0xb')](_0x2d49c1);console[a73_0x5d02('0xb')](_0x41d719);console[a73_0x5d02('0xb')](_0x18918e);console[a73_0x5d02('0xb')](_0x358e41);console[a73_0x5d02('0xb')](_0x47d401);console[a73_0x5d02('0xb')](_0xb00808);if(_0x358e41>0x0){sequelize_utils_1[a73_0x5d02('0x6')]['models'][a73_0x5d02('0x2f')][a73_0x5d02('0x30')]({'amount':_0x358e41,'counted_at':_0xb00808});}sequelize_utils_1['default'][a73_0x5d02('0x13')][a73_0x5d02('0x42')]['create']({'device_id':null,'lat':''+_0x2d49c1,'lon':''+_0x41d719,'tracked_at':_0xb00808});}catch(_0xdcfba2){return console[a73_0x5d02('0x25')](_0xdcfba2);}}});}}});_0xb358bc[a73_0x5d02('0x11')]({'status':0x1,'data':_0x79a1c2[a73_0x5d02('0x36')]});}}exports[a73_0x5d02('0x6')]=SyncFilesController;