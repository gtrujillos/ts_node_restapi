var a72_0x5bb5=['findOne','connected:','colombia/','file_name','end','media/','.txt','pipe','createWriteStream','Downloaded:\x20','fileName','error','then','existsSync','statSync','fileSizeInBytes:\x20','readFile','utf8','status','parse','CountingInfo','EndTime','passCountingsModel','models','save','uploadEvent','file','path','createReadStream','createGunzip','finish','eventos','fecha','hora','\x20-05:00','YYYYMMDD\x20HHmmss\x20Z','replace','longitud','velocidad','puerta','ingresos','salidas','locationPointsModel','create','__importDefault','defineProperty','../../infrastructure/controller-utils','../../infrastructure/sequelize-utils','moment','media','syncFtp','bind','downloadFtp','processFtp','connecting','default','ready','log','connected','list','colombia','name','endsWith','json','size','syncFilesModel','findOrCreate','spread','push','connect','ftp.vivotek.com','ipd'];(function(_0x1c9cb8,_0x57840e){var _0x1c9338=function(_0x595c55){while(--_0x595c55){_0x1c9cb8['push'](_0x1c9cb8['shift']());}};_0x1c9338(++_0x57840e);}(a72_0x5bb5,0xbc));var a72_0x1bc5=function(_0x30a4be,_0x1b4515){_0x30a4be=_0x30a4be-0x0;var _0x3fa514=a72_0x5bb5[_0x30a4be];return _0x3fa514;};'use strict';var __importDefault=this&&this[a72_0x1bc5('0x0')]||function(_0x170144){return _0x170144&&_0x170144['__esModule']?_0x170144:{'default':_0x170144};};Object[a72_0x1bc5('0x1')](exports,'__esModule',{'value':!![]});const ftp_1=__importDefault(require('ftp'));const fs_1=__importDefault(require('fs'));const controller_utils_1=__importDefault(require(a72_0x1bc5('0x2')));const sequelize_utils_1=__importDefault(require(a72_0x1bc5('0x3')));const moment_1=__importDefault(require(a72_0x1bc5('0x4')));const UPLOAD_PATH=a72_0x1bc5('0x5');class SyncFilesController extends controller_utils_1['default']{constructor(_0xc5c6aa){super(_0xc5c6aa,null);this[a72_0x1bc5('0x6')]=this[a72_0x1bc5('0x6')][a72_0x1bc5('0x7')](this);this[a72_0x1bc5('0x8')]=this[a72_0x1bc5('0x8')][a72_0x1bc5('0x7')](this);this[a72_0x1bc5('0x9')]=this[a72_0x1bc5('0x9')][a72_0x1bc5('0x7')](this);}['syncFtp'](_0x3718c4,_0x1ccf1e,_0x37ab90){console['log'](a72_0x1bc5('0xa'));const _0x2ec3ed=[];const _0x12480e=new ftp_1[(a72_0x1bc5('0xb'))]();_0x12480e['on'](a72_0x1bc5('0xc'),function(){console[a72_0x1bc5('0xd')](a72_0x1bc5('0xe'));_0x12480e[a72_0x1bc5('0xf')](a72_0x1bc5('0x10'),![],function(_0x20da23,_0x39d272){if(_0x20da23){console[a72_0x1bc5('0xd')](_0x20da23);}else{for(const _0x37247d of _0x39d272){if(_0x37247d[a72_0x1bc5('0x11')][a72_0x1bc5('0x12')](a72_0x1bc5('0x13'))&&_0x37247d[a72_0x1bc5('0x14')]>0x0){sequelize_utils_1[a72_0x1bc5('0xb')]['models'][a72_0x1bc5('0x15')][a72_0x1bc5('0x16')]({'where':{'file_name':_0x37247d['name']}})[a72_0x1bc5('0x17')]((_0xada7d1,_0x48f49d)=>{if(_0x48f49d){_0x2ec3ed[a72_0x1bc5('0x18')](_0xada7d1);}});}}}});});_0x12480e['on']('error',function(_0x31a2f3){});_0x12480e[a72_0x1bc5('0x19')]({'host':a72_0x1bc5('0x1a'),'port':0x15,'user':a72_0x1bc5('0x1b'),'password':'ipd'});_0x1ccf1e[a72_0x1bc5('0x13')]({'data':[]});}[a72_0x1bc5('0x8')](_0x13b011,_0x3e5744,_0xdce175){sequelize_utils_1['default']['models'][a72_0x1bc5('0x15')][a72_0x1bc5('0x1c')]({'where':{'status':null}})['then'](_0x57339a=>{if(_0x57339a){const _0x1246ef=new ftp_1[(a72_0x1bc5('0xb'))]();_0x1246ef['on'](a72_0x1bc5('0xc'),function(){console[a72_0x1bc5('0xd')](a72_0x1bc5('0x1d')+_0x57339a['file_name']);_0x1246ef['get'](a72_0x1bc5('0x1e')+_0x57339a[a72_0x1bc5('0x1f')],function(_0x3dcdf1,_0x50a587){_0x1246ef[a72_0x1bc5('0x20')]();if(_0x3dcdf1){}else{const _0x4a857f=a72_0x1bc5('0x21')+_0x57339a[a72_0x1bc5('0x1f')]+a72_0x1bc5('0x22');_0x50a587[a72_0x1bc5('0x23')](fs_1[a72_0x1bc5('0xb')][a72_0x1bc5('0x24')](_0x4a857f));_0x57339a['status']=0x1;_0x57339a['save']();console[a72_0x1bc5('0xd')](a72_0x1bc5('0x25')+_0x57339a[a72_0x1bc5('0x26')]);}});});_0x1246ef['on'](a72_0x1bc5('0x27'),function(_0x3f45c8){});_0x1246ef['connect']({'host':'ftp.vivotek.com','port':0x15,'user':a72_0x1bc5('0x1b'),'password':a72_0x1bc5('0x1b')});}else{}});_0x3e5744['json']({'data':[]});}[a72_0x1bc5('0x9')](_0x20f037,_0x621691,_0x16f4a8){sequelize_utils_1['default']['models'][a72_0x1bc5('0x15')][a72_0x1bc5('0x1c')]({'where':{'status':0x1}})[a72_0x1bc5('0x28')](_0x213b71=>{if(_0x213b71){const _0xfd428a=a72_0x1bc5('0x21')+_0x213b71['file_name']+a72_0x1bc5('0x22');if(fs_1['default'][a72_0x1bc5('0x29')](_0xfd428a)){const _0x49288b=fs_1['default'][a72_0x1bc5('0x2a')](_0xfd428a);const _0x4ec25a=_0x49288b[a72_0x1bc5('0x14')];console[a72_0x1bc5('0xd')]('fileName:\x20'+_0xfd428a);console[a72_0x1bc5('0xd')](a72_0x1bc5('0x2b')+_0x4ec25a);if(_0x4ec25a>0x0){fs_1[a72_0x1bc5('0xb')][a72_0x1bc5('0x2c')](_0xfd428a,a72_0x1bc5('0x2d'),function(_0xf1dea4,_0xf19435){if(_0xf1dea4){_0x213b71[a72_0x1bc5('0x2e')]=null;}else{try{const _0x486c27=JSON[a72_0x1bc5('0x2f')](_0xf19435);for(const _0x21cb76 of _0x486c27['Data'][0x0][a72_0x1bc5('0x30')]){const _0x3dd080=_0x21cb76['In'];const _0x5415d8=_0x21cb76['Out'];const _0x3eafec=Date[a72_0x1bc5('0x2f')](_0x21cb76[a72_0x1bc5('0x31')]);if(_0x3dd080>0x0){sequelize_utils_1[a72_0x1bc5('0xb')]['models'][a72_0x1bc5('0x32')]['create']({'amount':_0x3dd080,'counted_at':_0x3eafec});}if(_0x5415d8>0x0){sequelize_utils_1[a72_0x1bc5('0xb')][a72_0x1bc5('0x33')][a72_0x1bc5('0x32')]['create']({'amount':_0x5415d8*-0x1,'counted_at':_0x3eafec});}}_0x213b71[a72_0x1bc5('0x2e')]=0x2;}catch(_0x2abbf8){_0x213b71['status']=null;}}_0x213b71[a72_0x1bc5('0x34')]();});}else{_0x213b71['status']=null;_0x213b71['save']();}}else{_0x213b71[a72_0x1bc5('0x2e')]=null;_0x213b71[a72_0x1bc5('0x34')]();}}else{}});_0x621691[a72_0x1bc5('0x13')]({'data':[]});}[a72_0x1bc5('0x35')](_0x563827,_0x3b20fa,_0x53ce32){const _0x3a21d3=require('zlib');const _0xab44bb=_0x563827[a72_0x1bc5('0x36')][a72_0x1bc5('0x37')];const _0x5e2201=UPLOAD_PATH+'/'+_0x563827['file']['filename']+'.json';const _0x944aa0=fs_1[a72_0x1bc5('0xb')][a72_0x1bc5('0x38')](_0xab44bb);const _0x512a0f=fs_1['default']['createWriteStream'](_0x5e2201);const _0x124f11=_0x3a21d3[a72_0x1bc5('0x39')]();console['log'](_0x563827['file']);_0x944aa0[a72_0x1bc5('0x23')](_0x124f11)[a72_0x1bc5('0x23')](_0x512a0f)['on'](a72_0x1bc5('0x3a'),_0x520275=>{if(_0x520275)return console['error'](_0x520275);else{const _0x414f7f=fs_1[a72_0x1bc5('0xb')]['statSync'](_0xab44bb);const _0x409dda=_0x414f7f[a72_0x1bc5('0x14')];if(_0x409dda>0x0){fs_1[a72_0x1bc5('0xb')]['readFile'](_0x5e2201,a72_0x1bc5('0x2d'),function(_0x520275,_0x919532){if(_0x520275){return console[a72_0x1bc5('0x27')](_0x520275);}else{try{const _0x41897a=JSON[a72_0x1bc5('0x2f')](_0x919532);console[a72_0x1bc5('0xd')](_0x41897a);const _0x416a4b=_0x41897a[a72_0x1bc5('0x3b')][0x0][a72_0x1bc5('0x3c')];const _0x2f969b=_0x41897a['eventos'][0x0][a72_0x1bc5('0x3d')];const _0x4dbbc2=moment_1['default'](_0x416a4b+'\x20'+_0x2f969b+a72_0x1bc5('0x3e'),a72_0x1bc5('0x3f'));const _0x268f12=parseFloat(_0x41897a['eventos'][0x0]['latitud'][a72_0x1bc5('0x40')](',','.'));const _0x35fa30=parseFloat(_0x41897a[a72_0x1bc5('0x3b')][0x0][a72_0x1bc5('0x41')][a72_0x1bc5('0x40')](',','.'));const _0x492f2b=_0x41897a['eventos'][0x0][a72_0x1bc5('0x42')];const _0x2f15b4=_0x41897a['eventos'][0x0][a72_0x1bc5('0x43')][0x0][a72_0x1bc5('0x44')];const _0x4dc804=_0x41897a[a72_0x1bc5('0x3b')][0x0][a72_0x1bc5('0x43')][0x0][a72_0x1bc5('0x45')];console[a72_0x1bc5('0xd')](_0x268f12);console[a72_0x1bc5('0xd')](_0x35fa30);console['log'](_0x492f2b);console[a72_0x1bc5('0xd')](_0x2f15b4);console['log'](_0x4dc804);console[a72_0x1bc5('0xd')](_0x4dbbc2);if(_0x2f15b4>0x0){sequelize_utils_1['default'][a72_0x1bc5('0x33')]['passCountingsModel']['create']({'amount':_0x2f15b4,'counted_at':_0x4dbbc2});}sequelize_utils_1[a72_0x1bc5('0xb')]['models'][a72_0x1bc5('0x46')][a72_0x1bc5('0x47')]({'device_id':null,'lat':''+_0x268f12,'lon':''+_0x35fa30,'tracked_at':_0x4dbbc2});}catch(_0x5a636e){return console[a72_0x1bc5('0x27')](_0x5a636e);}}});}}});_0x3b20fa[a72_0x1bc5('0x13')]({'status':0x1,'data':_0x563827[a72_0x1bc5('0x36')]});}}exports['default']=SyncFilesController;