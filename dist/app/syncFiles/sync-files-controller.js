var a162_0x3a8a=['json','models','syncFilesModel','findOrCreate','name','spread','push','error','connect','ipd','findOne','then','connected:','file_name','colombia/','media/','.txt','pipe','createWriteStream','Downloaded:\x20','existsSync','statSync','fileSizeInBytes:\x20','readFile','utf8','status','parse','Data','CountingInfo','Out','EndTime','passCountingsModel','save','uploadEvent','zlib','file','path','.json','finish','size','fecha','eventos','hora','\x20-05:00','YYYYMMDD\x20HHmmss\x20Z','latitud','replace','longitud','velocidad','ingresos','puerta','salidas','locationPointsModel','create','__importDefault','__esModule','defineProperty','ftp','../../infrastructure/sequelize-utils','moment','default','syncFtp','bind','downloadFtp','processFtp','log','connecting','ready','list','colombia','endsWith'];(function(_0x6fe452,_0x3a90ef){var _0x3134c1=function(_0x1d316e){while(--_0x1d316e){_0x6fe452['push'](_0x6fe452['shift']());}};_0x3134c1(++_0x3a90ef);}(a162_0x3a8a,0x10b));var a162_0x5c8b=function(_0x417d16,_0x4a5f0f){_0x417d16=_0x417d16-0x0;var _0x2d056f=a162_0x3a8a[_0x417d16];return _0x2d056f;};'use strict';var __importDefault=this&&this[a162_0x5c8b('0x0')]||function(_0x1a74c3){return _0x1a74c3&&_0x1a74c3[a162_0x5c8b('0x1')]?_0x1a74c3:{'default':_0x1a74c3};};Object[a162_0x5c8b('0x2')](exports,'__esModule',{'value':!![]});const ftp_1=__importDefault(require(a162_0x5c8b('0x3')));const fs_1=__importDefault(require('fs'));const controller_utils_1=__importDefault(require('../../infrastructure/controller-utils'));const sequelize_utils_1=__importDefault(require(a162_0x5c8b('0x4')));const moment_1=__importDefault(require(a162_0x5c8b('0x5')));const UPLOAD_PATH='media';class SyncFilesController extends controller_utils_1[a162_0x5c8b('0x6')]{constructor(_0x39592b){super(_0x39592b,null);this[a162_0x5c8b('0x7')]=this[a162_0x5c8b('0x7')][a162_0x5c8b('0x8')](this);this[a162_0x5c8b('0x9')]=this['downloadFtp'][a162_0x5c8b('0x8')](this);this[a162_0x5c8b('0xa')]=this['processFtp'][a162_0x5c8b('0x8')](this);}['syncFtp'](_0x5721a4,_0x233fea,_0x4edb34){console[a162_0x5c8b('0xb')](a162_0x5c8b('0xc'));const _0x748cfc=[];const _0x2bdc59=new ftp_1['default']();_0x2bdc59['on'](a162_0x5c8b('0xd'),function(){console[a162_0x5c8b('0xb')]('connected');_0x2bdc59[a162_0x5c8b('0xe')](a162_0x5c8b('0xf'),![],function(_0x21acb2,_0xea47b0){if(_0x21acb2){console[a162_0x5c8b('0xb')](_0x21acb2);}else{for(const _0x2f9d44 of _0xea47b0){if(_0x2f9d44['name'][a162_0x5c8b('0x10')](a162_0x5c8b('0x11'))&&_0x2f9d44['size']>0x0){sequelize_utils_1[a162_0x5c8b('0x6')][a162_0x5c8b('0x12')][a162_0x5c8b('0x13')][a162_0x5c8b('0x14')]({'where':{'file_name':_0x2f9d44[a162_0x5c8b('0x15')]}})[a162_0x5c8b('0x16')]((_0x159616,_0x4dd6a6)=>{if(_0x4dd6a6){_0x748cfc[a162_0x5c8b('0x17')](_0x159616);}});}}}});});_0x2bdc59['on'](a162_0x5c8b('0x18'),function(_0x1dd850){});_0x2bdc59[a162_0x5c8b('0x19')]({'host':'ftp.vivotek.com','port':0x15,'user':a162_0x5c8b('0x1a'),'password':a162_0x5c8b('0x1a')});_0x233fea[a162_0x5c8b('0x11')]({'data':[]});}['downloadFtp'](_0x441dc4,_0x4eaba4,_0x3f8e34){sequelize_utils_1[a162_0x5c8b('0x6')]['models'][a162_0x5c8b('0x13')][a162_0x5c8b('0x1b')]({'where':{'status':null}})[a162_0x5c8b('0x1c')](_0x361375=>{if(_0x361375){const _0x1ff1e9=new ftp_1[(a162_0x5c8b('0x6'))]();_0x1ff1e9['on'](a162_0x5c8b('0xd'),function(){console[a162_0x5c8b('0xb')](a162_0x5c8b('0x1d')+_0x361375[a162_0x5c8b('0x1e')]);_0x1ff1e9['get'](a162_0x5c8b('0x1f')+_0x361375[a162_0x5c8b('0x1e')],function(_0x19962c,_0x46d52d){_0x1ff1e9['end']();if(_0x19962c){}else{const _0x855458=a162_0x5c8b('0x20')+_0x361375[a162_0x5c8b('0x1e')]+a162_0x5c8b('0x21');_0x46d52d[a162_0x5c8b('0x22')](fs_1[a162_0x5c8b('0x6')][a162_0x5c8b('0x23')](_0x855458));_0x361375['status']=0x1;_0x361375['save']();console[a162_0x5c8b('0xb')](a162_0x5c8b('0x24')+_0x361375['fileName']);}});});_0x1ff1e9['on']('error',function(_0x17d969){});_0x1ff1e9[a162_0x5c8b('0x19')]({'host':'ftp.vivotek.com','port':0x15,'user':'ipd','password':a162_0x5c8b('0x1a')});}else{}});_0x4eaba4[a162_0x5c8b('0x11')]({'data':[]});}[a162_0x5c8b('0xa')](_0x78f216,_0x55c130,_0x51a989){sequelize_utils_1['default'][a162_0x5c8b('0x12')]['syncFilesModel'][a162_0x5c8b('0x1b')]({'where':{'status':0x1}})['then'](_0x290801=>{if(_0x290801){const _0x5a14d4=a162_0x5c8b('0x20')+_0x290801[a162_0x5c8b('0x1e')]+a162_0x5c8b('0x21');if(fs_1[a162_0x5c8b('0x6')][a162_0x5c8b('0x25')](_0x5a14d4)){const _0x15d19a=fs_1[a162_0x5c8b('0x6')][a162_0x5c8b('0x26')](_0x5a14d4);const _0x244474=_0x15d19a['size'];console[a162_0x5c8b('0xb')]('fileName:\x20'+_0x5a14d4);console[a162_0x5c8b('0xb')](a162_0x5c8b('0x27')+_0x244474);if(_0x244474>0x0){fs_1[a162_0x5c8b('0x6')][a162_0x5c8b('0x28')](_0x5a14d4,a162_0x5c8b('0x29'),function(_0x4f2c06,_0x326824){if(_0x4f2c06){_0x290801[a162_0x5c8b('0x2a')]=null;}else{try{const _0x35cf43=JSON[a162_0x5c8b('0x2b')](_0x326824);for(const _0x5b6820 of _0x35cf43[a162_0x5c8b('0x2c')][0x0][a162_0x5c8b('0x2d')]){const _0x1cf27e=_0x5b6820['In'];const _0x4b4401=_0x5b6820[a162_0x5c8b('0x2e')];const _0x26dd09=Date[a162_0x5c8b('0x2b')](_0x5b6820[a162_0x5c8b('0x2f')]);if(_0x1cf27e>0x0){sequelize_utils_1[a162_0x5c8b('0x6')][a162_0x5c8b('0x12')][a162_0x5c8b('0x30')]['create']({'amount':_0x1cf27e,'counted_at':_0x26dd09});}if(_0x4b4401>0x0){sequelize_utils_1['default'][a162_0x5c8b('0x12')][a162_0x5c8b('0x30')]['create']({'amount':_0x4b4401*-0x1,'counted_at':_0x26dd09});}}_0x290801[a162_0x5c8b('0x2a')]=0x2;}catch(_0x230939){_0x290801[a162_0x5c8b('0x2a')]=null;}}_0x290801[a162_0x5c8b('0x31')]();});}else{_0x290801[a162_0x5c8b('0x2a')]=null;_0x290801[a162_0x5c8b('0x31')]();}}else{_0x290801[a162_0x5c8b('0x2a')]=null;_0x290801[a162_0x5c8b('0x31')]();}}else{}});_0x55c130['json']({'data':[]});}[a162_0x5c8b('0x32')](_0x2e593e,_0x1c5af3,_0xf6149d){const _0x2213ec=require(a162_0x5c8b('0x33'));const _0x507c08=_0x2e593e[a162_0x5c8b('0x34')][a162_0x5c8b('0x35')];const _0x22492d=UPLOAD_PATH+'/'+_0x2e593e[a162_0x5c8b('0x34')]['filename']+a162_0x5c8b('0x36');const _0x260fd6=fs_1[a162_0x5c8b('0x6')]['createReadStream'](_0x507c08);const _0x2c5014=fs_1[a162_0x5c8b('0x6')][a162_0x5c8b('0x23')](_0x22492d);const _0x156638=_0x2213ec['createGunzip']();console['log'](_0x2e593e[a162_0x5c8b('0x34')]);_0x260fd6[a162_0x5c8b('0x22')](_0x156638)[a162_0x5c8b('0x22')](_0x2c5014)['on'](a162_0x5c8b('0x37'),_0x236c1e=>{if(_0x236c1e)return console[a162_0x5c8b('0x18')](_0x236c1e);else{const _0x13e50c=fs_1[a162_0x5c8b('0x6')][a162_0x5c8b('0x26')](_0x507c08);const _0x52cacd=_0x13e50c[a162_0x5c8b('0x38')];if(_0x52cacd>0x0){fs_1[a162_0x5c8b('0x6')][a162_0x5c8b('0x28')](_0x22492d,a162_0x5c8b('0x29'),function(_0x236c1e,_0x33e4a6){if(_0x236c1e){return console[a162_0x5c8b('0x18')](_0x236c1e);}else{try{const _0x40a2f5=JSON[a162_0x5c8b('0x2b')](_0x33e4a6);console[a162_0x5c8b('0xb')](_0x40a2f5);const _0x14731f=_0x40a2f5['eventos'][0x0][a162_0x5c8b('0x39')];const _0x320276=_0x40a2f5[a162_0x5c8b('0x3a')][0x0][a162_0x5c8b('0x3b')];const _0x3adb37=moment_1['default'](_0x14731f+'\x20'+_0x320276+a162_0x5c8b('0x3c'),a162_0x5c8b('0x3d'));const _0x4a4a32=parseFloat(_0x40a2f5['eventos'][0x0][a162_0x5c8b('0x3e')][a162_0x5c8b('0x3f')](',','.'));const _0x4279b9=parseFloat(_0x40a2f5['eventos'][0x0][a162_0x5c8b('0x40')][a162_0x5c8b('0x3f')](',','.'));const _0x379422=_0x40a2f5[a162_0x5c8b('0x3a')][0x0][a162_0x5c8b('0x41')];const _0x222c79=_0x40a2f5[a162_0x5c8b('0x3a')][0x0]['puerta'][0x0][a162_0x5c8b('0x42')];const _0x4cc69d=_0x40a2f5[a162_0x5c8b('0x3a')][0x0][a162_0x5c8b('0x43')][0x0][a162_0x5c8b('0x44')];console[a162_0x5c8b('0xb')](_0x4a4a32);console[a162_0x5c8b('0xb')](_0x4279b9);console[a162_0x5c8b('0xb')](_0x379422);console[a162_0x5c8b('0xb')](_0x222c79);console['log'](_0x4cc69d);console['log'](_0x3adb37);if(_0x222c79>0x0){sequelize_utils_1[a162_0x5c8b('0x6')]['models'][a162_0x5c8b('0x30')]['create']({'amount':_0x222c79,'counted_at':_0x3adb37});}sequelize_utils_1[a162_0x5c8b('0x6')][a162_0x5c8b('0x12')][a162_0x5c8b('0x45')][a162_0x5c8b('0x46')]({'device_id':null,'lat':''+_0x4a4a32,'lon':''+_0x4279b9,'tracked_at':_0x3adb37});}catch(_0x2d50bf){return console[a162_0x5c8b('0x18')](_0x2d50bf);}}});}}});_0x1c5af3[a162_0x5c8b('0x11')]({'status':0x1,'data':_0x2e593e[a162_0x5c8b('0x34')]});}}exports[a162_0x5c8b('0x6')]=SyncFilesController;