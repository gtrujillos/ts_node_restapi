var a162_0x47e4=['syncFtp','bind','downloadFtp','log','connected','list','name','endsWith','size','models','syncFilesModel','findOrCreate','spread','push','error','connect','ipd','json','then','ready','connected:','file_name','get','colombia/','end','media/','pipe','status','fileName','ftp.vivotek.com','processFtp','.txt','fileName:\x20','fileSizeInBytes:\x20','readFile','parse','Data','CountingInfo','Out','create','passCountingsModel','save','file','path','.json','createReadStream','createWriteStream','createGunzip','finish','statSync','eventos','fecha','hora','\x20-05:00','YYYYMMDD\x20HHmmss\x20Z','latitud','longitud','replace','puerta','ingresos','locationPointsModel','__importDefault','__esModule','defineProperty','../../infrastructure/controller-utils','../../infrastructure/sequelize-utils','media','default'];(function(_0x47d55d,_0x1007b4){var _0x49b3cc=function(_0x32ec7c){while(--_0x32ec7c){_0x47d55d['push'](_0x47d55d['shift']());}};_0x49b3cc(++_0x1007b4);}(a162_0x47e4,0x1d5));var a162_0x56b3=function(_0x2b2d63,_0x1082fc){_0x2b2d63=_0x2b2d63-0x0;var _0x790547=a162_0x47e4[_0x2b2d63];return _0x790547;};'use strict';var __importDefault=this&&this[a162_0x56b3('0x0')]||function(_0x1ffa01){return _0x1ffa01&&_0x1ffa01[a162_0x56b3('0x1')]?_0x1ffa01:{'default':_0x1ffa01};};Object[a162_0x56b3('0x2')](exports,'__esModule',{'value':!![]});const ftp_1=__importDefault(require('ftp'));const fs_1=__importDefault(require('fs'));const controller_utils_1=__importDefault(require(a162_0x56b3('0x3')));const sequelize_utils_1=__importDefault(require(a162_0x56b3('0x4')));const moment_1=__importDefault(require('moment'));const UPLOAD_PATH=a162_0x56b3('0x5');class SyncFilesController extends controller_utils_1[a162_0x56b3('0x6')]{constructor(_0x2e2443){super(_0x2e2443,null);this[a162_0x56b3('0x7')]=this[a162_0x56b3('0x7')][a162_0x56b3('0x8')](this);this['downloadFtp']=this[a162_0x56b3('0x9')][a162_0x56b3('0x8')](this);this['processFtp']=this['processFtp'][a162_0x56b3('0x8')](this);}[a162_0x56b3('0x7')](_0x3d1124,_0x21f2a5,_0x49e60d){console[a162_0x56b3('0xa')]('connecting');const _0x51aaa0=[];const _0x73d6e7=new ftp_1['default']();_0x73d6e7['on']('ready',function(){console['log'](a162_0x56b3('0xb'));_0x73d6e7[a162_0x56b3('0xc')]('colombia',![],function(_0x2cede3,_0x405751){if(_0x2cede3){console['log'](_0x2cede3);}else{for(const _0x2617fc of _0x405751){if(_0x2617fc[a162_0x56b3('0xd')][a162_0x56b3('0xe')]('json')&&_0x2617fc[a162_0x56b3('0xf')]>0x0){sequelize_utils_1[a162_0x56b3('0x6')][a162_0x56b3('0x10')][a162_0x56b3('0x11')][a162_0x56b3('0x12')]({'where':{'file_name':_0x2617fc['name']}})[a162_0x56b3('0x13')]((_0x929c6d,_0x4ae417)=>{if(_0x4ae417){_0x51aaa0[a162_0x56b3('0x14')](_0x929c6d);}});}}}});});_0x73d6e7['on'](a162_0x56b3('0x15'),function(_0x18bfb7){});_0x73d6e7[a162_0x56b3('0x16')]({'host':'ftp.vivotek.com','port':0x15,'user':'ipd','password':a162_0x56b3('0x17')});_0x21f2a5[a162_0x56b3('0x18')]({'data':[]});}[a162_0x56b3('0x9')](_0x4f3bbd,_0x386e43,_0x2a869d){sequelize_utils_1['default'][a162_0x56b3('0x10')][a162_0x56b3('0x11')]['findOne']({'where':{'status':null}})[a162_0x56b3('0x19')](_0x2c60b8=>{if(_0x2c60b8){const _0x53787c=new ftp_1[(a162_0x56b3('0x6'))]();_0x53787c['on'](a162_0x56b3('0x1a'),function(){console['log'](a162_0x56b3('0x1b')+_0x2c60b8[a162_0x56b3('0x1c')]);_0x53787c[a162_0x56b3('0x1d')](a162_0x56b3('0x1e')+_0x2c60b8[a162_0x56b3('0x1c')],function(_0x3ea7a5,_0x48284f){_0x53787c[a162_0x56b3('0x1f')]();if(_0x3ea7a5){}else{const _0x4f99dc=a162_0x56b3('0x20')+_0x2c60b8[a162_0x56b3('0x1c')]+'.txt';_0x48284f[a162_0x56b3('0x21')](fs_1['default']['createWriteStream'](_0x4f99dc));_0x2c60b8[a162_0x56b3('0x22')]=0x1;_0x2c60b8['save']();console[a162_0x56b3('0xa')]('Downloaded:\x20'+_0x2c60b8[a162_0x56b3('0x23')]);}});});_0x53787c['on'](a162_0x56b3('0x15'),function(_0x158170){});_0x53787c[a162_0x56b3('0x16')]({'host':a162_0x56b3('0x24'),'port':0x15,'user':a162_0x56b3('0x17'),'password':a162_0x56b3('0x17')});}else{}});_0x386e43[a162_0x56b3('0x18')]({'data':[]});}[a162_0x56b3('0x25')](_0x1c5a00,_0x5c91f1,_0x5379f6){sequelize_utils_1['default'][a162_0x56b3('0x10')][a162_0x56b3('0x11')]['findOne']({'where':{'status':0x1}})['then'](_0x405550=>{if(_0x405550){const _0x6a8072=a162_0x56b3('0x20')+_0x405550[a162_0x56b3('0x1c')]+a162_0x56b3('0x26');if(fs_1[a162_0x56b3('0x6')]['existsSync'](_0x6a8072)){const _0x3bc604=fs_1['default']['statSync'](_0x6a8072);const _0x4ddabe=_0x3bc604['size'];console[a162_0x56b3('0xa')](a162_0x56b3('0x27')+_0x6a8072);console['log'](a162_0x56b3('0x28')+_0x4ddabe);if(_0x4ddabe>0x0){fs_1[a162_0x56b3('0x6')][a162_0x56b3('0x29')](_0x6a8072,'utf8',function(_0x48fa5b,_0x4203b7){if(_0x48fa5b){_0x405550[a162_0x56b3('0x22')]=null;}else{try{const _0x19de6d=JSON[a162_0x56b3('0x2a')](_0x4203b7);for(const _0xdb46c9 of _0x19de6d[a162_0x56b3('0x2b')][0x0][a162_0x56b3('0x2c')]){const _0x349247=_0xdb46c9['In'];const _0x1472fd=_0xdb46c9[a162_0x56b3('0x2d')];const _0x4c83a3=Date[a162_0x56b3('0x2a')](_0xdb46c9['EndTime']);if(_0x349247>0x0){sequelize_utils_1[a162_0x56b3('0x6')][a162_0x56b3('0x10')]['passCountingsModel'][a162_0x56b3('0x2e')]({'amount':_0x349247,'counted_at':_0x4c83a3});}if(_0x1472fd>0x0){sequelize_utils_1['default'][a162_0x56b3('0x10')][a162_0x56b3('0x2f')][a162_0x56b3('0x2e')]({'amount':_0x1472fd*-0x1,'counted_at':_0x4c83a3});}}_0x405550[a162_0x56b3('0x22')]=0x2;}catch(_0x149000){_0x405550['status']=null;}}_0x405550[a162_0x56b3('0x30')]();});}else{_0x405550['status']=null;_0x405550[a162_0x56b3('0x30')]();}}else{_0x405550['status']=null;_0x405550[a162_0x56b3('0x30')]();}}else{}});_0x5c91f1['json']({'data':[]});}['uploadEvent'](_0x2901a5,_0x40c944,_0x1718d1){const _0x39b51e=require('zlib');const _0x47236a=_0x2901a5[a162_0x56b3('0x31')][a162_0x56b3('0x32')];const _0x3d3b28=UPLOAD_PATH+'/'+_0x2901a5[a162_0x56b3('0x31')]['filename']+a162_0x56b3('0x33');const _0x3f499c=fs_1[a162_0x56b3('0x6')][a162_0x56b3('0x34')](_0x47236a);const _0x573912=fs_1[a162_0x56b3('0x6')][a162_0x56b3('0x35')](_0x3d3b28);const _0x54f489=_0x39b51e[a162_0x56b3('0x36')]();console['log'](_0x2901a5[a162_0x56b3('0x31')]);_0x3f499c['pipe'](_0x54f489)[a162_0x56b3('0x21')](_0x573912)['on'](a162_0x56b3('0x37'),_0x31a0ae=>{if(_0x31a0ae)return console[a162_0x56b3('0x15')](_0x31a0ae);else{const _0x4b02a0=fs_1[a162_0x56b3('0x6')][a162_0x56b3('0x38')](_0x47236a);const _0x4001b9=_0x4b02a0['size'];if(_0x4001b9>0x0){fs_1['default']['readFile'](_0x3d3b28,'utf8',function(_0x31a0ae,_0x1b6ac0){if(_0x31a0ae){return console['error'](_0x31a0ae);}else{try{const _0x2227d9=JSON[a162_0x56b3('0x2a')](_0x1b6ac0);console[a162_0x56b3('0xa')](_0x2227d9);const _0x4c6f03=_0x2227d9[a162_0x56b3('0x39')][0x0][a162_0x56b3('0x3a')];const _0x539257=_0x2227d9['eventos'][0x0][a162_0x56b3('0x3b')];const _0x1293e2=moment_1[a162_0x56b3('0x6')](_0x4c6f03+'\x20'+_0x539257+a162_0x56b3('0x3c'),a162_0x56b3('0x3d'));const _0x3bd58b=parseFloat(_0x2227d9[a162_0x56b3('0x39')][0x0][a162_0x56b3('0x3e')]['replace'](',','.'));const _0x92dfe9=parseFloat(_0x2227d9['eventos'][0x0][a162_0x56b3('0x3f')][a162_0x56b3('0x40')](',','.'));const _0x75b5f6=_0x2227d9[a162_0x56b3('0x39')][0x0]['velocidad'];const _0x15692c=_0x2227d9[a162_0x56b3('0x39')][0x0][a162_0x56b3('0x41')][0x0][a162_0x56b3('0x42')];const _0x6993f4=_0x2227d9[a162_0x56b3('0x39')][0x0]['puerta'][0x0]['salidas'];console[a162_0x56b3('0xa')](_0x3bd58b);console[a162_0x56b3('0xa')](_0x92dfe9);console[a162_0x56b3('0xa')](_0x75b5f6);console[a162_0x56b3('0xa')](_0x15692c);console['log'](_0x6993f4);console[a162_0x56b3('0xa')](_0x1293e2);if(_0x15692c>0x0){sequelize_utils_1[a162_0x56b3('0x6')][a162_0x56b3('0x10')][a162_0x56b3('0x2f')][a162_0x56b3('0x2e')]({'amount':_0x15692c,'counted_at':_0x1293e2});}sequelize_utils_1[a162_0x56b3('0x6')][a162_0x56b3('0x10')][a162_0x56b3('0x43')]['create']({'device_id':null,'lat':''+_0x3bd58b,'lon':''+_0x92dfe9,'tracked_at':_0x1293e2});}catch(_0x420c62){return console['error'](_0x420c62);}}});}}});_0x40c944[a162_0x56b3('0x18')]({'status':0x1,'data':_0x2901a5['file']});}}exports[a162_0x56b3('0x6')]=SyncFilesController;