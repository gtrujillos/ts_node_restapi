var a162_0x5b45=['fileSizeInBytes:\x20','readFile','utf8','status','Data','parse','passCountingsModel','create','zlib','filename','.json','createReadStream','createGunzip','file','finish','eventos','\x20-05:00','YYYYMMDD\x20HHmmss\x20Z','latitud','replace','puerta','ingresos','__importDefault','__esModule','defineProperty','ftp','moment','media','syncFtp','downloadFtp','bind','processFtp','log','connecting','connected','list','colombia','name','json','size','default','models','syncFilesModel','spread','push','error','findOne','ready','connected:','file_name','get','colombia/','end','media/','.txt','pipe','createWriteStream','save','Downloaded:\x20','fileName','connect','ftp.vivotek.com','ipd','existsSync','statSync'];(function(_0x2a5c6d,_0x38f4c9){var _0x5a30c5=function(_0x23f2a5){while(--_0x23f2a5){_0x2a5c6d['push'](_0x2a5c6d['shift']());}};_0x5a30c5(++_0x38f4c9);}(a162_0x5b45,0x15b));var a162_0x4aac=function(_0x4760d5,_0x42c4c7){_0x4760d5=_0x4760d5-0x0;var _0x4538f5=a162_0x5b45[_0x4760d5];return _0x4538f5;};'use strict';var __importDefault=this&&this[a162_0x4aac('0x0')]||function(_0xdb6d75){return _0xdb6d75&&_0xdb6d75[a162_0x4aac('0x1')]?_0xdb6d75:{'default':_0xdb6d75};};Object[a162_0x4aac('0x2')](exports,a162_0x4aac('0x1'),{'value':!![]});const ftp_1=__importDefault(require(a162_0x4aac('0x3')));const fs_1=__importDefault(require('fs'));const controller_utils_1=__importDefault(require('../../infrastructure/controller-utils'));const sequelize_utils_1=__importDefault(require('../../infrastructure/sequelize-utils'));const moment_1=__importDefault(require(a162_0x4aac('0x4')));const UPLOAD_PATH=a162_0x4aac('0x5');class SyncFilesController extends controller_utils_1['default']{constructor(_0x4dc8f3){super(_0x4dc8f3,null);this[a162_0x4aac('0x6')]=this[a162_0x4aac('0x6')]['bind'](this);this[a162_0x4aac('0x7')]=this[a162_0x4aac('0x7')][a162_0x4aac('0x8')](this);this[a162_0x4aac('0x9')]=this['processFtp'][a162_0x4aac('0x8')](this);}[a162_0x4aac('0x6')](_0x435cd5,_0x39284e,_0x320df6){console[a162_0x4aac('0xa')](a162_0x4aac('0xb'));const _0x1ddf66=[];const _0x529755=new ftp_1['default']();_0x529755['on']('ready',function(){console[a162_0x4aac('0xa')](a162_0x4aac('0xc'));_0x529755[a162_0x4aac('0xd')](a162_0x4aac('0xe'),![],function(_0xdc1447,_0x1ad3c9){if(_0xdc1447){console[a162_0x4aac('0xa')](_0xdc1447);}else{for(const _0x1a4936 of _0x1ad3c9){if(_0x1a4936[a162_0x4aac('0xf')]['endsWith'](a162_0x4aac('0x10'))&&_0x1a4936[a162_0x4aac('0x11')]>0x0){sequelize_utils_1[a162_0x4aac('0x12')][a162_0x4aac('0x13')][a162_0x4aac('0x14')]['findOrCreate']({'where':{'file_name':_0x1a4936['name']}})[a162_0x4aac('0x15')]((_0x24119e,_0x31e9d5)=>{if(_0x31e9d5){_0x1ddf66[a162_0x4aac('0x16')](_0x24119e);}});}}}});});_0x529755['on'](a162_0x4aac('0x17'),function(_0x7a4648){});_0x529755['connect']({'host':'ftp.vivotek.com','port':0x15,'user':'ipd','password':'ipd'});_0x39284e[a162_0x4aac('0x10')]({'data':[]});}[a162_0x4aac('0x7')](_0x463020,_0x4d4d37,_0x4d1268){sequelize_utils_1[a162_0x4aac('0x12')][a162_0x4aac('0x13')][a162_0x4aac('0x14')][a162_0x4aac('0x18')]({'where':{'status':null}})['then'](_0x53fb98=>{if(_0x53fb98){const _0x4366b3=new ftp_1[(a162_0x4aac('0x12'))]();_0x4366b3['on'](a162_0x4aac('0x19'),function(){console[a162_0x4aac('0xa')](a162_0x4aac('0x1a')+_0x53fb98[a162_0x4aac('0x1b')]);_0x4366b3[a162_0x4aac('0x1c')](a162_0x4aac('0x1d')+_0x53fb98[a162_0x4aac('0x1b')],function(_0x4a2360,_0x64e342){_0x4366b3[a162_0x4aac('0x1e')]();if(_0x4a2360){}else{const _0x3f905d=a162_0x4aac('0x1f')+_0x53fb98[a162_0x4aac('0x1b')]+a162_0x4aac('0x20');_0x64e342[a162_0x4aac('0x21')](fs_1[a162_0x4aac('0x12')][a162_0x4aac('0x22')](_0x3f905d));_0x53fb98['status']=0x1;_0x53fb98[a162_0x4aac('0x23')]();console['log'](a162_0x4aac('0x24')+_0x53fb98[a162_0x4aac('0x25')]);}});});_0x4366b3['on']('error',function(_0x2dbe8e){});_0x4366b3[a162_0x4aac('0x26')]({'host':a162_0x4aac('0x27'),'port':0x15,'user':a162_0x4aac('0x28'),'password':a162_0x4aac('0x28')});}else{}});_0x4d4d37['json']({'data':[]});}[a162_0x4aac('0x9')](_0x381314,_0x590736,_0x32dc6d){sequelize_utils_1[a162_0x4aac('0x12')]['models'][a162_0x4aac('0x14')][a162_0x4aac('0x18')]({'where':{'status':0x1}})['then'](_0x3963db=>{if(_0x3963db){const _0x20fbb1=a162_0x4aac('0x1f')+_0x3963db[a162_0x4aac('0x1b')]+a162_0x4aac('0x20');if(fs_1['default'][a162_0x4aac('0x29')](_0x20fbb1)){const _0x22ca74=fs_1[a162_0x4aac('0x12')][a162_0x4aac('0x2a')](_0x20fbb1);const _0x25e1af=_0x22ca74['size'];console['log']('fileName:\x20'+_0x20fbb1);console[a162_0x4aac('0xa')](a162_0x4aac('0x2b')+_0x25e1af);if(_0x25e1af>0x0){fs_1['default'][a162_0x4aac('0x2c')](_0x20fbb1,a162_0x4aac('0x2d'),function(_0x655262,_0x3208bf){if(_0x655262){_0x3963db[a162_0x4aac('0x2e')]=null;}else{try{const _0x175a72=JSON['parse'](_0x3208bf);for(const _0x88cf1d of _0x175a72[a162_0x4aac('0x2f')][0x0]['CountingInfo']){const _0xad14f1=_0x88cf1d['In'];const _0x754bfd=_0x88cf1d['Out'];const _0x10cc4c=Date[a162_0x4aac('0x30')](_0x88cf1d['EndTime']);if(_0xad14f1>0x0){sequelize_utils_1[a162_0x4aac('0x12')]['models'][a162_0x4aac('0x31')][a162_0x4aac('0x32')]({'amount':_0xad14f1,'counted_at':_0x10cc4c});}if(_0x754bfd>0x0){sequelize_utils_1[a162_0x4aac('0x12')][a162_0x4aac('0x13')]['passCountingsModel'][a162_0x4aac('0x32')]({'amount':_0x754bfd*-0x1,'counted_at':_0x10cc4c});}}_0x3963db[a162_0x4aac('0x2e')]=0x2;}catch(_0x3c64c7){_0x3963db[a162_0x4aac('0x2e')]=null;}}_0x3963db['save']();});}else{_0x3963db[a162_0x4aac('0x2e')]=null;_0x3963db[a162_0x4aac('0x23')]();}}else{_0x3963db['status']=null;_0x3963db[a162_0x4aac('0x23')]();}}else{}});_0x590736[a162_0x4aac('0x10')]({'data':[]});}['uploadEvent'](_0x235a63,_0x2ef10b,_0x283bc6){const _0x1e54b5=require(a162_0x4aac('0x33'));const _0x49f0af=_0x235a63['file']['path'];const _0xf2aa32=UPLOAD_PATH+'/'+_0x235a63['file'][a162_0x4aac('0x34')]+a162_0x4aac('0x35');const _0x16e71b=fs_1[a162_0x4aac('0x12')][a162_0x4aac('0x36')](_0x49f0af);const _0x6606be=fs_1['default'][a162_0x4aac('0x22')](_0xf2aa32);const _0x598064=_0x1e54b5[a162_0x4aac('0x37')]();console[a162_0x4aac('0xa')](_0x235a63[a162_0x4aac('0x38')]);_0x16e71b['pipe'](_0x598064)['pipe'](_0x6606be)['on'](a162_0x4aac('0x39'),_0x2b970d=>{if(_0x2b970d)return console[a162_0x4aac('0x17')](_0x2b970d);else{const _0x58319b=fs_1[a162_0x4aac('0x12')][a162_0x4aac('0x2a')](_0x49f0af);const _0x59070f=_0x58319b[a162_0x4aac('0x11')];if(_0x59070f>0x0){fs_1[a162_0x4aac('0x12')][a162_0x4aac('0x2c')](_0xf2aa32,'utf8',function(_0x2b970d,_0x48f68c){if(_0x2b970d){return console[a162_0x4aac('0x17')](_0x2b970d);}else{try{const _0x28cede=JSON['parse'](_0x48f68c);console[a162_0x4aac('0xa')](_0x28cede);const _0x4aec71=_0x28cede[a162_0x4aac('0x3a')][0x0]['fecha'];const _0x2e78eb=_0x28cede[a162_0x4aac('0x3a')][0x0]['hora'];const _0x1a97c6=moment_1[a162_0x4aac('0x12')](_0x4aec71+'\x20'+_0x2e78eb+a162_0x4aac('0x3b'),a162_0x4aac('0x3c'));const _0x351379=parseFloat(_0x28cede[a162_0x4aac('0x3a')][0x0][a162_0x4aac('0x3d')]['replace'](',','.'));const _0x39a7af=parseFloat(_0x28cede['eventos'][0x0]['longitud'][a162_0x4aac('0x3e')](',','.'));const _0x5e01f1=_0x28cede[a162_0x4aac('0x3a')][0x0]['velocidad'];const _0x5de5f1=_0x28cede[a162_0x4aac('0x3a')][0x0][a162_0x4aac('0x3f')][0x0][a162_0x4aac('0x40')];const _0x3c0012=_0x28cede['eventos'][0x0][a162_0x4aac('0x3f')][0x0]['salidas'];console[a162_0x4aac('0xa')](_0x351379);console[a162_0x4aac('0xa')](_0x39a7af);console[a162_0x4aac('0xa')](_0x5e01f1);console[a162_0x4aac('0xa')](_0x5de5f1);console[a162_0x4aac('0xa')](_0x3c0012);console[a162_0x4aac('0xa')](_0x1a97c6);if(_0x5de5f1>0x0){sequelize_utils_1[a162_0x4aac('0x12')]['models'][a162_0x4aac('0x31')][a162_0x4aac('0x32')]({'amount':_0x5de5f1,'counted_at':_0x1a97c6});}sequelize_utils_1[a162_0x4aac('0x12')][a162_0x4aac('0x13')]['locationPointsModel'][a162_0x4aac('0x32')]({'device_id':null,'lat':''+_0x351379,'lon':''+_0x39a7af,'tracked_at':_0x1a97c6});}catch(_0x38e4fe){return console[a162_0x4aac('0x17')](_0x38e4fe);}}});}}});_0x2ef10b[a162_0x4aac('0x10')]({'status':0x1,'data':_0x235a63[a162_0x4aac('0x38')]});}}exports[a162_0x4aac('0x12')]=SyncFilesController;