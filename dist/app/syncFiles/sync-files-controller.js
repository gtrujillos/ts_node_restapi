var a73_0x407e=['default','ready','connected','colombia','name','endsWith','size','models','findOrCreate','push','ftp.vivotek.com','ipd','findOne','then','file_name','get','colombia/','end','createWriteStream','status','save','fileName','error','syncFilesModel','.txt','statSync','fileName:\x20','utf8','parse','Data','CountingInfo','Out','passCountingsModel','create','uploadEvent','file','path','createReadStream','createGunzip','pipe','eventos','fecha','hora','YYYYMMDD\x20HHmmss\x20Z','latitud','longitud','replace','velocidad','puerta','ingresos','salidas','locationPointsModel','json','__importDefault','__esModule','defineProperty','ftp','../../infrastructure/controller-utils','media','syncFtp','bind','downloadFtp','processFtp','log','connecting'];(function(_0x5c05ca,_0x22a3b4){var _0x42a5ae=function(_0x5c5980){while(--_0x5c5980){_0x5c05ca['push'](_0x5c05ca['shift']());}};_0x42a5ae(++_0x22a3b4);}(a73_0x407e,0xb7));var a73_0x53f2=function(_0x4d5239,_0xe3ae0){_0x4d5239=_0x4d5239-0x0;var _0x58e8a4=a73_0x407e[_0x4d5239];return _0x58e8a4;};'use strict';var __importDefault=this&&this[a73_0x53f2('0x0')]||function(_0x2164ee){return _0x2164ee&&_0x2164ee[a73_0x53f2('0x1')]?_0x2164ee:{'default':_0x2164ee};};Object[a73_0x53f2('0x2')](exports,a73_0x53f2('0x1'),{'value':!![]});const ftp_1=__importDefault(require(a73_0x53f2('0x3')));const fs_1=__importDefault(require('fs'));const controller_utils_1=__importDefault(require(a73_0x53f2('0x4')));const sequelize_utils_1=__importDefault(require('../../infrastructure/sequelize-utils'));const moment_1=__importDefault(require('moment'));const UPLOAD_PATH=a73_0x53f2('0x5');class SyncFilesController extends controller_utils_1['default']{constructor(_0x33e2fd){super(_0x33e2fd,null);this['syncFtp']=this[a73_0x53f2('0x6')][a73_0x53f2('0x7')](this);this[a73_0x53f2('0x8')]=this[a73_0x53f2('0x8')]['bind'](this);this['processFtp']=this[a73_0x53f2('0x9')][a73_0x53f2('0x7')](this);}[a73_0x53f2('0x6')](_0x361915,_0x10c0da,_0x119484){console[a73_0x53f2('0xa')](a73_0x53f2('0xb'));const _0x3d9630=[];const _0x52b691=new ftp_1[(a73_0x53f2('0xc'))]();_0x52b691['on'](a73_0x53f2('0xd'),function(){console[a73_0x53f2('0xa')](a73_0x53f2('0xe'));_0x52b691['list'](a73_0x53f2('0xf'),![],function(_0xbbc582,_0x2c1bbd){if(_0xbbc582){console[a73_0x53f2('0xa')](_0xbbc582);}else{for(const _0x5895e6 of _0x2c1bbd){if(_0x5895e6[a73_0x53f2('0x10')][a73_0x53f2('0x11')]('json')&&_0x5895e6[a73_0x53f2('0x12')]>0x0){sequelize_utils_1['default'][a73_0x53f2('0x13')]['syncFilesModel'][a73_0x53f2('0x14')]({'where':{'file_name':_0x5895e6['name']}})['spread']((_0x3ba870,_0x4e0ac8)=>{if(_0x4e0ac8){_0x3d9630[a73_0x53f2('0x15')](_0x3ba870);}});}}}});});_0x52b691['on']('error',function(_0x1530fa){});_0x52b691['connect']({'host':a73_0x53f2('0x16'),'port':0x15,'user':a73_0x53f2('0x17'),'password':'ipd'});_0x10c0da['json']({'data':[]});}[a73_0x53f2('0x8')](_0x3cbb44,_0x1e9e9c,_0xf0c1ca){sequelize_utils_1[a73_0x53f2('0xc')][a73_0x53f2('0x13')]['syncFilesModel'][a73_0x53f2('0x18')]({'where':{'status':null}})[a73_0x53f2('0x19')](_0x210ef8=>{if(_0x210ef8){const _0x32c7e5=new ftp_1[(a73_0x53f2('0xc'))]();_0x32c7e5['on'](a73_0x53f2('0xd'),function(){console[a73_0x53f2('0xa')]('connected:'+_0x210ef8[a73_0x53f2('0x1a')]);_0x32c7e5[a73_0x53f2('0x1b')](a73_0x53f2('0x1c')+_0x210ef8['file_name'],function(_0x258abf,_0x221161){_0x32c7e5[a73_0x53f2('0x1d')]();if(_0x258abf){}else{const _0x5984b0='media/'+_0x210ef8['file_name']+'.txt';_0x221161['pipe'](fs_1[a73_0x53f2('0xc')][a73_0x53f2('0x1e')](_0x5984b0));_0x210ef8[a73_0x53f2('0x1f')]=0x1;_0x210ef8[a73_0x53f2('0x20')]();console[a73_0x53f2('0xa')]('Downloaded:\x20'+_0x210ef8[a73_0x53f2('0x21')]);}});});_0x32c7e5['on'](a73_0x53f2('0x22'),function(_0x54d6bd){});_0x32c7e5['connect']({'host':a73_0x53f2('0x16'),'port':0x15,'user':a73_0x53f2('0x17'),'password':a73_0x53f2('0x17')});}else{}});_0x1e9e9c['json']({'data':[]});}[a73_0x53f2('0x9')](_0x5dad7b,_0x335f18,_0x48fde3){sequelize_utils_1[a73_0x53f2('0xc')][a73_0x53f2('0x13')][a73_0x53f2('0x23')]['findOne']({'where':{'status':0x1}})[a73_0x53f2('0x19')](_0x330c91=>{if(_0x330c91){const _0x4455c6='media/'+_0x330c91[a73_0x53f2('0x1a')]+a73_0x53f2('0x24');if(fs_1[a73_0x53f2('0xc')]['existsSync'](_0x4455c6)){const _0x13f5f1=fs_1['default'][a73_0x53f2('0x25')](_0x4455c6);const _0x24db34=_0x13f5f1[a73_0x53f2('0x12')];console[a73_0x53f2('0xa')](a73_0x53f2('0x26')+_0x4455c6);console[a73_0x53f2('0xa')]('fileSizeInBytes:\x20'+_0x24db34);if(_0x24db34>0x0){fs_1[a73_0x53f2('0xc')]['readFile'](_0x4455c6,a73_0x53f2('0x27'),function(_0x4baa0c,_0x787941){if(_0x4baa0c){_0x330c91[a73_0x53f2('0x1f')]=null;}else{try{const _0x2716a9=JSON[a73_0x53f2('0x28')](_0x787941);for(const _0xb54d49 of _0x2716a9[a73_0x53f2('0x29')][0x0][a73_0x53f2('0x2a')]){const _0x22b16b=_0xb54d49['In'];const _0x2350a6=_0xb54d49[a73_0x53f2('0x2b')];const _0x526700=Date[a73_0x53f2('0x28')](_0xb54d49['EndTime']);if(_0x22b16b>0x0){sequelize_utils_1[a73_0x53f2('0xc')][a73_0x53f2('0x13')][a73_0x53f2('0x2c')]['create']({'amount':_0x22b16b,'counted_at':_0x526700});}if(_0x2350a6>0x0){sequelize_utils_1[a73_0x53f2('0xc')][a73_0x53f2('0x13')][a73_0x53f2('0x2c')][a73_0x53f2('0x2d')]({'amount':_0x2350a6*-0x1,'counted_at':_0x526700});}}_0x330c91[a73_0x53f2('0x1f')]=0x2;}catch(_0x4ed901){_0x330c91[a73_0x53f2('0x1f')]=null;}}_0x330c91[a73_0x53f2('0x20')]();});}else{_0x330c91[a73_0x53f2('0x1f')]=null;_0x330c91[a73_0x53f2('0x20')]();}}else{_0x330c91[a73_0x53f2('0x1f')]=null;_0x330c91['save']();}}else{}});_0x335f18['json']({'data':[]});}[a73_0x53f2('0x2e')](_0x435b41,_0xdd2f47,_0x3e036f){const _0x5a7caa=require('zlib');const _0x5d5be2=_0x435b41[a73_0x53f2('0x2f')][a73_0x53f2('0x30')];const _0x27a3bf=UPLOAD_PATH+'/'+_0x435b41[a73_0x53f2('0x2f')]['filename']+'.json';const _0x572452=fs_1[a73_0x53f2('0xc')][a73_0x53f2('0x31')](_0x5d5be2);const _0x20bd50=fs_1[a73_0x53f2('0xc')][a73_0x53f2('0x1e')](_0x27a3bf);const _0x3376b3=_0x5a7caa[a73_0x53f2('0x32')]();console[a73_0x53f2('0xa')](_0x435b41[a73_0x53f2('0x2f')]);_0x572452[a73_0x53f2('0x33')](_0x3376b3)[a73_0x53f2('0x33')](_0x20bd50)['on']('finish',_0x4d52b6=>{if(_0x4d52b6)return console[a73_0x53f2('0x22')](_0x4d52b6);else{const _0x33d7e9=fs_1[a73_0x53f2('0xc')][a73_0x53f2('0x25')](_0x5d5be2);const _0x2d514a=_0x33d7e9[a73_0x53f2('0x12')];if(_0x2d514a>0x0){fs_1[a73_0x53f2('0xc')]['readFile'](_0x27a3bf,a73_0x53f2('0x27'),function(_0x4d52b6,_0x3fcdca){if(_0x4d52b6){return console[a73_0x53f2('0x22')](_0x4d52b6);}else{try{const _0x3c94cb=JSON[a73_0x53f2('0x28')](_0x3fcdca);console[a73_0x53f2('0xa')](_0x3c94cb);const _0x2475de=_0x3c94cb[a73_0x53f2('0x34')][0x0][a73_0x53f2('0x35')];const _0x60bbd0=_0x3c94cb[a73_0x53f2('0x34')][0x0][a73_0x53f2('0x36')];const _0xd64fb6=moment_1[a73_0x53f2('0xc')](_0x2475de+'\x20'+_0x60bbd0+'\x20-05:00',a73_0x53f2('0x37'));const _0x2cea97=parseFloat(_0x3c94cb[a73_0x53f2('0x34')][0x0][a73_0x53f2('0x38')]['replace'](',','.'));const _0x227d2e=parseFloat(_0x3c94cb[a73_0x53f2('0x34')][0x0][a73_0x53f2('0x39')][a73_0x53f2('0x3a')](',','.'));const _0x428855=_0x3c94cb['eventos'][0x0][a73_0x53f2('0x3b')];const _0x2560f3=_0x3c94cb['eventos'][0x0][a73_0x53f2('0x3c')][0x0][a73_0x53f2('0x3d')];const _0x45c004=_0x3c94cb[a73_0x53f2('0x34')][0x0][a73_0x53f2('0x3c')][0x0][a73_0x53f2('0x3e')];console['log'](_0x2cea97);console['log'](_0x227d2e);console['log'](_0x428855);console['log'](_0x2560f3);console[a73_0x53f2('0xa')](_0x45c004);console['log'](_0xd64fb6);if(_0x2560f3>0x0){sequelize_utils_1[a73_0x53f2('0xc')][a73_0x53f2('0x13')][a73_0x53f2('0x2c')][a73_0x53f2('0x2d')]({'amount':_0x2560f3,'counted_at':_0xd64fb6});}sequelize_utils_1[a73_0x53f2('0xc')]['models'][a73_0x53f2('0x3f')][a73_0x53f2('0x2d')]({'device_id':null,'lat':''+_0x2cea97,'lon':''+_0x227d2e,'tracked_at':_0xd64fb6});}catch(_0x1947c1){return console['error'](_0x1947c1);}}});}}});_0xdd2f47[a73_0x53f2('0x40')]({'status':0x1,'data':_0x435b41['file']});}}exports[a73_0x53f2('0xc')]=SyncFilesController;