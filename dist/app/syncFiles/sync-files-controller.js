var a73_0xc72c=['ftp','../../infrastructure/controller-utils','media','default','syncFtp','bind','downloadFtp','processFtp','log','connecting','ready','connected','list','colombia','name','endsWith','json','size','models','syncFilesModel','findOrCreate','spread','push','error','connect','ftp.vivotek.com','ipd','findOne','connected:','file_name','get','colombia/','end','media/','pipe','createWriteStream','status','save','fileName','then','.txt','statSync','fileName:\x20','fileSizeInBytes:\x20','readFile','utf8','Data','CountingInfo','Out','parse','EndTime','passCountingsModel','create','file','path','filename','.json','createReadStream','createGunzip','finish','eventos','replace','longitud','velocidad','puerta','salidas','locationPointsModel','__importDefault','defineProperty','__esModule'];(function(_0x32d002,_0x4ce6b6){var _0x1223df=function(_0x436631){while(--_0x436631){_0x32d002['push'](_0x32d002['shift']());}};_0x1223df(++_0x4ce6b6);}(a73_0xc72c,0xcf));var a73_0x2c72=function(_0x588098,_0x1a8221){_0x588098=_0x588098-0x0;var _0x5d7883=a73_0xc72c[_0x588098];return _0x5d7883;};'use strict';var __importDefault=this&&this[a73_0x2c72('0x0')]||function(_0x578ca7){return _0x578ca7&&_0x578ca7['__esModule']?_0x578ca7:{'default':_0x578ca7};};Object[a73_0x2c72('0x1')](exports,a73_0x2c72('0x2'),{'value':!![]});const ftp_1=__importDefault(require(a73_0x2c72('0x3')));const fs_1=__importDefault(require('fs'));const controller_utils_1=__importDefault(require(a73_0x2c72('0x4')));const sequelize_utils_1=__importDefault(require('../../infrastructure/sequelize-utils'));const moment_1=__importDefault(require('moment'));const UPLOAD_PATH=a73_0x2c72('0x5');class SyncFilesController extends controller_utils_1[a73_0x2c72('0x6')]{constructor(_0x206d9e){super(_0x206d9e,null);this['syncFtp']=this[a73_0x2c72('0x7')][a73_0x2c72('0x8')](this);this[a73_0x2c72('0x9')]=this[a73_0x2c72('0x9')][a73_0x2c72('0x8')](this);this[a73_0x2c72('0xa')]=this[a73_0x2c72('0xa')][a73_0x2c72('0x8')](this);}['syncFtp'](_0x436baa,_0x58901b,_0x2288eb){console[a73_0x2c72('0xb')](a73_0x2c72('0xc'));const _0x2791fb=[];const _0x10f43a=new ftp_1[(a73_0x2c72('0x6'))]();_0x10f43a['on'](a73_0x2c72('0xd'),function(){console['log'](a73_0x2c72('0xe'));_0x10f43a[a73_0x2c72('0xf')](a73_0x2c72('0x10'),![],function(_0x568429,_0x1d0c84){if(_0x568429){console[a73_0x2c72('0xb')](_0x568429);}else{for(const _0x208719 of _0x1d0c84){if(_0x208719[a73_0x2c72('0x11')][a73_0x2c72('0x12')](a73_0x2c72('0x13'))&&_0x208719[a73_0x2c72('0x14')]>0x0){sequelize_utils_1[a73_0x2c72('0x6')][a73_0x2c72('0x15')][a73_0x2c72('0x16')][a73_0x2c72('0x17')]({'where':{'file_name':_0x208719[a73_0x2c72('0x11')]}})[a73_0x2c72('0x18')]((_0x411ac2,_0x17fefb)=>{if(_0x17fefb){_0x2791fb[a73_0x2c72('0x19')](_0x411ac2);}});}}}});});_0x10f43a['on'](a73_0x2c72('0x1a'),function(_0x43ce5d){});_0x10f43a[a73_0x2c72('0x1b')]({'host':a73_0x2c72('0x1c'),'port':0x15,'user':a73_0x2c72('0x1d'),'password':'ipd'});_0x58901b[a73_0x2c72('0x13')]({'data':[]});}['downloadFtp'](_0x3dba53,_0x22d8b8,_0x1bd6b7){sequelize_utils_1[a73_0x2c72('0x6')]['models'][a73_0x2c72('0x16')][a73_0x2c72('0x1e')]({'where':{'status':null}})['then'](_0x2ac711=>{if(_0x2ac711){const _0x4e6a2a=new ftp_1['default']();_0x4e6a2a['on'](a73_0x2c72('0xd'),function(){console['log'](a73_0x2c72('0x1f')+_0x2ac711[a73_0x2c72('0x20')]);_0x4e6a2a[a73_0x2c72('0x21')](a73_0x2c72('0x22')+_0x2ac711[a73_0x2c72('0x20')],function(_0x5c05b3,_0x1e4bc7){_0x4e6a2a[a73_0x2c72('0x23')]();if(_0x5c05b3){}else{const _0x1c1677=a73_0x2c72('0x24')+_0x2ac711[a73_0x2c72('0x20')]+'.txt';_0x1e4bc7[a73_0x2c72('0x25')](fs_1[a73_0x2c72('0x6')][a73_0x2c72('0x26')](_0x1c1677));_0x2ac711[a73_0x2c72('0x27')]=0x1;_0x2ac711[a73_0x2c72('0x28')]();console['log']('Downloaded:\x20'+_0x2ac711[a73_0x2c72('0x29')]);}});});_0x4e6a2a['on']('error',function(_0xd16a8a){});_0x4e6a2a[a73_0x2c72('0x1b')]({'host':'ftp.vivotek.com','port':0x15,'user':a73_0x2c72('0x1d'),'password':'ipd'});}else{}});_0x22d8b8[a73_0x2c72('0x13')]({'data':[]});}['processFtp'](_0x271ded,_0xea0159,_0x239067){sequelize_utils_1[a73_0x2c72('0x6')][a73_0x2c72('0x15')][a73_0x2c72('0x16')]['findOne']({'where':{'status':0x1}})[a73_0x2c72('0x2a')](_0x20be26=>{if(_0x20be26){const _0x53e5e2=a73_0x2c72('0x24')+_0x20be26['file_name']+a73_0x2c72('0x2b');if(fs_1[a73_0x2c72('0x6')]['existsSync'](_0x53e5e2)){const _0x3a7806=fs_1[a73_0x2c72('0x6')][a73_0x2c72('0x2c')](_0x53e5e2);const _0x2488d6=_0x3a7806['size'];console[a73_0x2c72('0xb')](a73_0x2c72('0x2d')+_0x53e5e2);console[a73_0x2c72('0xb')](a73_0x2c72('0x2e')+_0x2488d6);if(_0x2488d6>0x0){fs_1[a73_0x2c72('0x6')][a73_0x2c72('0x2f')](_0x53e5e2,a73_0x2c72('0x30'),function(_0x1c5489,_0x5cf3c9){if(_0x1c5489){_0x20be26[a73_0x2c72('0x27')]=null;}else{try{const _0x4522f4=JSON['parse'](_0x5cf3c9);for(const _0x5096b6 of _0x4522f4[a73_0x2c72('0x31')][0x0][a73_0x2c72('0x32')]){const _0x2de3d1=_0x5096b6['In'];const _0x5d64b3=_0x5096b6[a73_0x2c72('0x33')];const _0x5b188d=Date[a73_0x2c72('0x34')](_0x5096b6[a73_0x2c72('0x35')]);if(_0x2de3d1>0x0){sequelize_utils_1['default']['models'][a73_0x2c72('0x36')][a73_0x2c72('0x37')]({'amount':_0x2de3d1,'counted_at':_0x5b188d});}if(_0x5d64b3>0x0){sequelize_utils_1[a73_0x2c72('0x6')][a73_0x2c72('0x15')][a73_0x2c72('0x36')][a73_0x2c72('0x37')]({'amount':_0x5d64b3*-0x1,'counted_at':_0x5b188d});}}_0x20be26[a73_0x2c72('0x27')]=0x2;}catch(_0x1d4d58){_0x20be26['status']=null;}}_0x20be26[a73_0x2c72('0x28')]();});}else{_0x20be26[a73_0x2c72('0x27')]=null;_0x20be26[a73_0x2c72('0x28')]();}}else{_0x20be26['status']=null;_0x20be26['save']();}}else{}});_0xea0159[a73_0x2c72('0x13')]({'data':[]});}['uploadEvent'](_0x2c0b7b,_0x567a6c,_0x3e17dd){const _0x1b68e3=require('zlib');const _0x4cd4eb=_0x2c0b7b[a73_0x2c72('0x38')][a73_0x2c72('0x39')];const _0x552d9d=UPLOAD_PATH+'/'+_0x2c0b7b['file'][a73_0x2c72('0x3a')]+a73_0x2c72('0x3b');const _0x53c0db=fs_1[a73_0x2c72('0x6')][a73_0x2c72('0x3c')](_0x4cd4eb);const _0x416478=fs_1[a73_0x2c72('0x6')]['createWriteStream'](_0x552d9d);const _0x49befe=_0x1b68e3[a73_0x2c72('0x3d')]();console[a73_0x2c72('0xb')](_0x2c0b7b['file']);_0x53c0db['pipe'](_0x49befe)[a73_0x2c72('0x25')](_0x416478)['on'](a73_0x2c72('0x3e'),_0x3ce73b=>{if(_0x3ce73b)return console[a73_0x2c72('0x1a')](_0x3ce73b);else{const _0x4ba0dd=fs_1['default'][a73_0x2c72('0x2c')](_0x4cd4eb);const _0x2ed902=_0x4ba0dd[a73_0x2c72('0x14')];if(_0x2ed902>0x0){fs_1['default'][a73_0x2c72('0x2f')](_0x552d9d,a73_0x2c72('0x30'),function(_0x3ce73b,_0x4eebaa){if(_0x3ce73b){return console[a73_0x2c72('0x1a')](_0x3ce73b);}else{try{const _0x1eb3ad=JSON['parse'](_0x4eebaa);console[a73_0x2c72('0xb')](_0x1eb3ad);const _0x5e811d=_0x1eb3ad[a73_0x2c72('0x3f')][0x0]['fecha'];const _0x300f9d=_0x1eb3ad[a73_0x2c72('0x3f')][0x0]['hora'];const _0x4b2a4c=moment_1[a73_0x2c72('0x6')](_0x5e811d+'\x20'+_0x300f9d+'\x20-05:00','YYYYMMDD\x20HHmmss\x20Z');const _0x47d338=parseFloat(_0x1eb3ad[a73_0x2c72('0x3f')][0x0]['latitud'][a73_0x2c72('0x40')](',','.'));const _0x49eb4b=parseFloat(_0x1eb3ad[a73_0x2c72('0x3f')][0x0][a73_0x2c72('0x41')][a73_0x2c72('0x40')](',','.'));const _0x1810f1=_0x1eb3ad[a73_0x2c72('0x3f')][0x0][a73_0x2c72('0x42')];const _0x14fdf9=_0x1eb3ad[a73_0x2c72('0x3f')][0x0][a73_0x2c72('0x43')][0x0]['ingresos'];const _0x1667f4=_0x1eb3ad[a73_0x2c72('0x3f')][0x0][a73_0x2c72('0x43')][0x0][a73_0x2c72('0x44')];console[a73_0x2c72('0xb')](_0x47d338);console[a73_0x2c72('0xb')](_0x49eb4b);console[a73_0x2c72('0xb')](_0x1810f1);console['log'](_0x14fdf9);console[a73_0x2c72('0xb')](_0x1667f4);console[a73_0x2c72('0xb')](_0x4b2a4c);if(_0x14fdf9>0x0){sequelize_utils_1[a73_0x2c72('0x6')][a73_0x2c72('0x15')][a73_0x2c72('0x36')][a73_0x2c72('0x37')]({'amount':_0x14fdf9,'counted_at':_0x4b2a4c});}sequelize_utils_1[a73_0x2c72('0x6')][a73_0x2c72('0x15')][a73_0x2c72('0x45')][a73_0x2c72('0x37')]({'device_id':null,'lat':''+_0x47d338,'lon':''+_0x49eb4b,'tracked_at':_0x4b2a4c});}catch(_0x51f3da){return console['error'](_0x51f3da);}}});}}});_0x567a6c['json']({'status':0x1,'data':_0x2c0b7b[a73_0x2c72('0x38')]});}}exports['default']=SyncFilesController;