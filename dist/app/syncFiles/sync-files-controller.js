var a73_0x4bba=['Downloaded:\x20','fileName','existsSync','fileSizeInBytes:\x20','readFile','utf8','status','parse','Data','CountingInfo','Out','passCountingsModel','save','uploadEvent','file','filename','.json','createReadStream','createGunzip','finish','statSync','eventos','hora','YYYYMMDD\x20HHmmss\x20Z','longitud','replace','velocidad','ingresos','salidas','create','__importDefault','__esModule','defineProperty','ftp','../../infrastructure/controller-utils','../../infrastructure/sequelize-utils','moment','media','syncFtp','downloadFtp','processFtp','bind','connecting','ready','connected','list','colombia','log','name','endsWith','json','size','default','models','syncFilesModel','findOrCreate','spread','error','connect','ftp.vivotek.com','ipd','findOne','then','connected:','colombia/','file_name','end','media/','.txt','pipe','createWriteStream'];(function(_0x41dcde,_0x308090){var _0x4d234c=function(_0x2f610d){while(--_0x2f610d){_0x41dcde['push'](_0x41dcde['shift']());}};_0x4d234c(++_0x308090);}(a73_0x4bba,0xf3));var a73_0x516a=function(_0x33d10c,_0x532430){_0x33d10c=_0x33d10c-0x0;var _0x2c3ed3=a73_0x4bba[_0x33d10c];return _0x2c3ed3;};'use strict';var __importDefault=this&&this[a73_0x516a('0x0')]||function(_0x3f70a2){return _0x3f70a2&&_0x3f70a2[a73_0x516a('0x1')]?_0x3f70a2:{'default':_0x3f70a2};};Object[a73_0x516a('0x2')](exports,a73_0x516a('0x1'),{'value':!![]});const ftp_1=__importDefault(require(a73_0x516a('0x3')));const fs_1=__importDefault(require('fs'));const controller_utils_1=__importDefault(require(a73_0x516a('0x4')));const sequelize_utils_1=__importDefault(require(a73_0x516a('0x5')));const moment_1=__importDefault(require(a73_0x516a('0x6')));const UPLOAD_PATH=a73_0x516a('0x7');class SyncFilesController extends controller_utils_1['default']{constructor(_0x4e82fd){super(_0x4e82fd,null);this[a73_0x516a('0x8')]=this['syncFtp']['bind'](this);this[a73_0x516a('0x9')]=this[a73_0x516a('0x9')]['bind'](this);this['processFtp']=this[a73_0x516a('0xa')][a73_0x516a('0xb')](this);}['syncFtp'](_0xca143c,_0x34567a,_0x4bb743){console['log'](a73_0x516a('0xc'));const _0x4231ce=[];const _0x3187a9=new ftp_1['default']();_0x3187a9['on'](a73_0x516a('0xd'),function(){console['log'](a73_0x516a('0xe'));_0x3187a9[a73_0x516a('0xf')](a73_0x516a('0x10'),![],function(_0x417edb,_0x3a1e84){if(_0x417edb){console[a73_0x516a('0x11')](_0x417edb);}else{for(const _0x43e48a of _0x3a1e84){if(_0x43e48a[a73_0x516a('0x12')][a73_0x516a('0x13')](a73_0x516a('0x14'))&&_0x43e48a[a73_0x516a('0x15')]>0x0){sequelize_utils_1[a73_0x516a('0x16')][a73_0x516a('0x17')][a73_0x516a('0x18')][a73_0x516a('0x19')]({'where':{'file_name':_0x43e48a[a73_0x516a('0x12')]}})[a73_0x516a('0x1a')]((_0x46c2e1,_0x47c083)=>{if(_0x47c083){_0x4231ce['push'](_0x46c2e1);}});}}}});});_0x3187a9['on'](a73_0x516a('0x1b'),function(_0x311c50){});_0x3187a9[a73_0x516a('0x1c')]({'host':a73_0x516a('0x1d'),'port':0x15,'user':a73_0x516a('0x1e'),'password':a73_0x516a('0x1e')});_0x34567a[a73_0x516a('0x14')]({'data':[]});}[a73_0x516a('0x9')](_0x3c7e7f,_0x7bafcb,_0x53e9e4){sequelize_utils_1['default'][a73_0x516a('0x17')][a73_0x516a('0x18')][a73_0x516a('0x1f')]({'where':{'status':null}})[a73_0x516a('0x20')](_0x2326a4=>{if(_0x2326a4){const _0xca01dd=new ftp_1[(a73_0x516a('0x16'))]();_0xca01dd['on']('ready',function(){console['log'](a73_0x516a('0x21')+_0x2326a4['file_name']);_0xca01dd['get'](a73_0x516a('0x22')+_0x2326a4[a73_0x516a('0x23')],function(_0x227a96,_0x4afcc8){_0xca01dd[a73_0x516a('0x24')]();if(_0x227a96){}else{const _0x2eb5e0=a73_0x516a('0x25')+_0x2326a4[a73_0x516a('0x23')]+a73_0x516a('0x26');_0x4afcc8[a73_0x516a('0x27')](fs_1[a73_0x516a('0x16')][a73_0x516a('0x28')](_0x2eb5e0));_0x2326a4['status']=0x1;_0x2326a4['save']();console[a73_0x516a('0x11')](a73_0x516a('0x29')+_0x2326a4[a73_0x516a('0x2a')]);}});});_0xca01dd['on'](a73_0x516a('0x1b'),function(_0x38ea6d){});_0xca01dd['connect']({'host':a73_0x516a('0x1d'),'port':0x15,'user':'ipd','password':a73_0x516a('0x1e')});}else{}});_0x7bafcb['json']({'data':[]});}[a73_0x516a('0xa')](_0x24876c,_0x1773dd,_0x407d7d){sequelize_utils_1[a73_0x516a('0x16')][a73_0x516a('0x17')][a73_0x516a('0x18')][a73_0x516a('0x1f')]({'where':{'status':0x1}})[a73_0x516a('0x20')](_0x2c5488=>{if(_0x2c5488){const _0x17ca14='media/'+_0x2c5488[a73_0x516a('0x23')]+'.txt';if(fs_1[a73_0x516a('0x16')][a73_0x516a('0x2b')](_0x17ca14)){const _0xbed48f=fs_1['default']['statSync'](_0x17ca14);const _0x5aaf70=_0xbed48f['size'];console['log']('fileName:\x20'+_0x17ca14);console['log'](a73_0x516a('0x2c')+_0x5aaf70);if(_0x5aaf70>0x0){fs_1[a73_0x516a('0x16')][a73_0x516a('0x2d')](_0x17ca14,a73_0x516a('0x2e'),function(_0x371d0c,_0x4a0d38){if(_0x371d0c){_0x2c5488[a73_0x516a('0x2f')]=null;}else{try{const _0x5a95ad=JSON[a73_0x516a('0x30')](_0x4a0d38);for(const _0x24e7aa of _0x5a95ad[a73_0x516a('0x31')][0x0][a73_0x516a('0x32')]){const _0x36bc9d=_0x24e7aa['In'];const _0x4c9f08=_0x24e7aa[a73_0x516a('0x33')];const _0x1da2fd=Date[a73_0x516a('0x30')](_0x24e7aa['EndTime']);if(_0x36bc9d>0x0){sequelize_utils_1[a73_0x516a('0x16')]['models'][a73_0x516a('0x34')]['create']({'amount':_0x36bc9d,'counted_at':_0x1da2fd});}if(_0x4c9f08>0x0){sequelize_utils_1[a73_0x516a('0x16')][a73_0x516a('0x17')][a73_0x516a('0x34')]['create']({'amount':_0x4c9f08*-0x1,'counted_at':_0x1da2fd});}}_0x2c5488[a73_0x516a('0x2f')]=0x2;}catch(_0x403e4b){_0x2c5488[a73_0x516a('0x2f')]=null;}}_0x2c5488['save']();});}else{_0x2c5488[a73_0x516a('0x2f')]=null;_0x2c5488[a73_0x516a('0x35')]();}}else{_0x2c5488[a73_0x516a('0x2f')]=null;_0x2c5488['save']();}}else{}});_0x1773dd[a73_0x516a('0x14')]({'data':[]});}[a73_0x516a('0x36')](_0x3757f1,_0x2349df,_0x5540a4){const _0x156e7f=require('zlib');const _0x15b601=_0x3757f1[a73_0x516a('0x37')]['path'];const _0x56278b=UPLOAD_PATH+'/'+_0x3757f1[a73_0x516a('0x37')][a73_0x516a('0x38')]+a73_0x516a('0x39');const _0x1dc8d3=fs_1[a73_0x516a('0x16')][a73_0x516a('0x3a')](_0x15b601);const _0x26f9ca=fs_1[a73_0x516a('0x16')][a73_0x516a('0x28')](_0x56278b);const _0x2e7f5f=_0x156e7f[a73_0x516a('0x3b')]();console[a73_0x516a('0x11')](_0x3757f1[a73_0x516a('0x37')]);_0x1dc8d3['pipe'](_0x2e7f5f)[a73_0x516a('0x27')](_0x26f9ca)['on'](a73_0x516a('0x3c'),_0x50cf91=>{if(_0x50cf91)return console[a73_0x516a('0x1b')](_0x50cf91);else{const _0x119056=fs_1[a73_0x516a('0x16')][a73_0x516a('0x3d')](_0x15b601);const _0x2c67a6=_0x119056[a73_0x516a('0x15')];if(_0x2c67a6>0x0){fs_1[a73_0x516a('0x16')]['readFile'](_0x56278b,a73_0x516a('0x2e'),function(_0x50cf91,_0x28f9d9){if(_0x50cf91){return console['error'](_0x50cf91);}else{try{const _0x47cd2e=JSON['parse'](_0x28f9d9);console[a73_0x516a('0x11')](_0x47cd2e);const _0x1b8197=_0x47cd2e[a73_0x516a('0x3e')][0x0]['fecha'];const _0x1274c9=_0x47cd2e[a73_0x516a('0x3e')][0x0][a73_0x516a('0x3f')];const _0x3584e3=moment_1[a73_0x516a('0x16')](_0x1b8197+'\x20'+_0x1274c9+'\x20-05:00',a73_0x516a('0x40'));const _0x1b76b0=parseFloat(_0x47cd2e[a73_0x516a('0x3e')][0x0]['latitud']['replace'](',','.'));const _0x3ae442=parseFloat(_0x47cd2e[a73_0x516a('0x3e')][0x0][a73_0x516a('0x41')][a73_0x516a('0x42')](',','.'));const _0x70c524=_0x47cd2e['eventos'][0x0][a73_0x516a('0x43')];const _0x5df732=_0x47cd2e[a73_0x516a('0x3e')][0x0]['puerta'][0x0][a73_0x516a('0x44')];const _0xec9188=_0x47cd2e['eventos'][0x0]['puerta'][0x0][a73_0x516a('0x45')];console['log'](_0x1b76b0);console['log'](_0x3ae442);console[a73_0x516a('0x11')](_0x70c524);console['log'](_0x5df732);console[a73_0x516a('0x11')](_0xec9188);console[a73_0x516a('0x11')](_0x3584e3);if(_0x5df732>0x0){sequelize_utils_1[a73_0x516a('0x16')][a73_0x516a('0x17')][a73_0x516a('0x34')][a73_0x516a('0x46')]({'amount':_0x5df732,'counted_at':_0x3584e3});}sequelize_utils_1['default'][a73_0x516a('0x17')]['locationPointsModel'][a73_0x516a('0x46')]({'device_id':null,'lat':''+_0x1b76b0,'lon':''+_0x3ae442,'tracked_at':_0x3584e3});}catch(_0x409f03){return console['error'](_0x409f03);}}});}}});_0x2349df[a73_0x516a('0x14')]({'status':0x1,'data':_0x3757f1[a73_0x516a('0x37')]});}}exports[a73_0x516a('0x16')]=SyncFilesController;