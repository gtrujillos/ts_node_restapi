var a162_0x51cd=['uploadEvent','file','filename','createReadStream','createGunzip','finish','eventos','fecha','hora','YYYYMMDD\x20HHmmss\x20Z','replace','longitud','velocidad','ingresos','salidas','locationPointsModel','__importDefault','__esModule','../../infrastructure/sequelize-utils','media','syncFtp','bind','downloadFtp','processFtp','log','connecting','default','ready','list','colombia','name','endsWith','size','models','syncFilesModel','findOrCreate','push','error','connect','ftp.vivotek.com','ipd','json','findOne','file_name','get','pipe','status','save','fileName','media/','statSync','fileName:\x20','fileSizeInBytes:\x20','readFile','utf8','parse','passCountingsModel','create'];(function(_0x271d42,_0x2bde82){var _0x4002a1=function(_0x4f3c58){while(--_0x4f3c58){_0x271d42['push'](_0x271d42['shift']());}};_0x4002a1(++_0x2bde82);}(a162_0x51cd,0xf8));var a162_0x4f3d=function(_0x27a9b0,_0x3211b6){_0x27a9b0=_0x27a9b0-0x0;var _0x13977c=a162_0x51cd[_0x27a9b0];return _0x13977c;};'use strict';var __importDefault=this&&this[a162_0x4f3d('0x0')]||function(_0x1ee955){return _0x1ee955&&_0x1ee955['__esModule']?_0x1ee955:{'default':_0x1ee955};};Object['defineProperty'](exports,a162_0x4f3d('0x1'),{'value':!![]});const ftp_1=__importDefault(require('ftp'));const fs_1=__importDefault(require('fs'));const controller_utils_1=__importDefault(require('../../infrastructure/controller-utils'));const sequelize_utils_1=__importDefault(require(a162_0x4f3d('0x2')));const moment_1=__importDefault(require('moment'));const UPLOAD_PATH=a162_0x4f3d('0x3');class SyncFilesController extends controller_utils_1['default']{constructor(_0x200af9){super(_0x200af9,null);this[a162_0x4f3d('0x4')]=this['syncFtp'][a162_0x4f3d('0x5')](this);this[a162_0x4f3d('0x6')]=this['downloadFtp']['bind'](this);this['processFtp']=this[a162_0x4f3d('0x7')][a162_0x4f3d('0x5')](this);}['syncFtp'](_0x1401b1,_0x1eb285,_0xc1f2d3){console[a162_0x4f3d('0x8')](a162_0x4f3d('0x9'));const _0xe9a3bc=[];const _0x5d2674=new ftp_1[(a162_0x4f3d('0xa'))]();_0x5d2674['on'](a162_0x4f3d('0xb'),function(){console[a162_0x4f3d('0x8')]('connected');_0x5d2674[a162_0x4f3d('0xc')](a162_0x4f3d('0xd'),![],function(_0x5af3aa,_0x50450f){if(_0x5af3aa){console[a162_0x4f3d('0x8')](_0x5af3aa);}else{for(const _0x25fd50 of _0x50450f){if(_0x25fd50[a162_0x4f3d('0xe')][a162_0x4f3d('0xf')]('json')&&_0x25fd50[a162_0x4f3d('0x10')]>0x0){sequelize_utils_1[a162_0x4f3d('0xa')][a162_0x4f3d('0x11')][a162_0x4f3d('0x12')][a162_0x4f3d('0x13')]({'where':{'file_name':_0x25fd50['name']}})['spread']((_0x590a43,_0x549e9d)=>{if(_0x549e9d){_0xe9a3bc[a162_0x4f3d('0x14')](_0x590a43);}});}}}});});_0x5d2674['on'](a162_0x4f3d('0x15'),function(_0x33f7fc){});_0x5d2674[a162_0x4f3d('0x16')]({'host':a162_0x4f3d('0x17'),'port':0x15,'user':a162_0x4f3d('0x18'),'password':'ipd'});_0x1eb285[a162_0x4f3d('0x19')]({'data':[]});}[a162_0x4f3d('0x6')](_0x388b66,_0x4a243d,_0x518c73){sequelize_utils_1[a162_0x4f3d('0xa')][a162_0x4f3d('0x11')][a162_0x4f3d('0x12')][a162_0x4f3d('0x1a')]({'where':{'status':null}})['then'](_0x2dbeca=>{if(_0x2dbeca){const _0xe85c0e=new ftp_1['default']();_0xe85c0e['on']('ready',function(){console['log']('connected:'+_0x2dbeca[a162_0x4f3d('0x1b')]);_0xe85c0e[a162_0x4f3d('0x1c')]('colombia/'+_0x2dbeca[a162_0x4f3d('0x1b')],function(_0x233544,_0x35e73b){_0xe85c0e['end']();if(_0x233544){}else{const _0x471bab='media/'+_0x2dbeca[a162_0x4f3d('0x1b')]+'.txt';_0x35e73b[a162_0x4f3d('0x1d')](fs_1['default']['createWriteStream'](_0x471bab));_0x2dbeca[a162_0x4f3d('0x1e')]=0x1;_0x2dbeca[a162_0x4f3d('0x1f')]();console[a162_0x4f3d('0x8')]('Downloaded:\x20'+_0x2dbeca[a162_0x4f3d('0x20')]);}});});_0xe85c0e['on'](a162_0x4f3d('0x15'),function(_0x4fb493){});_0xe85c0e[a162_0x4f3d('0x16')]({'host':a162_0x4f3d('0x17'),'port':0x15,'user':a162_0x4f3d('0x18'),'password':a162_0x4f3d('0x18')});}else{}});_0x4a243d[a162_0x4f3d('0x19')]({'data':[]});}['processFtp'](_0x559d90,_0x3927ad,_0x5890ea){sequelize_utils_1[a162_0x4f3d('0xa')]['models'][a162_0x4f3d('0x12')][a162_0x4f3d('0x1a')]({'where':{'status':0x1}})['then'](_0x4d44af=>{if(_0x4d44af){const _0x3d0074=a162_0x4f3d('0x21')+_0x4d44af[a162_0x4f3d('0x1b')]+'.txt';if(fs_1[a162_0x4f3d('0xa')]['existsSync'](_0x3d0074)){const _0x54bfbd=fs_1[a162_0x4f3d('0xa')][a162_0x4f3d('0x22')](_0x3d0074);const _0x56eba4=_0x54bfbd[a162_0x4f3d('0x10')];console[a162_0x4f3d('0x8')](a162_0x4f3d('0x23')+_0x3d0074);console[a162_0x4f3d('0x8')](a162_0x4f3d('0x24')+_0x56eba4);if(_0x56eba4>0x0){fs_1[a162_0x4f3d('0xa')][a162_0x4f3d('0x25')](_0x3d0074,a162_0x4f3d('0x26'),function(_0x3338b5,_0x4f24c6){if(_0x3338b5){_0x4d44af[a162_0x4f3d('0x1e')]=null;}else{try{const _0x514330=JSON['parse'](_0x4f24c6);for(const _0xe077f8 of _0x514330['Data'][0x0]['CountingInfo']){const _0x10c7fe=_0xe077f8['In'];const _0x57ef04=_0xe077f8['Out'];const _0x13eb7f=Date[a162_0x4f3d('0x27')](_0xe077f8['EndTime']);if(_0x10c7fe>0x0){sequelize_utils_1[a162_0x4f3d('0xa')][a162_0x4f3d('0x11')][a162_0x4f3d('0x28')][a162_0x4f3d('0x29')]({'amount':_0x10c7fe,'counted_at':_0x13eb7f});}if(_0x57ef04>0x0){sequelize_utils_1[a162_0x4f3d('0xa')]['models'][a162_0x4f3d('0x28')]['create']({'amount':_0x57ef04*-0x1,'counted_at':_0x13eb7f});}}_0x4d44af[a162_0x4f3d('0x1e')]=0x2;}catch(_0x1c1e7f){_0x4d44af[a162_0x4f3d('0x1e')]=null;}}_0x4d44af[a162_0x4f3d('0x1f')]();});}else{_0x4d44af[a162_0x4f3d('0x1e')]=null;_0x4d44af['save']();}}else{_0x4d44af['status']=null;_0x4d44af[a162_0x4f3d('0x1f')]();}}else{}});_0x3927ad['json']({'data':[]});}[a162_0x4f3d('0x2a')](_0x2a0622,_0x42044d,_0x88b081){const _0x716b43=require('zlib');const _0xfff10=_0x2a0622[a162_0x4f3d('0x2b')]['path'];const _0x29bee5=UPLOAD_PATH+'/'+_0x2a0622['file'][a162_0x4f3d('0x2c')]+'.json';const _0x228e60=fs_1['default'][a162_0x4f3d('0x2d')](_0xfff10);const _0x395b71=fs_1[a162_0x4f3d('0xa')]['createWriteStream'](_0x29bee5);const _0x158d09=_0x716b43[a162_0x4f3d('0x2e')]();console[a162_0x4f3d('0x8')](_0x2a0622[a162_0x4f3d('0x2b')]);_0x228e60['pipe'](_0x158d09)['pipe'](_0x395b71)['on'](a162_0x4f3d('0x2f'),_0x45cae4=>{if(_0x45cae4)return console[a162_0x4f3d('0x15')](_0x45cae4);else{const _0x10e64c=fs_1[a162_0x4f3d('0xa')][a162_0x4f3d('0x22')](_0xfff10);const _0x386b24=_0x10e64c[a162_0x4f3d('0x10')];if(_0x386b24>0x0){fs_1[a162_0x4f3d('0xa')][a162_0x4f3d('0x25')](_0x29bee5,a162_0x4f3d('0x26'),function(_0x45cae4,_0x3ad549){if(_0x45cae4){return console['error'](_0x45cae4);}else{try{const _0x1a1755=JSON[a162_0x4f3d('0x27')](_0x3ad549);console[a162_0x4f3d('0x8')](_0x1a1755);const _0x79cb1d=_0x1a1755[a162_0x4f3d('0x30')][0x0][a162_0x4f3d('0x31')];const _0xaee499=_0x1a1755[a162_0x4f3d('0x30')][0x0][a162_0x4f3d('0x32')];const _0x1ef9a8=moment_1[a162_0x4f3d('0xa')](_0x79cb1d+'\x20'+_0xaee499+'\x20-05:00',a162_0x4f3d('0x33'));const _0x2b0a87=parseFloat(_0x1a1755[a162_0x4f3d('0x30')][0x0]['latitud'][a162_0x4f3d('0x34')](',','.'));const _0x9ffd0b=parseFloat(_0x1a1755[a162_0x4f3d('0x30')][0x0][a162_0x4f3d('0x35')][a162_0x4f3d('0x34')](',','.'));const _0x4da7e3=_0x1a1755[a162_0x4f3d('0x30')][0x0][a162_0x4f3d('0x36')];const _0x5d74d8=_0x1a1755[a162_0x4f3d('0x30')][0x0]['puerta'][0x0][a162_0x4f3d('0x37')];const _0x1b6cd1=_0x1a1755[a162_0x4f3d('0x30')][0x0]['puerta'][0x0][a162_0x4f3d('0x38')];console[a162_0x4f3d('0x8')](_0x2b0a87);console[a162_0x4f3d('0x8')](_0x9ffd0b);console[a162_0x4f3d('0x8')](_0x4da7e3);console[a162_0x4f3d('0x8')](_0x5d74d8);console['log'](_0x1b6cd1);console[a162_0x4f3d('0x8')](_0x1ef9a8);if(_0x5d74d8>0x0){sequelize_utils_1['default'][a162_0x4f3d('0x11')][a162_0x4f3d('0x28')][a162_0x4f3d('0x29')]({'amount':_0x5d74d8,'counted_at':_0x1ef9a8});}sequelize_utils_1[a162_0x4f3d('0xa')]['models'][a162_0x4f3d('0x39')][a162_0x4f3d('0x29')]({'device_id':null,'lat':''+_0x2b0a87,'lon':''+_0x9ffd0b,'tracked_at':_0x1ef9a8});}catch(_0x3f667a){return console['error'](_0x3f667a);}}});}}});_0x42044d[a162_0x4f3d('0x19')]({'status':0x1,'data':_0x2a0622[a162_0x4f3d('0x2b')]});}}exports['default']=SyncFilesController;