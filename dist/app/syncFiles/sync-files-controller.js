var a73_0x5300=['.txt','pipe','save','Downloaded:\x20','fileName','existsSync','statSync','size','fileName:\x20','readFile','utf8','status','parse','Data','Out','EndTime','passCountingsModel','uploadEvent','zlib','file','path','filename','.json','createReadStream','createGunzip','finish','error','eventos','fecha','hora','\x20-05:00','longitud','replace','puerta','salidas','create','locationPointsModel','__importDefault','__esModule','defineProperty','moment','default','syncFtp','bind','downloadFtp','processFtp','log','connecting','ready','connected','list','colombia','name','endsWith','json','models','spread','push','connect','ftp.vivotek.com','ipd','syncFilesModel','findOne','then','connected:','end','media/','file_name'];(function(_0x2fc5dc,_0x2b64b7){var _0x34200d=function(_0x71fd41){while(--_0x71fd41){_0x2fc5dc['push'](_0x2fc5dc['shift']());}};_0x34200d(++_0x2b64b7);}(a73_0x5300,0xf1));var a73_0x3066=function(_0x1c5328,_0x8afd9){_0x1c5328=_0x1c5328-0x0;var _0x2bfb92=a73_0x5300[_0x1c5328];return _0x2bfb92;};'use strict';var __importDefault=this&&this[a73_0x3066('0x0')]||function(_0x18f782){return _0x18f782&&_0x18f782[a73_0x3066('0x1')]?_0x18f782:{'default':_0x18f782};};Object[a73_0x3066('0x2')](exports,a73_0x3066('0x1'),{'value':!![]});const ftp_1=__importDefault(require('ftp'));const fs_1=__importDefault(require('fs'));const controller_utils_1=__importDefault(require('../../infrastructure/controller-utils'));const sequelize_utils_1=__importDefault(require('../../infrastructure/sequelize-utils'));const moment_1=__importDefault(require(a73_0x3066('0x3')));const UPLOAD_PATH='media';class SyncFilesController extends controller_utils_1[a73_0x3066('0x4')]{constructor(_0x27b91c){super(_0x27b91c,null);this[a73_0x3066('0x5')]=this['syncFtp'][a73_0x3066('0x6')](this);this[a73_0x3066('0x7')]=this[a73_0x3066('0x7')][a73_0x3066('0x6')](this);this['processFtp']=this[a73_0x3066('0x8')][a73_0x3066('0x6')](this);}[a73_0x3066('0x5')](_0x1561f5,_0x2a06aa,_0x224509){console[a73_0x3066('0x9')](a73_0x3066('0xa'));const _0x2b5fbf=[];const _0x521f24=new ftp_1[(a73_0x3066('0x4'))]();_0x521f24['on'](a73_0x3066('0xb'),function(){console[a73_0x3066('0x9')](a73_0x3066('0xc'));_0x521f24[a73_0x3066('0xd')](a73_0x3066('0xe'),![],function(_0xc701d6,_0x675a65){if(_0xc701d6){console[a73_0x3066('0x9')](_0xc701d6);}else{for(const _0x4b3518 of _0x675a65){if(_0x4b3518[a73_0x3066('0xf')][a73_0x3066('0x10')](a73_0x3066('0x11'))&&_0x4b3518['size']>0x0){sequelize_utils_1['default'][a73_0x3066('0x12')]['syncFilesModel']['findOrCreate']({'where':{'file_name':_0x4b3518[a73_0x3066('0xf')]}})[a73_0x3066('0x13')]((_0x57aaea,_0x4fa141)=>{if(_0x4fa141){_0x2b5fbf[a73_0x3066('0x14')](_0x57aaea);}});}}}});});_0x521f24['on']('error',function(_0x45ba8b){});_0x521f24[a73_0x3066('0x15')]({'host':a73_0x3066('0x16'),'port':0x15,'user':'ipd','password':a73_0x3066('0x17')});_0x2a06aa[a73_0x3066('0x11')]({'data':[]});}[a73_0x3066('0x7')](_0x286893,_0x47157e,_0x58867b){sequelize_utils_1['default']['models'][a73_0x3066('0x18')][a73_0x3066('0x19')]({'where':{'status':null}})[a73_0x3066('0x1a')](_0x57ee0e=>{if(_0x57ee0e){const _0xea572b=new ftp_1[(a73_0x3066('0x4'))]();_0xea572b['on'](a73_0x3066('0xb'),function(){console[a73_0x3066('0x9')](a73_0x3066('0x1b')+_0x57ee0e['file_name']);_0xea572b['get']('colombia/'+_0x57ee0e['file_name'],function(_0x118513,_0x535908){_0xea572b[a73_0x3066('0x1c')]();if(_0x118513){}else{const _0x15f7fe=a73_0x3066('0x1d')+_0x57ee0e[a73_0x3066('0x1e')]+a73_0x3066('0x1f');_0x535908[a73_0x3066('0x20')](fs_1[a73_0x3066('0x4')]['createWriteStream'](_0x15f7fe));_0x57ee0e['status']=0x1;_0x57ee0e[a73_0x3066('0x21')]();console[a73_0x3066('0x9')](a73_0x3066('0x22')+_0x57ee0e[a73_0x3066('0x23')]);}});});_0xea572b['on']('error',function(_0x3022c9){});_0xea572b[a73_0x3066('0x15')]({'host':'ftp.vivotek.com','port':0x15,'user':'ipd','password':'ipd'});}else{}});_0x47157e[a73_0x3066('0x11')]({'data':[]});}['processFtp'](_0x295a98,_0xb03a10,_0x1bd2a6){sequelize_utils_1[a73_0x3066('0x4')][a73_0x3066('0x12')][a73_0x3066('0x18')]['findOne']({'where':{'status':0x1}})['then'](_0x49984b=>{if(_0x49984b){const _0x55a22b=a73_0x3066('0x1d')+_0x49984b[a73_0x3066('0x1e')]+a73_0x3066('0x1f');if(fs_1[a73_0x3066('0x4')][a73_0x3066('0x24')](_0x55a22b)){const _0x55271b=fs_1[a73_0x3066('0x4')][a73_0x3066('0x25')](_0x55a22b);const _0x5c14a1=_0x55271b[a73_0x3066('0x26')];console['log'](a73_0x3066('0x27')+_0x55a22b);console[a73_0x3066('0x9')]('fileSizeInBytes:\x20'+_0x5c14a1);if(_0x5c14a1>0x0){fs_1[a73_0x3066('0x4')][a73_0x3066('0x28')](_0x55a22b,a73_0x3066('0x29'),function(_0x15a63f,_0x589924){if(_0x15a63f){_0x49984b[a73_0x3066('0x2a')]=null;}else{try{const _0x251e3e=JSON[a73_0x3066('0x2b')](_0x589924);for(const _0x2f0f76 of _0x251e3e[a73_0x3066('0x2c')][0x0]['CountingInfo']){const _0x430ebe=_0x2f0f76['In'];const _0x1899af=_0x2f0f76[a73_0x3066('0x2d')];const _0x2efbfb=Date['parse'](_0x2f0f76[a73_0x3066('0x2e')]);if(_0x430ebe>0x0){sequelize_utils_1[a73_0x3066('0x4')]['models'][a73_0x3066('0x2f')]['create']({'amount':_0x430ebe,'counted_at':_0x2efbfb});}if(_0x1899af>0x0){sequelize_utils_1[a73_0x3066('0x4')][a73_0x3066('0x12')][a73_0x3066('0x2f')]['create']({'amount':_0x1899af*-0x1,'counted_at':_0x2efbfb});}}_0x49984b[a73_0x3066('0x2a')]=0x2;}catch(_0x2b89d4){_0x49984b[a73_0x3066('0x2a')]=null;}}_0x49984b[a73_0x3066('0x21')]();});}else{_0x49984b['status']=null;_0x49984b[a73_0x3066('0x21')]();}}else{_0x49984b[a73_0x3066('0x2a')]=null;_0x49984b[a73_0x3066('0x21')]();}}else{}});_0xb03a10['json']({'data':[]});}[a73_0x3066('0x30')](_0xf61bde,_0x2d3222,_0x2ad6c1){const _0x59519a=require(a73_0x3066('0x31'));const _0x12ecc1=_0xf61bde[a73_0x3066('0x32')][a73_0x3066('0x33')];const _0x2549c6=UPLOAD_PATH+'/'+_0xf61bde[a73_0x3066('0x32')][a73_0x3066('0x34')]+a73_0x3066('0x35');const _0x4baab9=fs_1[a73_0x3066('0x4')][a73_0x3066('0x36')](_0x12ecc1);const _0x586fa3=fs_1[a73_0x3066('0x4')]['createWriteStream'](_0x2549c6);const _0x112a46=_0x59519a[a73_0x3066('0x37')]();console[a73_0x3066('0x9')](_0xf61bde[a73_0x3066('0x32')]);_0x4baab9['pipe'](_0x112a46)[a73_0x3066('0x20')](_0x586fa3)['on'](a73_0x3066('0x38'),_0x34b417=>{if(_0x34b417)return console[a73_0x3066('0x39')](_0x34b417);else{const _0x573e04=fs_1[a73_0x3066('0x4')][a73_0x3066('0x25')](_0x12ecc1);const _0x1099c7=_0x573e04[a73_0x3066('0x26')];if(_0x1099c7>0x0){fs_1[a73_0x3066('0x4')][a73_0x3066('0x28')](_0x2549c6,a73_0x3066('0x29'),function(_0x34b417,_0x1b47b0){if(_0x34b417){return console[a73_0x3066('0x39')](_0x34b417);}else{try{const _0x4a468d=JSON[a73_0x3066('0x2b')](_0x1b47b0);console[a73_0x3066('0x9')](_0x4a468d);const _0x3026aa=_0x4a468d[a73_0x3066('0x3a')][0x0][a73_0x3066('0x3b')];const _0x2970fd=_0x4a468d['eventos'][0x0][a73_0x3066('0x3c')];const _0x59dff2=moment_1[a73_0x3066('0x4')](_0x3026aa+'\x20'+_0x2970fd+a73_0x3066('0x3d'),'YYYYMMDD\x20HHmmss\x20Z');const _0x5cafc9=parseFloat(_0x4a468d[a73_0x3066('0x3a')][0x0]['latitud']['replace'](',','.'));const _0x509ff0=parseFloat(_0x4a468d[a73_0x3066('0x3a')][0x0][a73_0x3066('0x3e')][a73_0x3066('0x3f')](',','.'));const _0x235bb9=_0x4a468d[a73_0x3066('0x3a')][0x0]['velocidad'];const _0x102be9=_0x4a468d[a73_0x3066('0x3a')][0x0][a73_0x3066('0x40')][0x0]['ingresos'];const _0x224d2c=_0x4a468d[a73_0x3066('0x3a')][0x0][a73_0x3066('0x40')][0x0][a73_0x3066('0x41')];console[a73_0x3066('0x9')](_0x5cafc9);console[a73_0x3066('0x9')](_0x509ff0);console[a73_0x3066('0x9')](_0x235bb9);console[a73_0x3066('0x9')](_0x102be9);console[a73_0x3066('0x9')](_0x224d2c);console[a73_0x3066('0x9')](_0x59dff2);if(_0x102be9>0x0){sequelize_utils_1[a73_0x3066('0x4')][a73_0x3066('0x12')][a73_0x3066('0x2f')][a73_0x3066('0x42')]({'amount':_0x102be9,'counted_at':_0x59dff2});}sequelize_utils_1[a73_0x3066('0x4')][a73_0x3066('0x12')][a73_0x3066('0x43')][a73_0x3066('0x42')]({'device_id':null,'lat':''+_0x5cafc9,'lon':''+_0x509ff0,'tracked_at':_0x59dff2});}catch(_0xd4eceb){return console[a73_0x3066('0x39')](_0xd4eceb);}}});}}});_0x2d3222[a73_0x3066('0x11')]({'status':0x1,'data':_0xf61bde[a73_0x3066('0x32')]});}}exports[a73_0x3066('0x4')]=SyncFilesController;