var a162_0x7b9f=['readFile','status','parse','Data','CountingInfo','Out','EndTime','passCountingsModel','create','uploadEvent','zlib','file','path','filename','.json','createGunzip','eventos','fecha','hora','\x20-05:00','YYYYMMDD\x20HHmmss\x20Z','latitud','replace','velocidad','puerta','ingresos','salidas','locationPointsModel','__importDefault','__esModule','defineProperty','ftp','../../infrastructure/controller-utils','moment','default','syncFtp','downloadFtp','bind','processFtp','log','ready','list','colombia','name','endsWith','json','size','models','push','error','ftp.vivotek.com','syncFilesModel','findOne','file_name','colombia/','media/','.txt','pipe','save','Downloaded:\x20','fileName','connect','ipd','then','statSync','fileName:\x20','fileSizeInBytes:\x20'];(function(_0x312d33,_0x2bc073){var _0x12fcfc=function(_0x27b360){while(--_0x27b360){_0x312d33['push'](_0x312d33['shift']());}};_0x12fcfc(++_0x2bc073);}(a162_0x7b9f,0x1ae));var a162_0x2804=function(_0x3f7095,_0x2117ed){_0x3f7095=_0x3f7095-0x0;var _0x1eb49f=a162_0x7b9f[_0x3f7095];return _0x1eb49f;};'use strict';var __importDefault=this&&this[a162_0x2804('0x0')]||function(_0x164ae5){return _0x164ae5&&_0x164ae5[a162_0x2804('0x1')]?_0x164ae5:{'default':_0x164ae5};};Object[a162_0x2804('0x2')](exports,a162_0x2804('0x1'),{'value':!![]});const ftp_1=__importDefault(require(a162_0x2804('0x3')));const fs_1=__importDefault(require('fs'));const controller_utils_1=__importDefault(require(a162_0x2804('0x4')));const sequelize_utils_1=__importDefault(require('../../infrastructure/sequelize-utils'));const moment_1=__importDefault(require(a162_0x2804('0x5')));const UPLOAD_PATH='media';class SyncFilesController extends controller_utils_1[a162_0x2804('0x6')]{constructor(_0x32f5c0){super(_0x32f5c0,null);this[a162_0x2804('0x7')]=this[a162_0x2804('0x7')]['bind'](this);this[a162_0x2804('0x8')]=this[a162_0x2804('0x8')][a162_0x2804('0x9')](this);this[a162_0x2804('0xa')]=this[a162_0x2804('0xa')][a162_0x2804('0x9')](this);}[a162_0x2804('0x7')](_0x5500b9,_0x37cfe2,_0x5b93ed){console[a162_0x2804('0xb')]('connecting');const _0x553009=[];const _0xfc72ed=new ftp_1[(a162_0x2804('0x6'))]();_0xfc72ed['on'](a162_0x2804('0xc'),function(){console['log']('connected');_0xfc72ed[a162_0x2804('0xd')](a162_0x2804('0xe'),![],function(_0x303c6d,_0x2a24d1){if(_0x303c6d){console[a162_0x2804('0xb')](_0x303c6d);}else{for(const _0x472dbb of _0x2a24d1){if(_0x472dbb[a162_0x2804('0xf')][a162_0x2804('0x10')](a162_0x2804('0x11'))&&_0x472dbb[a162_0x2804('0x12')]>0x0){sequelize_utils_1[a162_0x2804('0x6')][a162_0x2804('0x13')]['syncFilesModel']['findOrCreate']({'where':{'file_name':_0x472dbb[a162_0x2804('0xf')]}})['spread']((_0x196974,_0x5189da)=>{if(_0x5189da){_0x553009[a162_0x2804('0x14')](_0x196974);}});}}}});});_0xfc72ed['on'](a162_0x2804('0x15'),function(_0x71a27a){});_0xfc72ed['connect']({'host':a162_0x2804('0x16'),'port':0x15,'user':'ipd','password':'ipd'});_0x37cfe2[a162_0x2804('0x11')]({'data':[]});}['downloadFtp'](_0x3054fb,_0x51ff9b,_0x3773e1){sequelize_utils_1['default'][a162_0x2804('0x13')][a162_0x2804('0x17')][a162_0x2804('0x18')]({'where':{'status':null}})['then'](_0x2d7ae7=>{if(_0x2d7ae7){const _0x5b77b6=new ftp_1[(a162_0x2804('0x6'))]();_0x5b77b6['on'](a162_0x2804('0xc'),function(){console['log']('connected:'+_0x2d7ae7[a162_0x2804('0x19')]);_0x5b77b6['get'](a162_0x2804('0x1a')+_0x2d7ae7[a162_0x2804('0x19')],function(_0x5d1a79,_0x54336d){_0x5b77b6['end']();if(_0x5d1a79){}else{const _0x21ee68=a162_0x2804('0x1b')+_0x2d7ae7[a162_0x2804('0x19')]+a162_0x2804('0x1c');_0x54336d[a162_0x2804('0x1d')](fs_1[a162_0x2804('0x6')]['createWriteStream'](_0x21ee68));_0x2d7ae7['status']=0x1;_0x2d7ae7[a162_0x2804('0x1e')]();console['log'](a162_0x2804('0x1f')+_0x2d7ae7[a162_0x2804('0x20')]);}});});_0x5b77b6['on'](a162_0x2804('0x15'),function(_0xaf2a1e){});_0x5b77b6[a162_0x2804('0x21')]({'host':'ftp.vivotek.com','port':0x15,'user':'ipd','password':a162_0x2804('0x22')});}else{}});_0x51ff9b[a162_0x2804('0x11')]({'data':[]});}[a162_0x2804('0xa')](_0x186c1d,_0xcc8f20,_0x289d5a){sequelize_utils_1[a162_0x2804('0x6')]['models'][a162_0x2804('0x17')][a162_0x2804('0x18')]({'where':{'status':0x1}})[a162_0x2804('0x23')](_0x1a2443=>{if(_0x1a2443){const _0x4781cd=a162_0x2804('0x1b')+_0x1a2443[a162_0x2804('0x19')]+'.txt';if(fs_1[a162_0x2804('0x6')]['existsSync'](_0x4781cd)){const _0x5f2557=fs_1[a162_0x2804('0x6')][a162_0x2804('0x24')](_0x4781cd);const _0x1f0be0=_0x5f2557[a162_0x2804('0x12')];console[a162_0x2804('0xb')](a162_0x2804('0x25')+_0x4781cd);console[a162_0x2804('0xb')](a162_0x2804('0x26')+_0x1f0be0);if(_0x1f0be0>0x0){fs_1[a162_0x2804('0x6')][a162_0x2804('0x27')](_0x4781cd,'utf8',function(_0x10d0b5,_0x250503){if(_0x10d0b5){_0x1a2443[a162_0x2804('0x28')]=null;}else{try{const _0x3ebe77=JSON[a162_0x2804('0x29')](_0x250503);for(const _0xe8aa23 of _0x3ebe77[a162_0x2804('0x2a')][0x0][a162_0x2804('0x2b')]){const _0x2d8d37=_0xe8aa23['In'];const _0x34d580=_0xe8aa23[a162_0x2804('0x2c')];const _0x4e8ba2=Date['parse'](_0xe8aa23[a162_0x2804('0x2d')]);if(_0x2d8d37>0x0){sequelize_utils_1['default'][a162_0x2804('0x13')][a162_0x2804('0x2e')][a162_0x2804('0x2f')]({'amount':_0x2d8d37,'counted_at':_0x4e8ba2});}if(_0x34d580>0x0){sequelize_utils_1[a162_0x2804('0x6')][a162_0x2804('0x13')][a162_0x2804('0x2e')][a162_0x2804('0x2f')]({'amount':_0x34d580*-0x1,'counted_at':_0x4e8ba2});}}_0x1a2443['status']=0x2;}catch(_0x15d3a9){_0x1a2443[a162_0x2804('0x28')]=null;}}_0x1a2443['save']();});}else{_0x1a2443['status']=null;_0x1a2443['save']();}}else{_0x1a2443[a162_0x2804('0x28')]=null;_0x1a2443[a162_0x2804('0x1e')]();}}else{}});_0xcc8f20[a162_0x2804('0x11')]({'data':[]});}[a162_0x2804('0x30')](_0x311fc2,_0x2a956b,_0x38e826){const _0xa59769=require(a162_0x2804('0x31'));const _0x195645=_0x311fc2[a162_0x2804('0x32')][a162_0x2804('0x33')];const _0x221893=UPLOAD_PATH+'/'+_0x311fc2[a162_0x2804('0x32')][a162_0x2804('0x34')]+a162_0x2804('0x35');const _0x367ced=fs_1[a162_0x2804('0x6')]['createReadStream'](_0x195645);const _0x121714=fs_1[a162_0x2804('0x6')]['createWriteStream'](_0x221893);const _0x9a7d28=_0xa59769[a162_0x2804('0x36')]();console[a162_0x2804('0xb')](_0x311fc2[a162_0x2804('0x32')]);_0x367ced[a162_0x2804('0x1d')](_0x9a7d28)['pipe'](_0x121714)['on']('finish',_0x1ce4e1=>{if(_0x1ce4e1)return console['error'](_0x1ce4e1);else{const _0x377ee0=fs_1[a162_0x2804('0x6')]['statSync'](_0x195645);const _0x476e91=_0x377ee0['size'];if(_0x476e91>0x0){fs_1['default'][a162_0x2804('0x27')](_0x221893,'utf8',function(_0x1ce4e1,_0x2d416c){if(_0x1ce4e1){return console[a162_0x2804('0x15')](_0x1ce4e1);}else{try{const _0x4195ea=JSON[a162_0x2804('0x29')](_0x2d416c);console[a162_0x2804('0xb')](_0x4195ea);const _0x49fcc9=_0x4195ea[a162_0x2804('0x37')][0x0][a162_0x2804('0x38')];const _0x4eecc0=_0x4195ea['eventos'][0x0][a162_0x2804('0x39')];const _0x61018a=moment_1[a162_0x2804('0x6')](_0x49fcc9+'\x20'+_0x4eecc0+a162_0x2804('0x3a'),a162_0x2804('0x3b'));const _0x1375d4=parseFloat(_0x4195ea['eventos'][0x0][a162_0x2804('0x3c')][a162_0x2804('0x3d')](',','.'));const _0x1eec6c=parseFloat(_0x4195ea[a162_0x2804('0x37')][0x0]['longitud']['replace'](',','.'));const _0x187248=_0x4195ea[a162_0x2804('0x37')][0x0][a162_0x2804('0x3e')];const _0x6a7269=_0x4195ea[a162_0x2804('0x37')][0x0][a162_0x2804('0x3f')][0x0][a162_0x2804('0x40')];const _0x276225=_0x4195ea[a162_0x2804('0x37')][0x0][a162_0x2804('0x3f')][0x0][a162_0x2804('0x41')];console[a162_0x2804('0xb')](_0x1375d4);console[a162_0x2804('0xb')](_0x1eec6c);console[a162_0x2804('0xb')](_0x187248);console[a162_0x2804('0xb')](_0x6a7269);console['log'](_0x276225);console[a162_0x2804('0xb')](_0x61018a);if(_0x6a7269>0x0){sequelize_utils_1[a162_0x2804('0x6')]['models'][a162_0x2804('0x2e')][a162_0x2804('0x2f')]({'amount':_0x6a7269,'counted_at':_0x61018a});}sequelize_utils_1[a162_0x2804('0x6')]['models'][a162_0x2804('0x42')]['create']({'device_id':null,'lat':''+_0x1375d4,'lon':''+_0x1eec6c,'tracked_at':_0x61018a});}catch(_0x50e685){return console[a162_0x2804('0x15')](_0x50e685);}}});}}});_0x2a956b['json']({'status':0x1,'data':_0x311fc2[a162_0x2804('0x32')]});}}exports[a162_0x2804('0x6')]=SyncFilesController;