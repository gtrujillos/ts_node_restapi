var a72_0x1e00=['YYYYMMDD\x20HHmmss\x20Z','latitud','replace','longitud','velocidad','puerta','ingresos','salidas','locationPointsModel','__importDefault','__esModule','defineProperty','../../infrastructure/controller-utils','../../infrastructure/sequelize-utils','moment','media','default','syncFtp','bind','processFtp','log','connecting','connected','list','name','json','size','models','findOrCreate','error','ftp.vivotek.com','ipd','syncFilesModel','findOne','then','connected:','file_name','get','colombia/','end','media/','createWriteStream','status','save','Downloaded:\x20','connect','existsSync','fileName:\x20','utf8','parse','Data','Out','EndTime','passCountingsModel','create','uploadEvent','path','file','filename','createReadStream','createGunzip','pipe','finish','statSync','eventos','fecha','hora','\x20-05:00'];(function(_0x43b993,_0x33db2d){var _0x2e3386=function(_0x35bfa0){while(--_0x35bfa0){_0x43b993['push'](_0x43b993['shift']());}};_0x2e3386(++_0x33db2d);}(a72_0x1e00,0x119));var a72_0x1427=function(_0x3f10ea,_0x5bd454){_0x3f10ea=_0x3f10ea-0x0;var _0x4fb749=a72_0x1e00[_0x3f10ea];return _0x4fb749;};'use strict';var __importDefault=this&&this[a72_0x1427('0x0')]||function(_0x2a74e7){return _0x2a74e7&&_0x2a74e7[a72_0x1427('0x1')]?_0x2a74e7:{'default':_0x2a74e7};};Object[a72_0x1427('0x2')](exports,a72_0x1427('0x1'),{'value':!![]});const ftp_1=__importDefault(require('ftp'));const fs_1=__importDefault(require('fs'));const controller_utils_1=__importDefault(require(a72_0x1427('0x3')));const sequelize_utils_1=__importDefault(require(a72_0x1427('0x4')));const moment_1=__importDefault(require(a72_0x1427('0x5')));const UPLOAD_PATH=a72_0x1427('0x6');class SyncFilesController extends controller_utils_1[a72_0x1427('0x7')]{constructor(_0x1df9f7){super(_0x1df9f7,null);this[a72_0x1427('0x8')]=this['syncFtp']['bind'](this);this['downloadFtp']=this['downloadFtp'][a72_0x1427('0x9')](this);this[a72_0x1427('0xa')]=this[a72_0x1427('0xa')]['bind'](this);}[a72_0x1427('0x8')](_0x4a541f,_0x229e9b,_0x34f9b7){console[a72_0x1427('0xb')](a72_0x1427('0xc'));const _0x3109b2=[];const _0x286fd4=new ftp_1[(a72_0x1427('0x7'))]();_0x286fd4['on']('ready',function(){console[a72_0x1427('0xb')](a72_0x1427('0xd'));_0x286fd4[a72_0x1427('0xe')]('colombia',![],function(_0x14fa08,_0x187686){if(_0x14fa08){console['log'](_0x14fa08);}else{for(const _0x4a5c6c of _0x187686){if(_0x4a5c6c[a72_0x1427('0xf')]['endsWith'](a72_0x1427('0x10'))&&_0x4a5c6c[a72_0x1427('0x11')]>0x0){sequelize_utils_1[a72_0x1427('0x7')][a72_0x1427('0x12')]['syncFilesModel'][a72_0x1427('0x13')]({'where':{'file_name':_0x4a5c6c[a72_0x1427('0xf')]}})['spread']((_0x4f66a0,_0x3ead5a)=>{if(_0x3ead5a){_0x3109b2['push'](_0x4f66a0);}});}}}});});_0x286fd4['on'](a72_0x1427('0x14'),function(_0x5e5a5b){});_0x286fd4['connect']({'host':a72_0x1427('0x15'),'port':0x15,'user':a72_0x1427('0x16'),'password':a72_0x1427('0x16')});_0x229e9b['json']({'data':[]});}['downloadFtp'](_0x5d7aa5,_0x456499,_0x229a56){sequelize_utils_1[a72_0x1427('0x7')][a72_0x1427('0x12')][a72_0x1427('0x17')][a72_0x1427('0x18')]({'where':{'status':null}})[a72_0x1427('0x19')](_0x46d9cb=>{if(_0x46d9cb){const _0x534e28=new ftp_1['default']();_0x534e28['on']('ready',function(){console[a72_0x1427('0xb')](a72_0x1427('0x1a')+_0x46d9cb[a72_0x1427('0x1b')]);_0x534e28[a72_0x1427('0x1c')](a72_0x1427('0x1d')+_0x46d9cb['file_name'],function(_0x351cc5,_0x4e1ddc){_0x534e28[a72_0x1427('0x1e')]();if(_0x351cc5){}else{const _0x31ba7f=a72_0x1427('0x1f')+_0x46d9cb[a72_0x1427('0x1b')]+'.txt';_0x4e1ddc['pipe'](fs_1[a72_0x1427('0x7')][a72_0x1427('0x20')](_0x31ba7f));_0x46d9cb[a72_0x1427('0x21')]=0x1;_0x46d9cb[a72_0x1427('0x22')]();console[a72_0x1427('0xb')](a72_0x1427('0x23')+_0x46d9cb['fileName']);}});});_0x534e28['on'](a72_0x1427('0x14'),function(_0x3bd64f){});_0x534e28[a72_0x1427('0x24')]({'host':'ftp.vivotek.com','port':0x15,'user':'ipd','password':a72_0x1427('0x16')});}else{}});_0x456499[a72_0x1427('0x10')]({'data':[]});}[a72_0x1427('0xa')](_0x5b0b70,_0x5569ec,_0x4a54fc){sequelize_utils_1['default'][a72_0x1427('0x12')][a72_0x1427('0x17')][a72_0x1427('0x18')]({'where':{'status':0x1}})[a72_0x1427('0x19')](_0x3b555c=>{if(_0x3b555c){const _0x1b23fc=a72_0x1427('0x1f')+_0x3b555c['file_name']+'.txt';if(fs_1[a72_0x1427('0x7')][a72_0x1427('0x25')](_0x1b23fc)){const _0x1e6185=fs_1['default']['statSync'](_0x1b23fc);const _0x30ba22=_0x1e6185[a72_0x1427('0x11')];console['log'](a72_0x1427('0x26')+_0x1b23fc);console[a72_0x1427('0xb')]('fileSizeInBytes:\x20'+_0x30ba22);if(_0x30ba22>0x0){fs_1[a72_0x1427('0x7')]['readFile'](_0x1b23fc,a72_0x1427('0x27'),function(_0x48bfa9,_0x928443){if(_0x48bfa9){_0x3b555c[a72_0x1427('0x21')]=null;}else{try{const _0x241242=JSON[a72_0x1427('0x28')](_0x928443);for(const _0x4c7ee6 of _0x241242[a72_0x1427('0x29')][0x0]['CountingInfo']){const _0x466eae=_0x4c7ee6['In'];const _0x392d2a=_0x4c7ee6[a72_0x1427('0x2a')];const _0x475d8e=Date[a72_0x1427('0x28')](_0x4c7ee6[a72_0x1427('0x2b')]);if(_0x466eae>0x0){sequelize_utils_1[a72_0x1427('0x7')][a72_0x1427('0x12')][a72_0x1427('0x2c')][a72_0x1427('0x2d')]({'amount':_0x466eae,'counted_at':_0x475d8e});}if(_0x392d2a>0x0){sequelize_utils_1[a72_0x1427('0x7')][a72_0x1427('0x12')]['passCountingsModel'][a72_0x1427('0x2d')]({'amount':_0x392d2a*-0x1,'counted_at':_0x475d8e});}}_0x3b555c[a72_0x1427('0x21')]=0x2;}catch(_0x3c8322){_0x3b555c['status']=null;}}_0x3b555c['save']();});}else{_0x3b555c[a72_0x1427('0x21')]=null;_0x3b555c[a72_0x1427('0x22')]();}}else{_0x3b555c[a72_0x1427('0x21')]=null;_0x3b555c[a72_0x1427('0x22')]();}}else{}});_0x5569ec[a72_0x1427('0x10')]({'data':[]});}[a72_0x1427('0x2e')](_0x421dbf,_0x2d48ee,_0x36da19){const _0x350ab0=require('zlib');const _0x4ef6ca=_0x421dbf['file'][a72_0x1427('0x2f')];const _0x57bc39=UPLOAD_PATH+'/'+_0x421dbf[a72_0x1427('0x30')][a72_0x1427('0x31')]+'.json';const _0x399175=fs_1[a72_0x1427('0x7')][a72_0x1427('0x32')](_0x4ef6ca);const _0x374ebd=fs_1[a72_0x1427('0x7')][a72_0x1427('0x20')](_0x57bc39);const _0x57e979=_0x350ab0[a72_0x1427('0x33')]();console[a72_0x1427('0xb')](_0x421dbf[a72_0x1427('0x30')]);_0x399175[a72_0x1427('0x34')](_0x57e979)[a72_0x1427('0x34')](_0x374ebd)['on'](a72_0x1427('0x35'),_0x1f527d=>{if(_0x1f527d)return console['error'](_0x1f527d);else{const _0x385481=fs_1[a72_0x1427('0x7')][a72_0x1427('0x36')](_0x4ef6ca);const _0x523b9e=_0x385481['size'];if(_0x523b9e>0x0){fs_1[a72_0x1427('0x7')]['readFile'](_0x57bc39,a72_0x1427('0x27'),function(_0x1f527d,_0x3b732c){if(_0x1f527d){return console['error'](_0x1f527d);}else{try{const _0x20d887=JSON[a72_0x1427('0x28')](_0x3b732c);console[a72_0x1427('0xb')](_0x20d887);const _0x29d0ac=_0x20d887[a72_0x1427('0x37')][0x0][a72_0x1427('0x38')];const _0x1edc53=_0x20d887[a72_0x1427('0x37')][0x0][a72_0x1427('0x39')];const _0x2e1409=moment_1['default'](_0x29d0ac+'\x20'+_0x1edc53+a72_0x1427('0x3a'),a72_0x1427('0x3b'));const _0x1ff8a9=parseFloat(_0x20d887[a72_0x1427('0x37')][0x0][a72_0x1427('0x3c')][a72_0x1427('0x3d')](',','.'));const _0x3d7f1c=parseFloat(_0x20d887[a72_0x1427('0x37')][0x0][a72_0x1427('0x3e')]['replace'](',','.'));const _0x2c6b7e=_0x20d887[a72_0x1427('0x37')][0x0][a72_0x1427('0x3f')];const _0x2b237a=_0x20d887[a72_0x1427('0x37')][0x0][a72_0x1427('0x40')][0x0][a72_0x1427('0x41')];const _0x131276=_0x20d887[a72_0x1427('0x37')][0x0][a72_0x1427('0x40')][0x0][a72_0x1427('0x42')];console[a72_0x1427('0xb')](_0x1ff8a9);console[a72_0x1427('0xb')](_0x3d7f1c);console[a72_0x1427('0xb')](_0x2c6b7e);console[a72_0x1427('0xb')](_0x2b237a);console[a72_0x1427('0xb')](_0x131276);console[a72_0x1427('0xb')](_0x2e1409);if(_0x2b237a>0x0){sequelize_utils_1[a72_0x1427('0x7')]['models'][a72_0x1427('0x2c')][a72_0x1427('0x2d')]({'amount':_0x2b237a,'counted_at':_0x2e1409});}sequelize_utils_1['default'][a72_0x1427('0x12')][a72_0x1427('0x43')][a72_0x1427('0x2d')]({'device_id':null,'lat':''+_0x1ff8a9,'lon':''+_0x3d7f1c,'tracked_at':_0x2e1409});}catch(_0x31c072){return console[a72_0x1427('0x14')](_0x31c072);}}});}}});_0x2d48ee[a72_0x1427('0x10')]({'status':0x1,'data':_0x421dbf[a72_0x1427('0x30')]});}}exports[a72_0x1427('0x7')]=SyncFilesController;