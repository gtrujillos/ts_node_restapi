var a72_0x125f=['colombia/','end','media/','status','save','Downloaded:\x20','ipd','findOne','.txt','statSync','readFile','utf8','parse','Data','CountingInfo','passCountingsModel','create','uploadEvent','path','file','filename','createReadStream','createWriteStream','createGunzip','pipe','finish','eventos','fecha','latitud','replace','puerta','ingresos','salidas','locationPointsModel','__esModule','defineProperty','ftp','../../infrastructure/controller-utils','../../infrastructure/sequelize-utils','moment','media','syncFtp','bind','downloadFtp','processFtp','log','connecting','default','ready','list','colombia','json','size','findOrCreate','name','spread','push','error','connect','ftp.vivotek.com','models','syncFilesModel','then','connected:','file_name','get'];(function(_0x28f4f3,_0x32fe98){var _0x3901ae=function(_0x3c0539){while(--_0x3c0539){_0x28f4f3['push'](_0x28f4f3['shift']());}};_0x3901ae(++_0x32fe98);}(a72_0x125f,0xe8));var a72_0x25d3=function(_0x385505,_0x545946){_0x385505=_0x385505-0x0;var _0x5ef1bd=a72_0x125f[_0x385505];return _0x5ef1bd;};'use strict';var __importDefault=this&&this['__importDefault']||function(_0x4cbd6e){return _0x4cbd6e&&_0x4cbd6e[a72_0x25d3('0x0')]?_0x4cbd6e:{'default':_0x4cbd6e};};Object[a72_0x25d3('0x1')](exports,a72_0x25d3('0x0'),{'value':!![]});const ftp_1=__importDefault(require(a72_0x25d3('0x2')));const fs_1=__importDefault(require('fs'));const controller_utils_1=__importDefault(require(a72_0x25d3('0x3')));const sequelize_utils_1=__importDefault(require(a72_0x25d3('0x4')));const moment_1=__importDefault(require(a72_0x25d3('0x5')));const UPLOAD_PATH=a72_0x25d3('0x6');class SyncFilesController extends controller_utils_1['default']{constructor(_0x3e2141){super(_0x3e2141,null);this['syncFtp']=this[a72_0x25d3('0x7')][a72_0x25d3('0x8')](this);this[a72_0x25d3('0x9')]=this['downloadFtp'][a72_0x25d3('0x8')](this);this[a72_0x25d3('0xa')]=this['processFtp'][a72_0x25d3('0x8')](this);}[a72_0x25d3('0x7')](_0x4401b0,_0x47a449,_0x31462b){console[a72_0x25d3('0xb')](a72_0x25d3('0xc'));const _0x19aa17=[];const _0x5d1377=new ftp_1[(a72_0x25d3('0xd'))]();_0x5d1377['on'](a72_0x25d3('0xe'),function(){console['log']('connected');_0x5d1377[a72_0x25d3('0xf')](a72_0x25d3('0x10'),![],function(_0x2cbd08,_0x42f7c1){if(_0x2cbd08){console['log'](_0x2cbd08);}else{for(const _0x28efb3 of _0x42f7c1){if(_0x28efb3['name']['endsWith'](a72_0x25d3('0x11'))&&_0x28efb3[a72_0x25d3('0x12')]>0x0){sequelize_utils_1[a72_0x25d3('0xd')]['models']['syncFilesModel'][a72_0x25d3('0x13')]({'where':{'file_name':_0x28efb3[a72_0x25d3('0x14')]}})[a72_0x25d3('0x15')]((_0x42e17e,_0x41fc89)=>{if(_0x41fc89){_0x19aa17[a72_0x25d3('0x16')](_0x42e17e);}});}}}});});_0x5d1377['on'](a72_0x25d3('0x17'),function(_0x45f35a){});_0x5d1377[a72_0x25d3('0x18')]({'host':a72_0x25d3('0x19'),'port':0x15,'user':'ipd','password':'ipd'});_0x47a449[a72_0x25d3('0x11')]({'data':[]});}[a72_0x25d3('0x9')](_0x43ee40,_0x291d9d,_0x341d5f){sequelize_utils_1[a72_0x25d3('0xd')][a72_0x25d3('0x1a')][a72_0x25d3('0x1b')]['findOne']({'where':{'status':null}})[a72_0x25d3('0x1c')](_0x18bb34=>{if(_0x18bb34){const _0x50b015=new ftp_1[(a72_0x25d3('0xd'))]();_0x50b015['on'](a72_0x25d3('0xe'),function(){console['log'](a72_0x25d3('0x1d')+_0x18bb34[a72_0x25d3('0x1e')]);_0x50b015[a72_0x25d3('0x1f')](a72_0x25d3('0x20')+_0x18bb34[a72_0x25d3('0x1e')],function(_0x18363b,_0x31ad30){_0x50b015[a72_0x25d3('0x21')]();if(_0x18363b){}else{const _0x3deefb=a72_0x25d3('0x22')+_0x18bb34[a72_0x25d3('0x1e')]+'.txt';_0x31ad30['pipe'](fs_1[a72_0x25d3('0xd')]['createWriteStream'](_0x3deefb));_0x18bb34[a72_0x25d3('0x23')]=0x1;_0x18bb34[a72_0x25d3('0x24')]();console[a72_0x25d3('0xb')](a72_0x25d3('0x25')+_0x18bb34['fileName']);}});});_0x50b015['on'](a72_0x25d3('0x17'),function(_0x276060){});_0x50b015[a72_0x25d3('0x18')]({'host':a72_0x25d3('0x19'),'port':0x15,'user':a72_0x25d3('0x26'),'password':a72_0x25d3('0x26')});}else{}});_0x291d9d['json']({'data':[]});}[a72_0x25d3('0xa')](_0x25aa3e,_0x46380e,_0xdac64b){sequelize_utils_1[a72_0x25d3('0xd')]['models'][a72_0x25d3('0x1b')][a72_0x25d3('0x27')]({'where':{'status':0x1}})[a72_0x25d3('0x1c')](_0x4f8f24=>{if(_0x4f8f24){const _0x31de81=a72_0x25d3('0x22')+_0x4f8f24[a72_0x25d3('0x1e')]+a72_0x25d3('0x28');if(fs_1[a72_0x25d3('0xd')]['existsSync'](_0x31de81)){const _0x599e5c=fs_1[a72_0x25d3('0xd')][a72_0x25d3('0x29')](_0x31de81);const _0x3b3ab0=_0x599e5c['size'];console[a72_0x25d3('0xb')]('fileName:\x20'+_0x31de81);console[a72_0x25d3('0xb')]('fileSizeInBytes:\x20'+_0x3b3ab0);if(_0x3b3ab0>0x0){fs_1[a72_0x25d3('0xd')][a72_0x25d3('0x2a')](_0x31de81,a72_0x25d3('0x2b'),function(_0x3af7cb,_0xd838ba){if(_0x3af7cb){_0x4f8f24[a72_0x25d3('0x23')]=null;}else{try{const _0x5dfab5=JSON[a72_0x25d3('0x2c')](_0xd838ba);for(const _0x2f5c89 of _0x5dfab5[a72_0x25d3('0x2d')][0x0][a72_0x25d3('0x2e')]){const _0x505d8e=_0x2f5c89['In'];const _0x41f85e=_0x2f5c89['Out'];const _0x1bb722=Date['parse'](_0x2f5c89['EndTime']);if(_0x505d8e>0x0){sequelize_utils_1[a72_0x25d3('0xd')][a72_0x25d3('0x1a')][a72_0x25d3('0x2f')][a72_0x25d3('0x30')]({'amount':_0x505d8e,'counted_at':_0x1bb722});}if(_0x41f85e>0x0){sequelize_utils_1['default'][a72_0x25d3('0x1a')]['passCountingsModel']['create']({'amount':_0x41f85e*-0x1,'counted_at':_0x1bb722});}}_0x4f8f24['status']=0x2;}catch(_0x2872e1){_0x4f8f24[a72_0x25d3('0x23')]=null;}}_0x4f8f24[a72_0x25d3('0x24')]();});}else{_0x4f8f24['status']=null;_0x4f8f24[a72_0x25d3('0x24')]();}}else{_0x4f8f24[a72_0x25d3('0x23')]=null;_0x4f8f24[a72_0x25d3('0x24')]();}}else{}});_0x46380e['json']({'data':[]});}[a72_0x25d3('0x31')](_0x3ad585,_0xf2e6b7,_0x4319d5){const _0x52c3b8=require('zlib');const _0x5aa2f3=_0x3ad585['file'][a72_0x25d3('0x32')];const _0x377139=UPLOAD_PATH+'/'+_0x3ad585[a72_0x25d3('0x33')][a72_0x25d3('0x34')]+'.json';const _0x2ea2ed=fs_1[a72_0x25d3('0xd')][a72_0x25d3('0x35')](_0x5aa2f3);const _0x4c7824=fs_1[a72_0x25d3('0xd')][a72_0x25d3('0x36')](_0x377139);const _0xbae10a=_0x52c3b8[a72_0x25d3('0x37')]();console[a72_0x25d3('0xb')](_0x3ad585[a72_0x25d3('0x33')]);_0x2ea2ed[a72_0x25d3('0x38')](_0xbae10a)[a72_0x25d3('0x38')](_0x4c7824)['on'](a72_0x25d3('0x39'),_0x5f00ed=>{if(_0x5f00ed)return console[a72_0x25d3('0x17')](_0x5f00ed);else{const _0x4a7cc4=fs_1[a72_0x25d3('0xd')][a72_0x25d3('0x29')](_0x5aa2f3);const _0x4e1d00=_0x4a7cc4[a72_0x25d3('0x12')];if(_0x4e1d00>0x0){fs_1[a72_0x25d3('0xd')][a72_0x25d3('0x2a')](_0x377139,'utf8',function(_0x5f00ed,_0x3f2b13){if(_0x5f00ed){return console['error'](_0x5f00ed);}else{try{const _0x308041=JSON[a72_0x25d3('0x2c')](_0x3f2b13);console['log'](_0x308041);const _0x5cc088=_0x308041[a72_0x25d3('0x3a')][0x0][a72_0x25d3('0x3b')];const _0x3c4d5d=_0x308041[a72_0x25d3('0x3a')][0x0]['hora'];const _0x38f25a=moment_1[a72_0x25d3('0xd')](_0x5cc088+'\x20'+_0x3c4d5d+'\x20-05:00','YYYYMMDD\x20HHmmss\x20Z');const _0x9af922=parseFloat(_0x308041[a72_0x25d3('0x3a')][0x0][a72_0x25d3('0x3c')][a72_0x25d3('0x3d')](',','.'));const _0x11465f=parseFloat(_0x308041[a72_0x25d3('0x3a')][0x0]['longitud'][a72_0x25d3('0x3d')](',','.'));const _0x17f0ad=_0x308041[a72_0x25d3('0x3a')][0x0]['velocidad'];const _0x3216aa=_0x308041[a72_0x25d3('0x3a')][0x0][a72_0x25d3('0x3e')][0x0][a72_0x25d3('0x3f')];const _0x3d0667=_0x308041[a72_0x25d3('0x3a')][0x0][a72_0x25d3('0x3e')][0x0][a72_0x25d3('0x40')];console[a72_0x25d3('0xb')](_0x9af922);console['log'](_0x11465f);console[a72_0x25d3('0xb')](_0x17f0ad);console['log'](_0x3216aa);console[a72_0x25d3('0xb')](_0x3d0667);console[a72_0x25d3('0xb')](_0x38f25a);if(_0x3216aa>0x0){sequelize_utils_1[a72_0x25d3('0xd')]['models'][a72_0x25d3('0x2f')][a72_0x25d3('0x30')]({'amount':_0x3216aa,'counted_at':_0x38f25a});}sequelize_utils_1['default'][a72_0x25d3('0x1a')][a72_0x25d3('0x41')]['create']({'device_id':null,'lat':''+_0x9af922,'lon':''+_0x11465f,'tracked_at':_0x38f25a});}catch(_0x2158a2){return console[a72_0x25d3('0x17')](_0x2158a2);}}});}}});_0xf2e6b7[a72_0x25d3('0x11')]({'status':0x1,'data':_0x3ad585['file']});}}exports['default']=SyncFilesController;