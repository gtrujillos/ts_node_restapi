var a66_0x38d4=['colombia','name','endsWith','json','size','models','syncFilesModel','findOrCreate','spread','error','connect','ipd','findOne','connected:','file_name','end','media/','.txt','pipe','createWriteStream','status','save','Downloaded:\x20','ftp.vivotek.com','then','statSync','fileName:\x20','fileSizeInBytes:\x20','readFile','utf8','Data','CountingInfo','Out','parse','create','passCountingsModel','uploadEvent','path','file','filename','.json','createReadStream','eventos','hora','YYYYMMDD\x20HHmmss\x20Z','latitud','longitud','replace','velocidad','puerta','ingresos','locationPointsModel','__importDefault','__esModule','defineProperty','ftp','../../infrastructure/sequelize-utils','media','default','syncFtp','bind','downloadFtp','processFtp','log','connecting','ready'];(function(_0x12df45,_0x561ac7){var _0x246e8b=function(_0x28fbab){while(--_0x28fbab){_0x12df45['push'](_0x12df45['shift']());}};_0x246e8b(++_0x561ac7);}(a66_0x38d4,0x1c0));var a66_0x1219=function(_0x166fa3,_0x111382){_0x166fa3=_0x166fa3-0x0;var _0x32f289=a66_0x38d4[_0x166fa3];return _0x32f289;};'use strict';var __importDefault=this&&this[a66_0x1219('0x0')]||function(_0x562e13){return _0x562e13&&_0x562e13[a66_0x1219('0x1')]?_0x562e13:{'default':_0x562e13};};Object[a66_0x1219('0x2')](exports,a66_0x1219('0x1'),{'value':!![]});const ftp_1=__importDefault(require(a66_0x1219('0x3')));const fs_1=__importDefault(require('fs'));const base_controller_1=__importDefault(require('../../infrastructure/base-controller'));const sequelize_utils_1=__importDefault(require(a66_0x1219('0x4')));const moment_1=__importDefault(require('moment'));const UPLOAD_PATH=a66_0x1219('0x5');class SyncFilesController extends base_controller_1[a66_0x1219('0x6')]{constructor(_0x9cb5ec){super(_0x9cb5ec,null);this[a66_0x1219('0x7')]=this['syncFtp'][a66_0x1219('0x8')](this);this['downloadFtp']=this[a66_0x1219('0x9')][a66_0x1219('0x8')](this);this[a66_0x1219('0xa')]=this[a66_0x1219('0xa')][a66_0x1219('0x8')](this);}[a66_0x1219('0x7')](_0x6adf1,_0x586995,_0x4f4e06){console[a66_0x1219('0xb')](a66_0x1219('0xc'));const _0x28bd32=[];const _0x2c4c6f=new ftp_1[(a66_0x1219('0x6'))]();_0x2c4c6f['on'](a66_0x1219('0xd'),function(){console[a66_0x1219('0xb')]('connected');_0x2c4c6f['list'](a66_0x1219('0xe'),![],function(_0x4b4ae2,_0xade066){if(_0x4b4ae2){console[a66_0x1219('0xb')](_0x4b4ae2);}else{for(const _0x5bff28 of _0xade066){if(_0x5bff28[a66_0x1219('0xf')][a66_0x1219('0x10')](a66_0x1219('0x11'))&&_0x5bff28[a66_0x1219('0x12')]>0x0){sequelize_utils_1[a66_0x1219('0x6')][a66_0x1219('0x13')][a66_0x1219('0x14')][a66_0x1219('0x15')]({'where':{'file_name':_0x5bff28[a66_0x1219('0xf')]}})[a66_0x1219('0x16')]((_0x49b87d,_0x3dbc1c)=>{if(_0x3dbc1c){_0x28bd32['push'](_0x49b87d);}});}}}});});_0x2c4c6f['on'](a66_0x1219('0x17'),function(_0x198301){});_0x2c4c6f[a66_0x1219('0x18')]({'host':'ftp.vivotek.com','port':0x15,'user':'ipd','password':a66_0x1219('0x19')});_0x586995['json']({'data':[]});}[a66_0x1219('0x9')](_0x323979,_0x5b2a50,_0x5dc2cc){sequelize_utils_1[a66_0x1219('0x6')]['models'][a66_0x1219('0x14')][a66_0x1219('0x1a')]({'where':{'status':null}})['then'](_0x134303=>{if(_0x134303){const _0x213264=new ftp_1[(a66_0x1219('0x6'))]();_0x213264['on'](a66_0x1219('0xd'),function(){console[a66_0x1219('0xb')](a66_0x1219('0x1b')+_0x134303[a66_0x1219('0x1c')]);_0x213264['get']('colombia/'+_0x134303[a66_0x1219('0x1c')],function(_0x5111ea,_0x2fed22){_0x213264[a66_0x1219('0x1d')]();if(_0x5111ea){}else{const _0x130644=a66_0x1219('0x1e')+_0x134303['file_name']+a66_0x1219('0x1f');_0x2fed22[a66_0x1219('0x20')](fs_1['default'][a66_0x1219('0x21')](_0x130644));_0x134303[a66_0x1219('0x22')]=0x1;_0x134303[a66_0x1219('0x23')]();console['log'](a66_0x1219('0x24')+_0x134303['fileName']);}});});_0x213264['on'](a66_0x1219('0x17'),function(_0x7e6233){});_0x213264[a66_0x1219('0x18')]({'host':a66_0x1219('0x25'),'port':0x15,'user':a66_0x1219('0x19'),'password':a66_0x1219('0x19')});}else{}});_0x5b2a50[a66_0x1219('0x11')]({'data':[]});}['processFtp'](_0x85128b,_0x2f71ad,_0x2809a4){sequelize_utils_1[a66_0x1219('0x6')][a66_0x1219('0x13')][a66_0x1219('0x14')][a66_0x1219('0x1a')]({'where':{'status':0x1}})[a66_0x1219('0x26')](_0x9b00a8=>{if(_0x9b00a8){const _0x2208ee=a66_0x1219('0x1e')+_0x9b00a8[a66_0x1219('0x1c')]+'.txt';if(fs_1['default']['existsSync'](_0x2208ee)){const _0x1bae57=fs_1[a66_0x1219('0x6')][a66_0x1219('0x27')](_0x2208ee);const _0x2c08d7=_0x1bae57[a66_0x1219('0x12')];console[a66_0x1219('0xb')](a66_0x1219('0x28')+_0x2208ee);console[a66_0x1219('0xb')](a66_0x1219('0x29')+_0x2c08d7);if(_0x2c08d7>0x0){fs_1[a66_0x1219('0x6')][a66_0x1219('0x2a')](_0x2208ee,a66_0x1219('0x2b'),function(_0x195878,_0x3ab4e7){if(_0x195878){_0x9b00a8[a66_0x1219('0x22')]=null;}else{try{const _0xae9af5=JSON['parse'](_0x3ab4e7);for(const _0x32ca2f of _0xae9af5[a66_0x1219('0x2c')][0x0][a66_0x1219('0x2d')]){const _0x2fc25a=_0x32ca2f['In'];const _0x245774=_0x32ca2f[a66_0x1219('0x2e')];const _0xdfc8f6=Date[a66_0x1219('0x2f')](_0x32ca2f['EndTime']);if(_0x2fc25a>0x0){sequelize_utils_1['default'][a66_0x1219('0x13')]['passCountingsModel'][a66_0x1219('0x30')]({'amount':_0x2fc25a,'counted_at':_0xdfc8f6});}if(_0x245774>0x0){sequelize_utils_1[a66_0x1219('0x6')][a66_0x1219('0x13')][a66_0x1219('0x31')][a66_0x1219('0x30')]({'amount':_0x245774*-0x1,'counted_at':_0xdfc8f6});}}_0x9b00a8[a66_0x1219('0x22')]=0x2;}catch(_0x30804e){_0x9b00a8['status']=null;}}_0x9b00a8[a66_0x1219('0x23')]();});}else{_0x9b00a8[a66_0x1219('0x22')]=null;_0x9b00a8[a66_0x1219('0x23')]();}}else{_0x9b00a8[a66_0x1219('0x22')]=null;_0x9b00a8[a66_0x1219('0x23')]();}}else{}});_0x2f71ad[a66_0x1219('0x11')]({'data':[]});}[a66_0x1219('0x32')](_0x121b5d,_0x4ed5a2,_0x31ec50){const _0x2f3a8a=require('zlib');const _0x38b175=_0x121b5d['file'][a66_0x1219('0x33')];const _0x2583b5=UPLOAD_PATH+'/'+_0x121b5d[a66_0x1219('0x34')][a66_0x1219('0x35')]+a66_0x1219('0x36');const _0x1d6546=fs_1['default'][a66_0x1219('0x37')](_0x38b175);const _0x468a8f=fs_1[a66_0x1219('0x6')]['createWriteStream'](_0x2583b5);const _0x119d5c=_0x2f3a8a['createGunzip']();console[a66_0x1219('0xb')](_0x121b5d[a66_0x1219('0x34')]);_0x1d6546[a66_0x1219('0x20')](_0x119d5c)[a66_0x1219('0x20')](_0x468a8f)['on']('finish',_0x57d6b7=>{if(_0x57d6b7)return console[a66_0x1219('0x17')](_0x57d6b7);else{const _0x25324b=fs_1[a66_0x1219('0x6')]['statSync'](_0x38b175);const _0x2fef9a=_0x25324b[a66_0x1219('0x12')];if(_0x2fef9a>0x0){fs_1[a66_0x1219('0x6')][a66_0x1219('0x2a')](_0x2583b5,a66_0x1219('0x2b'),function(_0x57d6b7,_0x2530d5){if(_0x57d6b7){return console[a66_0x1219('0x17')](_0x57d6b7);}else{try{const _0x4b7133=JSON[a66_0x1219('0x2f')](_0x2530d5);console[a66_0x1219('0xb')](_0x4b7133);const _0x49d8fe=_0x4b7133['eventos'][0x0]['fecha'];const _0x3190de=_0x4b7133[a66_0x1219('0x38')][0x0][a66_0x1219('0x39')];const _0xc34ed3=moment_1[a66_0x1219('0x6')](_0x49d8fe+'\x20'+_0x3190de+'\x20-05:00',a66_0x1219('0x3a'));const _0x3be2a7=parseFloat(_0x4b7133[a66_0x1219('0x38')][0x0][a66_0x1219('0x3b')]['replace'](',','.'));const _0x4790c7=parseFloat(_0x4b7133['eventos'][0x0][a66_0x1219('0x3c')][a66_0x1219('0x3d')](',','.'));const _0x2ebeb6=_0x4b7133[a66_0x1219('0x38')][0x0][a66_0x1219('0x3e')];const _0x43c39a=_0x4b7133[a66_0x1219('0x38')][0x0][a66_0x1219('0x3f')][0x0][a66_0x1219('0x40')];const _0x25c2ea=_0x4b7133[a66_0x1219('0x38')][0x0][a66_0x1219('0x3f')][0x0]['salidas'];console[a66_0x1219('0xb')](_0x3be2a7);console[a66_0x1219('0xb')](_0x4790c7);console[a66_0x1219('0xb')](_0x2ebeb6);console[a66_0x1219('0xb')](_0x43c39a);console[a66_0x1219('0xb')](_0x25c2ea);console[a66_0x1219('0xb')](_0xc34ed3);if(_0x43c39a>0x0){sequelize_utils_1[a66_0x1219('0x6')][a66_0x1219('0x13')][a66_0x1219('0x31')]['create']({'amount':_0x43c39a,'counted_at':_0xc34ed3});}sequelize_utils_1[a66_0x1219('0x6')]['models'][a66_0x1219('0x41')][a66_0x1219('0x30')]({'device_id':null,'lat':''+_0x3be2a7,'lon':''+_0x4790c7,'tracked_at':_0xc34ed3});}catch(_0x2f1a73){return console[a66_0x1219('0x17')](_0x2f1a73);}}});}}});_0x4ed5a2[a66_0x1219('0x11')]({'status':0x1,'data':_0x121b5d['file']});}}exports[a66_0x1219('0x6')]=SyncFilesController;