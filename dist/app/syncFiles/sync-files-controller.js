var a205_0x4031=['log','ready','list','colombia','name','json','size','models','findOrCreate','spread','error','ipd','syncFilesModel','findOne','then','connected:','end','media/','pipe','createWriteStream','save','fileName','connect','ftp.vivotek.com','file_name','existsSync','statSync','fileName:\x20','fileSizeInBytes:\x20','readFile','parse','Data','Out','EndTime','passCountingsModel','create','status','uploadEvent','zlib','filename','.json','createReadStream','createGunzip','utf8','eventos','fecha','YYYYMMDD\x20HHmmss\x20Z','latitud','replace','longitud','velocidad','puerta','ingresos','salidas','locationPointsModel','file','__importDefault','__esModule','defineProperty','ftp','../../infrastructure/base-controller','../../infrastructure/sequelize-utils','moment','media','default','syncFtp','bind','downloadFtp','processFtp'];(function(_0x550693,_0x6e4d9a){var _0x282084=function(_0x5513ce){while(--_0x5513ce){_0x550693['push'](_0x550693['shift']());}};_0x282084(++_0x6e4d9a);}(a205_0x4031,0x107));var a205_0x13d5=function(_0x930c75,_0x45d80f){_0x930c75=_0x930c75-0x0;var _0x32511f=a205_0x4031[_0x930c75];return _0x32511f;};'use strict';var __importDefault=this&&this[a205_0x13d5('0x0')]||function(_0x27ee7a){return _0x27ee7a&&_0x27ee7a[a205_0x13d5('0x1')]?_0x27ee7a:{'default':_0x27ee7a};};Object[a205_0x13d5('0x2')](exports,'__esModule',{'value':!![]});const ftp_1=__importDefault(require(a205_0x13d5('0x3')));const fs_1=__importDefault(require('fs'));const base_controller_1=__importDefault(require(a205_0x13d5('0x4')));const sequelize_utils_1=__importDefault(require(a205_0x13d5('0x5')));const moment_1=__importDefault(require(a205_0x13d5('0x6')));const UPLOAD_PATH=a205_0x13d5('0x7');class SyncFilesController extends base_controller_1[a205_0x13d5('0x8')]{constructor(_0x3df5dd){super(_0x3df5dd,null);this[a205_0x13d5('0x9')]=this[a205_0x13d5('0x9')][a205_0x13d5('0xa')](this);this[a205_0x13d5('0xb')]=this[a205_0x13d5('0xb')]['bind'](this);this[a205_0x13d5('0xc')]=this[a205_0x13d5('0xc')][a205_0x13d5('0xa')](this);}['syncFtp'](_0x298492,_0x43e3a9,_0x699f43){console[a205_0x13d5('0xd')]('connecting');const _0x3d8249=[];const _0x19c845=new ftp_1[(a205_0x13d5('0x8'))]();_0x19c845['on'](a205_0x13d5('0xe'),function(){console[a205_0x13d5('0xd')]('connected');_0x19c845[a205_0x13d5('0xf')](a205_0x13d5('0x10'),![],function(_0x52755a,_0x5ab482){if(_0x52755a){console[a205_0x13d5('0xd')](_0x52755a);}else{for(const _0x1be9e2 of _0x5ab482){if(_0x1be9e2[a205_0x13d5('0x11')]['endsWith'](a205_0x13d5('0x12'))&&_0x1be9e2[a205_0x13d5('0x13')]>0x0){sequelize_utils_1[a205_0x13d5('0x8')][a205_0x13d5('0x14')]['syncFilesModel'][a205_0x13d5('0x15')]({'where':{'file_name':_0x1be9e2[a205_0x13d5('0x11')]}})[a205_0x13d5('0x16')]((_0x31a8be,_0xc4e3d3)=>{if(_0xc4e3d3){_0x3d8249['push'](_0x31a8be);}});}}}});});_0x19c845['on'](a205_0x13d5('0x17'),function(_0x133913){});_0x19c845['connect']({'host':'ftp.vivotek.com','port':0x15,'user':a205_0x13d5('0x18'),'password':'ipd'});_0x43e3a9[a205_0x13d5('0x12')]({'data':[]});}['downloadFtp'](_0x26af47,_0x57e273,_0x4419b6){sequelize_utils_1[a205_0x13d5('0x8')]['models'][a205_0x13d5('0x19')][a205_0x13d5('0x1a')]({'where':{'status':null}})[a205_0x13d5('0x1b')](_0x523603=>{if(_0x523603){const _0x50509a=new ftp_1['default']();_0x50509a['on']('ready',function(){console[a205_0x13d5('0xd')](a205_0x13d5('0x1c')+_0x523603['file_name']);_0x50509a['get']('colombia/'+_0x523603['file_name'],function(_0x17f120,_0x5e5dcc){_0x50509a[a205_0x13d5('0x1d')]();if(_0x17f120){}else{const _0x1181b3=a205_0x13d5('0x1e')+_0x523603['file_name']+'.txt';_0x5e5dcc[a205_0x13d5('0x1f')](fs_1[a205_0x13d5('0x8')][a205_0x13d5('0x20')](_0x1181b3));_0x523603['status']=0x1;_0x523603[a205_0x13d5('0x21')]();console['log']('Downloaded:\x20'+_0x523603[a205_0x13d5('0x22')]);}});});_0x50509a['on']('error',function(_0x178324){});_0x50509a[a205_0x13d5('0x23')]({'host':a205_0x13d5('0x24'),'port':0x15,'user':'ipd','password':a205_0x13d5('0x18')});}else{}});_0x57e273[a205_0x13d5('0x12')]({'data':[]});}[a205_0x13d5('0xc')](_0x42b9c3,_0x228aff,_0x3fc73e){sequelize_utils_1['default'][a205_0x13d5('0x14')][a205_0x13d5('0x19')][a205_0x13d5('0x1a')]({'where':{'status':0x1}})[a205_0x13d5('0x1b')](_0x292b96=>{if(_0x292b96){const _0x3dd9d9=a205_0x13d5('0x1e')+_0x292b96[a205_0x13d5('0x25')]+'.txt';if(fs_1[a205_0x13d5('0x8')][a205_0x13d5('0x26')](_0x3dd9d9)){const _0x7c56c0=fs_1[a205_0x13d5('0x8')][a205_0x13d5('0x27')](_0x3dd9d9);const _0x2d1597=_0x7c56c0[a205_0x13d5('0x13')];console['log'](a205_0x13d5('0x28')+_0x3dd9d9);console[a205_0x13d5('0xd')](a205_0x13d5('0x29')+_0x2d1597);if(_0x2d1597>0x0){fs_1[a205_0x13d5('0x8')][a205_0x13d5('0x2a')](_0x3dd9d9,'utf8',function(_0x19a2d9,_0x93fc93){if(_0x19a2d9){_0x292b96['status']=null;}else{try{const _0x26a3f1=JSON[a205_0x13d5('0x2b')](_0x93fc93);for(const _0x519cc2 of _0x26a3f1[a205_0x13d5('0x2c')][0x0]['CountingInfo']){const _0x1ef963=_0x519cc2['In'];const _0x5f0bce=_0x519cc2[a205_0x13d5('0x2d')];const _0x273785=Date[a205_0x13d5('0x2b')](_0x519cc2[a205_0x13d5('0x2e')]);if(_0x1ef963>0x0){sequelize_utils_1['default'][a205_0x13d5('0x14')][a205_0x13d5('0x2f')][a205_0x13d5('0x30')]({'amount':_0x1ef963,'counted_at':_0x273785});}if(_0x5f0bce>0x0){sequelize_utils_1['default'][a205_0x13d5('0x14')]['passCountingsModel'][a205_0x13d5('0x30')]({'amount':_0x5f0bce*-0x1,'counted_at':_0x273785});}}_0x292b96['status']=0x2;}catch(_0xabd154){_0x292b96[a205_0x13d5('0x31')]=null;}}_0x292b96['save']();});}else{_0x292b96[a205_0x13d5('0x31')]=null;_0x292b96[a205_0x13d5('0x21')]();}}else{_0x292b96[a205_0x13d5('0x31')]=null;_0x292b96[a205_0x13d5('0x21')]();}}else{}});_0x228aff['json']({'data':[]});}[a205_0x13d5('0x32')](_0x4e25e3,_0x57aa29,_0x496f78){const _0x92f151=require(a205_0x13d5('0x33'));const _0x251a3c=_0x4e25e3['file']['path'];const _0x33cdca=UPLOAD_PATH+'/'+_0x4e25e3['file'][a205_0x13d5('0x34')]+a205_0x13d5('0x35');const _0x145f30=fs_1[a205_0x13d5('0x8')][a205_0x13d5('0x36')](_0x251a3c);const _0xf1b9c1=fs_1['default'][a205_0x13d5('0x20')](_0x33cdca);const _0x47f037=_0x92f151[a205_0x13d5('0x37')]();console[a205_0x13d5('0xd')](_0x4e25e3['file']);_0x145f30['pipe'](_0x47f037)['pipe'](_0xf1b9c1)['on']('finish',_0x462eeb=>{if(_0x462eeb)return console['error'](_0x462eeb);else{const _0x52dca0=fs_1['default']['statSync'](_0x251a3c);const _0x33086b=_0x52dca0['size'];if(_0x33086b>0x0){fs_1[a205_0x13d5('0x8')][a205_0x13d5('0x2a')](_0x33cdca,a205_0x13d5('0x38'),function(_0x462eeb,_0x4baf97){if(_0x462eeb){return console[a205_0x13d5('0x17')](_0x462eeb);}else{try{const _0x31783a=JSON['parse'](_0x4baf97);console['log'](_0x31783a);const _0x1aa879=_0x31783a[a205_0x13d5('0x39')][0x0][a205_0x13d5('0x3a')];const _0x2af8a9=_0x31783a[a205_0x13d5('0x39')][0x0]['hora'];const _0x486f1a=moment_1[a205_0x13d5('0x8')](_0x1aa879+'\x20'+_0x2af8a9+'\x20-05:00',a205_0x13d5('0x3b'));const _0x4c6a2d=parseFloat(_0x31783a['eventos'][0x0][a205_0x13d5('0x3c')][a205_0x13d5('0x3d')](',','.'));const _0x3ddb36=parseFloat(_0x31783a[a205_0x13d5('0x39')][0x0][a205_0x13d5('0x3e')][a205_0x13d5('0x3d')](',','.'));const _0x5c04ce=_0x31783a[a205_0x13d5('0x39')][0x0][a205_0x13d5('0x3f')];const _0x4ae49c=_0x31783a[a205_0x13d5('0x39')][0x0][a205_0x13d5('0x40')][0x0][a205_0x13d5('0x41')];const _0x501e79=_0x31783a[a205_0x13d5('0x39')][0x0]['puerta'][0x0][a205_0x13d5('0x42')];console[a205_0x13d5('0xd')](_0x4c6a2d);console['log'](_0x3ddb36);console[a205_0x13d5('0xd')](_0x5c04ce);console[a205_0x13d5('0xd')](_0x4ae49c);console[a205_0x13d5('0xd')](_0x501e79);console[a205_0x13d5('0xd')](_0x486f1a);if(_0x4ae49c>0x0){sequelize_utils_1[a205_0x13d5('0x8')][a205_0x13d5('0x14')][a205_0x13d5('0x2f')]['create']({'amount':_0x4ae49c,'counted_at':_0x486f1a});}sequelize_utils_1[a205_0x13d5('0x8')][a205_0x13d5('0x14')][a205_0x13d5('0x43')][a205_0x13d5('0x30')]({'device_id':null,'lat':''+_0x4c6a2d,'lon':''+_0x3ddb36,'tracked_at':_0x486f1a});}catch(_0x2c5fa8){return console[a205_0x13d5('0x17')](_0x2c5fa8);}}});}}});_0x57aa29[a205_0x13d5('0x12')]({'status':0x1,'data':_0x4e25e3[a205_0x13d5('0x44')]});}}exports[a205_0x13d5('0x8')]=SyncFilesController;