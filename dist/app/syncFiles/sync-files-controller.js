var a73_0x5a5b=['connecting','connected','name','endsWith','json','size','models','findOrCreate','spread','push','error','connect','ftp.vivotek.com','ipd','findOne','then','ready','connected:','get','file_name','end','media/','pipe','createWriteStream','status','save','Downloaded:\x20','fileName','syncFilesModel','existsSync','fileSizeInBytes:\x20','readFile','utf8','parse','CountingInfo','EndTime','passCountingsModel','create','zlib','path','file','filename','.json','createReadStream','finish','statSync','eventos','fecha','hora','\x20-05:00','YYYYMMDD\x20HHmmss\x20Z','longitud','velocidad','puerta','ingresos','salidas','locationPointsModel','__importDefault','__esModule','defineProperty','ftp','../../infrastructure/controller-utils','moment','media','default','syncFtp','bind','downloadFtp','processFtp','log'];(function(_0x36f81e,_0x239183){var _0x33bef2=function(_0x20b9b4){while(--_0x20b9b4){_0x36f81e['push'](_0x36f81e['shift']());}};_0x33bef2(++_0x239183);}(a73_0x5a5b,0x151));var a73_0x13cd=function(_0x24a786,_0x24d1c4){_0x24a786=_0x24a786-0x0;var _0x54072e=a73_0x5a5b[_0x24a786];return _0x54072e;};'use strict';var __importDefault=this&&this[a73_0x13cd('0x0')]||function(_0x3cf20a){return _0x3cf20a&&_0x3cf20a[a73_0x13cd('0x1')]?_0x3cf20a:{'default':_0x3cf20a};};Object[a73_0x13cd('0x2')](exports,'__esModule',{'value':!![]});const ftp_1=__importDefault(require(a73_0x13cd('0x3')));const fs_1=__importDefault(require('fs'));const controller_utils_1=__importDefault(require(a73_0x13cd('0x4')));const sequelize_utils_1=__importDefault(require('../../infrastructure/sequelize-utils'));const moment_1=__importDefault(require(a73_0x13cd('0x5')));const UPLOAD_PATH=a73_0x13cd('0x6');class SyncFilesController extends controller_utils_1[a73_0x13cd('0x7')]{constructor(_0x3b1bd0){super(_0x3b1bd0,null);this[a73_0x13cd('0x8')]=this['syncFtp'][a73_0x13cd('0x9')](this);this['downloadFtp']=this[a73_0x13cd('0xa')][a73_0x13cd('0x9')](this);this[a73_0x13cd('0xb')]=this['processFtp'][a73_0x13cd('0x9')](this);}['syncFtp'](_0x281f8e,_0x23599b,_0x1c7709){console[a73_0x13cd('0xc')](a73_0x13cd('0xd'));const _0x52a2f8=[];const _0x3d7fbe=new ftp_1[(a73_0x13cd('0x7'))]();_0x3d7fbe['on']('ready',function(){console['log'](a73_0x13cd('0xe'));_0x3d7fbe['list']('colombia',![],function(_0xef2185,_0x4f5a4a){if(_0xef2185){console[a73_0x13cd('0xc')](_0xef2185);}else{for(const _0x55d25d of _0x4f5a4a){if(_0x55d25d[a73_0x13cd('0xf')][a73_0x13cd('0x10')](a73_0x13cd('0x11'))&&_0x55d25d[a73_0x13cd('0x12')]>0x0){sequelize_utils_1[a73_0x13cd('0x7')][a73_0x13cd('0x13')]['syncFilesModel'][a73_0x13cd('0x14')]({'where':{'file_name':_0x55d25d[a73_0x13cd('0xf')]}})[a73_0x13cd('0x15')]((_0x336c5d,_0x1364be)=>{if(_0x1364be){_0x52a2f8[a73_0x13cd('0x16')](_0x336c5d);}});}}}});});_0x3d7fbe['on'](a73_0x13cd('0x17'),function(_0x4bd05f){});_0x3d7fbe[a73_0x13cd('0x18')]({'host':a73_0x13cd('0x19'),'port':0x15,'user':a73_0x13cd('0x1a'),'password':a73_0x13cd('0x1a')});_0x23599b['json']({'data':[]});}[a73_0x13cd('0xa')](_0x24666d,_0x5de9a7,_0x5d3d56){sequelize_utils_1['default']['models']['syncFilesModel'][a73_0x13cd('0x1b')]({'where':{'status':null}})[a73_0x13cd('0x1c')](_0x31a190=>{if(_0x31a190){const _0x701d04=new ftp_1[(a73_0x13cd('0x7'))]();_0x701d04['on'](a73_0x13cd('0x1d'),function(){console[a73_0x13cd('0xc')](a73_0x13cd('0x1e')+_0x31a190['file_name']);_0x701d04[a73_0x13cd('0x1f')]('colombia/'+_0x31a190[a73_0x13cd('0x20')],function(_0x5ae73b,_0x16c5e4){_0x701d04[a73_0x13cd('0x21')]();if(_0x5ae73b){}else{const _0x6fd39a=a73_0x13cd('0x22')+_0x31a190['file_name']+'.txt';_0x16c5e4[a73_0x13cd('0x23')](fs_1[a73_0x13cd('0x7')][a73_0x13cd('0x24')](_0x6fd39a));_0x31a190[a73_0x13cd('0x25')]=0x1;_0x31a190[a73_0x13cd('0x26')]();console[a73_0x13cd('0xc')](a73_0x13cd('0x27')+_0x31a190[a73_0x13cd('0x28')]);}});});_0x701d04['on'](a73_0x13cd('0x17'),function(_0x42a70e){});_0x701d04[a73_0x13cd('0x18')]({'host':a73_0x13cd('0x19'),'port':0x15,'user':a73_0x13cd('0x1a'),'password':a73_0x13cd('0x1a')});}else{}});_0x5de9a7[a73_0x13cd('0x11')]({'data':[]});}['processFtp'](_0x4ec834,_0x150992,_0x6cc7c4){sequelize_utils_1[a73_0x13cd('0x7')][a73_0x13cd('0x13')][a73_0x13cd('0x29')][a73_0x13cd('0x1b')]({'where':{'status':0x1}})[a73_0x13cd('0x1c')](_0x302205=>{if(_0x302205){const _0xd87198=a73_0x13cd('0x22')+_0x302205[a73_0x13cd('0x20')]+'.txt';if(fs_1['default'][a73_0x13cd('0x2a')](_0xd87198)){const _0x4cda7d=fs_1[a73_0x13cd('0x7')]['statSync'](_0xd87198);const _0x553fc5=_0x4cda7d[a73_0x13cd('0x12')];console[a73_0x13cd('0xc')]('fileName:\x20'+_0xd87198);console['log'](a73_0x13cd('0x2b')+_0x553fc5);if(_0x553fc5>0x0){fs_1[a73_0x13cd('0x7')][a73_0x13cd('0x2c')](_0xd87198,a73_0x13cd('0x2d'),function(_0x584d44,_0x540146){if(_0x584d44){_0x302205[a73_0x13cd('0x25')]=null;}else{try{const _0x44f9ad=JSON[a73_0x13cd('0x2e')](_0x540146);for(const _0x1332d2 of _0x44f9ad['Data'][0x0][a73_0x13cd('0x2f')]){const _0x3816b1=_0x1332d2['In'];const _0x5022e2=_0x1332d2['Out'];const _0x5a7aed=Date[a73_0x13cd('0x2e')](_0x1332d2[a73_0x13cd('0x30')]);if(_0x3816b1>0x0){sequelize_utils_1[a73_0x13cd('0x7')][a73_0x13cd('0x13')][a73_0x13cd('0x31')][a73_0x13cd('0x32')]({'amount':_0x3816b1,'counted_at':_0x5a7aed});}if(_0x5022e2>0x0){sequelize_utils_1[a73_0x13cd('0x7')][a73_0x13cd('0x13')][a73_0x13cd('0x31')][a73_0x13cd('0x32')]({'amount':_0x5022e2*-0x1,'counted_at':_0x5a7aed});}}_0x302205[a73_0x13cd('0x25')]=0x2;}catch(_0x23dc3f){_0x302205[a73_0x13cd('0x25')]=null;}}_0x302205[a73_0x13cd('0x26')]();});}else{_0x302205[a73_0x13cd('0x25')]=null;_0x302205['save']();}}else{_0x302205[a73_0x13cd('0x25')]=null;_0x302205[a73_0x13cd('0x26')]();}}else{}});_0x150992[a73_0x13cd('0x11')]({'data':[]});}['uploadEvent'](_0x43491f,_0x23de6d,_0x49a626){const _0x28961a=require(a73_0x13cd('0x33'));const _0x3d859b=_0x43491f['file'][a73_0x13cd('0x34')];const _0x19fa39=UPLOAD_PATH+'/'+_0x43491f[a73_0x13cd('0x35')][a73_0x13cd('0x36')]+a73_0x13cd('0x37');const _0x1f7d13=fs_1['default'][a73_0x13cd('0x38')](_0x3d859b);const _0x55f1d4=fs_1['default']['createWriteStream'](_0x19fa39);const _0xfbbb78=_0x28961a['createGunzip']();console[a73_0x13cd('0xc')](_0x43491f[a73_0x13cd('0x35')]);_0x1f7d13[a73_0x13cd('0x23')](_0xfbbb78)[a73_0x13cd('0x23')](_0x55f1d4)['on'](a73_0x13cd('0x39'),_0x36944d=>{if(_0x36944d)return console['error'](_0x36944d);else{const _0x59c48a=fs_1[a73_0x13cd('0x7')][a73_0x13cd('0x3a')](_0x3d859b);const _0x2bb14a=_0x59c48a[a73_0x13cd('0x12')];if(_0x2bb14a>0x0){fs_1[a73_0x13cd('0x7')]['readFile'](_0x19fa39,a73_0x13cd('0x2d'),function(_0x36944d,_0x58acb6){if(_0x36944d){return console[a73_0x13cd('0x17')](_0x36944d);}else{try{const _0x417f8a=JSON[a73_0x13cd('0x2e')](_0x58acb6);console['log'](_0x417f8a);const _0xda81a4=_0x417f8a[a73_0x13cd('0x3b')][0x0][a73_0x13cd('0x3c')];const _0x2cd46b=_0x417f8a[a73_0x13cd('0x3b')][0x0][a73_0x13cd('0x3d')];const _0x5f49d6=moment_1[a73_0x13cd('0x7')](_0xda81a4+'\x20'+_0x2cd46b+a73_0x13cd('0x3e'),a73_0x13cd('0x3f'));const _0x5cf766=parseFloat(_0x417f8a[a73_0x13cd('0x3b')][0x0]['latitud']['replace'](',','.'));const _0x1b801e=parseFloat(_0x417f8a[a73_0x13cd('0x3b')][0x0][a73_0x13cd('0x40')]['replace'](',','.'));const _0x57f699=_0x417f8a[a73_0x13cd('0x3b')][0x0][a73_0x13cd('0x41')];const _0x42ece3=_0x417f8a[a73_0x13cd('0x3b')][0x0][a73_0x13cd('0x42')][0x0][a73_0x13cd('0x43')];const _0x4d8c70=_0x417f8a[a73_0x13cd('0x3b')][0x0][a73_0x13cd('0x42')][0x0][a73_0x13cd('0x44')];console[a73_0x13cd('0xc')](_0x5cf766);console[a73_0x13cd('0xc')](_0x1b801e);console[a73_0x13cd('0xc')](_0x57f699);console[a73_0x13cd('0xc')](_0x42ece3);console[a73_0x13cd('0xc')](_0x4d8c70);console[a73_0x13cd('0xc')](_0x5f49d6);if(_0x42ece3>0x0){sequelize_utils_1['default'][a73_0x13cd('0x13')][a73_0x13cd('0x31')]['create']({'amount':_0x42ece3,'counted_at':_0x5f49d6});}sequelize_utils_1[a73_0x13cd('0x7')]['models'][a73_0x13cd('0x45')][a73_0x13cd('0x32')]({'device_id':null,'lat':''+_0x5cf766,'lon':''+_0x1b801e,'tracked_at':_0x5f49d6});}catch(_0x28a3e9){return console['error'](_0x28a3e9);}}});}}});_0x23de6d[a73_0x13cd('0x11')]({'status':0x1,'data':_0x43491f[a73_0x13cd('0x35')]});}}exports['default']=SyncFilesController;