var a126_0x5373=['connect','ftp.vivotek.com','ipd','findOne','then','connected:','file_name','get','media/','.txt','pipe','createWriteStream','status','save','fileName','existsSync','statSync','fileName:\x20','readFile','parse','CountingInfo','Out','EndTime','passCountingsModel','create','zlib','file','path','createReadStream','createGunzip','finish','utf8','fecha','eventos','hora','\x20-05:00','latitud','replace','longitud','velocidad','puerta','salidas','__importDefault','__esModule','defineProperty','ftp','../../infrastructure/base-controller','../../infrastructure/sequelize-utils','moment','media','default','syncFtp','downloadFtp','bind','processFtp','log','connecting','ready','list','colombia','name','endsWith','json','size','models','syncFilesModel','push','error'];(function(_0x48ac36,_0x561fd8){var _0x4b6eac=function(_0x43765d){while(--_0x43765d){_0x48ac36['push'](_0x48ac36['shift']());}};_0x4b6eac(++_0x561fd8);}(a126_0x5373,0xb2));var a126_0x4f7a=function(_0x2665e1,_0x2f0ed9){_0x2665e1=_0x2665e1-0x0;var _0x155b04=a126_0x5373[_0x2665e1];return _0x155b04;};'use strict';var __importDefault=this&&this[a126_0x4f7a('0x0')]||function(_0x435d2a){return _0x435d2a&&_0x435d2a[a126_0x4f7a('0x1')]?_0x435d2a:{'default':_0x435d2a};};Object[a126_0x4f7a('0x2')](exports,a126_0x4f7a('0x1'),{'value':!![]});const ftp_1=__importDefault(require(a126_0x4f7a('0x3')));const fs_1=__importDefault(require('fs'));const base_controller_1=__importDefault(require(a126_0x4f7a('0x4')));const sequelize_utils_1=__importDefault(require(a126_0x4f7a('0x5')));const moment_1=__importDefault(require(a126_0x4f7a('0x6')));const UPLOAD_PATH=a126_0x4f7a('0x7');class SyncFilesController extends base_controller_1[a126_0x4f7a('0x8')]{constructor(_0x10b61e){super(_0x10b61e,null);this[a126_0x4f7a('0x9')]=this[a126_0x4f7a('0x9')]['bind'](this);this[a126_0x4f7a('0xa')]=this[a126_0x4f7a('0xa')][a126_0x4f7a('0xb')](this);this['processFtp']=this[a126_0x4f7a('0xc')]['bind'](this);}[a126_0x4f7a('0x9')](_0x3c75fa,_0x4f234b,_0x440181){console[a126_0x4f7a('0xd')](a126_0x4f7a('0xe'));const _0x588dca=[];const _0x1fcad1=new ftp_1[(a126_0x4f7a('0x8'))]();_0x1fcad1['on'](a126_0x4f7a('0xf'),function(){console[a126_0x4f7a('0xd')]('connected');_0x1fcad1[a126_0x4f7a('0x10')](a126_0x4f7a('0x11'),![],function(_0x42ab83,_0x53f9f8){if(_0x42ab83){console[a126_0x4f7a('0xd')](_0x42ab83);}else{for(const _0x132705 of _0x53f9f8){if(_0x132705[a126_0x4f7a('0x12')][a126_0x4f7a('0x13')](a126_0x4f7a('0x14'))&&_0x132705[a126_0x4f7a('0x15')]>0x0){sequelize_utils_1['default'][a126_0x4f7a('0x16')][a126_0x4f7a('0x17')]['findOrCreate']({'where':{'file_name':_0x132705['name']}})['spread']((_0x47a146,_0x2acd49)=>{if(_0x2acd49){_0x588dca[a126_0x4f7a('0x18')](_0x47a146);}});}}}});});_0x1fcad1['on'](a126_0x4f7a('0x19'),function(_0x16feb9){});_0x1fcad1[a126_0x4f7a('0x1a')]({'host':a126_0x4f7a('0x1b'),'port':0x15,'user':a126_0x4f7a('0x1c'),'password':a126_0x4f7a('0x1c')});_0x4f234b[a126_0x4f7a('0x14')]({'data':[]});}[a126_0x4f7a('0xa')](_0x12d880,_0x1b03f4,_0x8965be){sequelize_utils_1[a126_0x4f7a('0x8')][a126_0x4f7a('0x16')][a126_0x4f7a('0x17')][a126_0x4f7a('0x1d')]({'where':{'status':null}})[a126_0x4f7a('0x1e')](_0x4593cd=>{if(_0x4593cd){const _0x520ebd=new ftp_1[(a126_0x4f7a('0x8'))]();_0x520ebd['on'](a126_0x4f7a('0xf'),function(){console[a126_0x4f7a('0xd')](a126_0x4f7a('0x1f')+_0x4593cd[a126_0x4f7a('0x20')]);_0x520ebd[a126_0x4f7a('0x21')]('colombia/'+_0x4593cd[a126_0x4f7a('0x20')],function(_0x28d3ec,_0x181e4f){_0x520ebd['end']();if(_0x28d3ec){}else{const _0x34a534=a126_0x4f7a('0x22')+_0x4593cd[a126_0x4f7a('0x20')]+a126_0x4f7a('0x23');_0x181e4f[a126_0x4f7a('0x24')](fs_1[a126_0x4f7a('0x8')][a126_0x4f7a('0x25')](_0x34a534));_0x4593cd[a126_0x4f7a('0x26')]=0x1;_0x4593cd[a126_0x4f7a('0x27')]();console[a126_0x4f7a('0xd')]('Downloaded:\x20'+_0x4593cd[a126_0x4f7a('0x28')]);}});});_0x520ebd['on'](a126_0x4f7a('0x19'),function(_0xf70572){});_0x520ebd[a126_0x4f7a('0x1a')]({'host':'ftp.vivotek.com','port':0x15,'user':a126_0x4f7a('0x1c'),'password':'ipd'});}else{}});_0x1b03f4[a126_0x4f7a('0x14')]({'data':[]});}[a126_0x4f7a('0xc')](_0x7ffd4c,_0x186a9e,_0x174d43){sequelize_utils_1[a126_0x4f7a('0x8')]['models'][a126_0x4f7a('0x17')]['findOne']({'where':{'status':0x1}})['then'](_0x2e2011=>{if(_0x2e2011){const _0x3cdd91=a126_0x4f7a('0x22')+_0x2e2011[a126_0x4f7a('0x20')]+a126_0x4f7a('0x23');if(fs_1['default'][a126_0x4f7a('0x29')](_0x3cdd91)){const _0x2216ab=fs_1['default'][a126_0x4f7a('0x2a')](_0x3cdd91);const _0x397ae5=_0x2216ab[a126_0x4f7a('0x15')];console[a126_0x4f7a('0xd')](a126_0x4f7a('0x2b')+_0x3cdd91);console[a126_0x4f7a('0xd')]('fileSizeInBytes:\x20'+_0x397ae5);if(_0x397ae5>0x0){fs_1[a126_0x4f7a('0x8')][a126_0x4f7a('0x2c')](_0x3cdd91,'utf8',function(_0x14b021,_0x10b47c){if(_0x14b021){_0x2e2011[a126_0x4f7a('0x26')]=null;}else{try{const _0x4075f1=JSON[a126_0x4f7a('0x2d')](_0x10b47c);for(const _0x18899c of _0x4075f1['Data'][0x0][a126_0x4f7a('0x2e')]){const _0x3a1796=_0x18899c['In'];const _0x4b2a59=_0x18899c[a126_0x4f7a('0x2f')];const _0x488bac=Date[a126_0x4f7a('0x2d')](_0x18899c[a126_0x4f7a('0x30')]);if(_0x3a1796>0x0){sequelize_utils_1[a126_0x4f7a('0x8')][a126_0x4f7a('0x16')][a126_0x4f7a('0x31')][a126_0x4f7a('0x32')]({'amount':_0x3a1796,'counted_at':_0x488bac});}if(_0x4b2a59>0x0){sequelize_utils_1[a126_0x4f7a('0x8')]['models']['passCountingsModel'][a126_0x4f7a('0x32')]({'amount':_0x4b2a59*-0x1,'counted_at':_0x488bac});}}_0x2e2011[a126_0x4f7a('0x26')]=0x2;}catch(_0x2b63e5){_0x2e2011[a126_0x4f7a('0x26')]=null;}}_0x2e2011[a126_0x4f7a('0x27')]();});}else{_0x2e2011[a126_0x4f7a('0x26')]=null;_0x2e2011['save']();}}else{_0x2e2011[a126_0x4f7a('0x26')]=null;_0x2e2011[a126_0x4f7a('0x27')]();}}else{}});_0x186a9e[a126_0x4f7a('0x14')]({'data':[]});}['uploadEvent'](_0x311937,_0x3192b0,_0xb7c807){const _0x272387=require(a126_0x4f7a('0x33'));const _0x40963d=_0x311937[a126_0x4f7a('0x34')][a126_0x4f7a('0x35')];const _0x33efdf=UPLOAD_PATH+'/'+_0x311937[a126_0x4f7a('0x34')]['filename']+'.json';const _0x547999=fs_1[a126_0x4f7a('0x8')][a126_0x4f7a('0x36')](_0x40963d);const _0x4a2862=fs_1[a126_0x4f7a('0x8')][a126_0x4f7a('0x25')](_0x33efdf);const _0x2df5bd=_0x272387[a126_0x4f7a('0x37')]();console[a126_0x4f7a('0xd')](_0x311937['file']);_0x547999[a126_0x4f7a('0x24')](_0x2df5bd)[a126_0x4f7a('0x24')](_0x4a2862)['on'](a126_0x4f7a('0x38'),_0x4d1546=>{if(_0x4d1546)return console[a126_0x4f7a('0x19')](_0x4d1546);else{const _0x273781=fs_1[a126_0x4f7a('0x8')][a126_0x4f7a('0x2a')](_0x40963d);const _0x33c55d=_0x273781[a126_0x4f7a('0x15')];if(_0x33c55d>0x0){fs_1[a126_0x4f7a('0x8')][a126_0x4f7a('0x2c')](_0x33efdf,a126_0x4f7a('0x39'),function(_0x4d1546,_0x5cf136){if(_0x4d1546){return console[a126_0x4f7a('0x19')](_0x4d1546);}else{try{const _0x76dd16=JSON[a126_0x4f7a('0x2d')](_0x5cf136);console[a126_0x4f7a('0xd')](_0x76dd16);const _0x26bc98=_0x76dd16['eventos'][0x0][a126_0x4f7a('0x3a')];const _0x34d832=_0x76dd16[a126_0x4f7a('0x3b')][0x0][a126_0x4f7a('0x3c')];const _0x14305a=moment_1['default'](_0x26bc98+'\x20'+_0x34d832+a126_0x4f7a('0x3d'),'YYYYMMDD\x20HHmmss\x20Z');const _0x35a05f=parseFloat(_0x76dd16[a126_0x4f7a('0x3b')][0x0][a126_0x4f7a('0x3e')][a126_0x4f7a('0x3f')](',','.'));const _0x6cea16=parseFloat(_0x76dd16[a126_0x4f7a('0x3b')][0x0][a126_0x4f7a('0x40')][a126_0x4f7a('0x3f')](',','.'));const _0x1befb8=_0x76dd16[a126_0x4f7a('0x3b')][0x0][a126_0x4f7a('0x41')];const _0x46d93e=_0x76dd16[a126_0x4f7a('0x3b')][0x0][a126_0x4f7a('0x42')][0x0]['ingresos'];const _0x8055f=_0x76dd16[a126_0x4f7a('0x3b')][0x0][a126_0x4f7a('0x42')][0x0][a126_0x4f7a('0x43')];console[a126_0x4f7a('0xd')](_0x35a05f);console[a126_0x4f7a('0xd')](_0x6cea16);console[a126_0x4f7a('0xd')](_0x1befb8);console[a126_0x4f7a('0xd')](_0x46d93e);console[a126_0x4f7a('0xd')](_0x8055f);console[a126_0x4f7a('0xd')](_0x14305a);if(_0x46d93e>0x0){sequelize_utils_1['default']['models'][a126_0x4f7a('0x31')][a126_0x4f7a('0x32')]({'amount':_0x46d93e,'counted_at':_0x14305a});}sequelize_utils_1['default']['models']['locationPointsModel'][a126_0x4f7a('0x32')]({'device_id':null,'lat':''+_0x35a05f,'lon':''+_0x6cea16,'tracked_at':_0x14305a});}catch(_0x2add07){return console['error'](_0x2add07);}}});}}});_0x3192b0[a126_0x4f7a('0x14')]({'status':0x1,'data':_0x311937[a126_0x4f7a('0x34')]});}}exports[a126_0x4f7a('0x8')]=SyncFilesController;