var a69_0x5d81=['pipe','eventos','fecha','hora','\x20-05:00','YYYYMMDD\x20HHmmss\x20Z','latitud','velocidad','puerta','salidas','__importDefault','__esModule','defineProperty','ftp','../../infrastructure/controller-utils','media','default','syncFtp','bind','downloadFtp','processFtp','log','connecting','connected','colombia','name','json','size','findOrCreate','spread','push','connect','ipd','syncFilesModel','findOne','then','ready','connected:','get','colombia/','file_name','end','.txt','createWriteStream','status','save','error','ftp.vivotek.com','models','existsSync','statSync','fileSizeInBytes:\x20','readFile','utf8','Data','Out','parse','EndTime','passCountingsModel','create','file','path','.json','createReadStream','createGunzip'];(function(_0x2dce11,_0x24dc4e){var _0x427751=function(_0x221e1e){while(--_0x221e1e){_0x2dce11['push'](_0x2dce11['shift']());}};_0x427751(++_0x24dc4e);}(a69_0x5d81,0x1d1));var a69_0x10b4=function(_0x407da1,_0x1053ba){_0x407da1=_0x407da1-0x0;var _0x2479d8=a69_0x5d81[_0x407da1];return _0x2479d8;};'use strict';var __importDefault=this&&this[a69_0x10b4('0x0')]||function(_0x2a0852){return _0x2a0852&&_0x2a0852[a69_0x10b4('0x1')]?_0x2a0852:{'default':_0x2a0852};};Object[a69_0x10b4('0x2')](exports,'__esModule',{'value':!![]});const ftp_1=__importDefault(require(a69_0x10b4('0x3')));const fs_1=__importDefault(require('fs'));const controller_utils_1=__importDefault(require(a69_0x10b4('0x4')));const sequelize_utils_1=__importDefault(require('../../infrastructure/sequelize-utils'));const moment_1=__importDefault(require('moment'));const UPLOAD_PATH=a69_0x10b4('0x5');class SyncFilesController extends controller_utils_1[a69_0x10b4('0x6')]{constructor(_0x4950bf){super(_0x4950bf,null);this['syncFtp']=this[a69_0x10b4('0x7')][a69_0x10b4('0x8')](this);this[a69_0x10b4('0x9')]=this['downloadFtp']['bind'](this);this[a69_0x10b4('0xa')]=this[a69_0x10b4('0xa')]['bind'](this);}['syncFtp'](_0x39b526,_0x3a04ab,_0x110d25){console[a69_0x10b4('0xb')](a69_0x10b4('0xc'));const _0x3b21cc=[];const _0x2b0b79=new ftp_1[(a69_0x10b4('0x6'))]();_0x2b0b79['on']('ready',function(){console[a69_0x10b4('0xb')](a69_0x10b4('0xd'));_0x2b0b79['list'](a69_0x10b4('0xe'),![],function(_0x19cf7d,_0x1c9485){if(_0x19cf7d){console[a69_0x10b4('0xb')](_0x19cf7d);}else{for(const _0x19ce0b of _0x1c9485){if(_0x19ce0b[a69_0x10b4('0xf')]['endsWith'](a69_0x10b4('0x10'))&&_0x19ce0b[a69_0x10b4('0x11')]>0x0){sequelize_utils_1[a69_0x10b4('0x6')]['models']['syncFilesModel'][a69_0x10b4('0x12')]({'where':{'file_name':_0x19ce0b[a69_0x10b4('0xf')]}})[a69_0x10b4('0x13')]((_0xf369bd,_0x3b2de0)=>{if(_0x3b2de0){_0x3b21cc[a69_0x10b4('0x14')](_0xf369bd);}});}}}});});_0x2b0b79['on']('error',function(_0x42c164){});_0x2b0b79[a69_0x10b4('0x15')]({'host':'ftp.vivotek.com','port':0x15,'user':a69_0x10b4('0x16'),'password':a69_0x10b4('0x16')});_0x3a04ab[a69_0x10b4('0x10')]({'data':[]});}[a69_0x10b4('0x9')](_0x14fa7f,_0x555eda,_0x286d48){sequelize_utils_1[a69_0x10b4('0x6')]['models'][a69_0x10b4('0x17')][a69_0x10b4('0x18')]({'where':{'status':null}})[a69_0x10b4('0x19')](_0x2cf7de=>{if(_0x2cf7de){const _0x7657fe=new ftp_1[(a69_0x10b4('0x6'))]();_0x7657fe['on'](a69_0x10b4('0x1a'),function(){console[a69_0x10b4('0xb')](a69_0x10b4('0x1b')+_0x2cf7de['file_name']);_0x7657fe[a69_0x10b4('0x1c')](a69_0x10b4('0x1d')+_0x2cf7de[a69_0x10b4('0x1e')],function(_0x4239f8,_0x475e35){_0x7657fe[a69_0x10b4('0x1f')]();if(_0x4239f8){}else{const _0x1b3baa='media/'+_0x2cf7de['file_name']+a69_0x10b4('0x20');_0x475e35['pipe'](fs_1[a69_0x10b4('0x6')][a69_0x10b4('0x21')](_0x1b3baa));_0x2cf7de[a69_0x10b4('0x22')]=0x1;_0x2cf7de[a69_0x10b4('0x23')]();console[a69_0x10b4('0xb')]('Downloaded:\x20'+_0x2cf7de['fileName']);}});});_0x7657fe['on'](a69_0x10b4('0x24'),function(_0x433ca4){});_0x7657fe[a69_0x10b4('0x15')]({'host':a69_0x10b4('0x25'),'port':0x15,'user':a69_0x10b4('0x16'),'password':'ipd'});}else{}});_0x555eda[a69_0x10b4('0x10')]({'data':[]});}[a69_0x10b4('0xa')](_0x2042a6,_0x186f01,_0x3ea074){sequelize_utils_1[a69_0x10b4('0x6')][a69_0x10b4('0x26')][a69_0x10b4('0x17')][a69_0x10b4('0x18')]({'where':{'status':0x1}})['then'](_0x561563=>{if(_0x561563){const _0x2364c4='media/'+_0x561563[a69_0x10b4('0x1e')]+a69_0x10b4('0x20');if(fs_1[a69_0x10b4('0x6')][a69_0x10b4('0x27')](_0x2364c4)){const _0x444c0a=fs_1[a69_0x10b4('0x6')][a69_0x10b4('0x28')](_0x2364c4);const _0x3e4635=_0x444c0a[a69_0x10b4('0x11')];console[a69_0x10b4('0xb')]('fileName:\x20'+_0x2364c4);console['log'](a69_0x10b4('0x29')+_0x3e4635);if(_0x3e4635>0x0){fs_1[a69_0x10b4('0x6')][a69_0x10b4('0x2a')](_0x2364c4,a69_0x10b4('0x2b'),function(_0x5c01fe,_0x1926a4){if(_0x5c01fe){_0x561563['status']=null;}else{try{const _0x1c8d4=JSON['parse'](_0x1926a4);for(const _0x42652a of _0x1c8d4[a69_0x10b4('0x2c')][0x0]['CountingInfo']){const _0x4cead4=_0x42652a['In'];const _0xa1235e=_0x42652a[a69_0x10b4('0x2d')];const _0x172f71=Date[a69_0x10b4('0x2e')](_0x42652a[a69_0x10b4('0x2f')]);if(_0x4cead4>0x0){sequelize_utils_1[a69_0x10b4('0x6')][a69_0x10b4('0x26')][a69_0x10b4('0x30')][a69_0x10b4('0x31')]({'amount':_0x4cead4,'counted_at':_0x172f71});}if(_0xa1235e>0x0){sequelize_utils_1['default'][a69_0x10b4('0x26')][a69_0x10b4('0x30')][a69_0x10b4('0x31')]({'amount':_0xa1235e*-0x1,'counted_at':_0x172f71});}}_0x561563['status']=0x2;}catch(_0xa83e97){_0x561563['status']=null;}}_0x561563['save']();});}else{_0x561563[a69_0x10b4('0x22')]=null;_0x561563[a69_0x10b4('0x23')]();}}else{_0x561563[a69_0x10b4('0x22')]=null;_0x561563[a69_0x10b4('0x23')]();}}else{}});_0x186f01[a69_0x10b4('0x10')]({'data':[]});}['uploadEvent'](_0x2f3121,_0xa018d3,_0x350726){const _0x247015=require('zlib');const _0x1f0a36=_0x2f3121[a69_0x10b4('0x32')][a69_0x10b4('0x33')];const _0x5953f8=UPLOAD_PATH+'/'+_0x2f3121[a69_0x10b4('0x32')]['filename']+a69_0x10b4('0x34');const _0x54be56=fs_1[a69_0x10b4('0x6')][a69_0x10b4('0x35')](_0x1f0a36);const _0x22c596=fs_1['default']['createWriteStream'](_0x5953f8);const _0x3df1be=_0x247015[a69_0x10b4('0x36')]();console[a69_0x10b4('0xb')](_0x2f3121[a69_0x10b4('0x32')]);_0x54be56[a69_0x10b4('0x37')](_0x3df1be)['pipe'](_0x22c596)['on']('finish',_0x2593b9=>{if(_0x2593b9)return console[a69_0x10b4('0x24')](_0x2593b9);else{const _0x3e0eea=fs_1['default'][a69_0x10b4('0x28')](_0x1f0a36);const _0x19e3d4=_0x3e0eea['size'];if(_0x19e3d4>0x0){fs_1['default'][a69_0x10b4('0x2a')](_0x5953f8,a69_0x10b4('0x2b'),function(_0x2593b9,_0x58379c){if(_0x2593b9){return console[a69_0x10b4('0x24')](_0x2593b9);}else{try{const _0x27bad1=JSON['parse'](_0x58379c);console[a69_0x10b4('0xb')](_0x27bad1);const _0x349118=_0x27bad1[a69_0x10b4('0x38')][0x0][a69_0x10b4('0x39')];const _0x5bfde6=_0x27bad1[a69_0x10b4('0x38')][0x0][a69_0x10b4('0x3a')];const _0x28ed37=moment_1[a69_0x10b4('0x6')](_0x349118+'\x20'+_0x5bfde6+a69_0x10b4('0x3b'),a69_0x10b4('0x3c'));const _0x595887=parseFloat(_0x27bad1['eventos'][0x0][a69_0x10b4('0x3d')]['replace'](',','.'));const _0x4bb0ed=parseFloat(_0x27bad1[a69_0x10b4('0x38')][0x0]['longitud']['replace'](',','.'));const _0x36541e=_0x27bad1[a69_0x10b4('0x38')][0x0][a69_0x10b4('0x3e')];const _0x3fa786=_0x27bad1['eventos'][0x0][a69_0x10b4('0x3f')][0x0]['ingresos'];const _0x33043f=_0x27bad1['eventos'][0x0][a69_0x10b4('0x3f')][0x0][a69_0x10b4('0x40')];console[a69_0x10b4('0xb')](_0x595887);console['log'](_0x4bb0ed);console[a69_0x10b4('0xb')](_0x36541e);console['log'](_0x3fa786);console[a69_0x10b4('0xb')](_0x33043f);console[a69_0x10b4('0xb')](_0x28ed37);if(_0x3fa786>0x0){sequelize_utils_1[a69_0x10b4('0x6')][a69_0x10b4('0x26')]['passCountingsModel'][a69_0x10b4('0x31')]({'amount':_0x3fa786,'counted_at':_0x28ed37});}sequelize_utils_1['default'][a69_0x10b4('0x26')]['locationPointsModel'][a69_0x10b4('0x31')]({'device_id':null,'lat':''+_0x595887,'lon':''+_0x4bb0ed,'tracked_at':_0x28ed37});}catch(_0xc6a52b){return console[a69_0x10b4('0x24')](_0xc6a52b);}}});}}});_0xa018d3[a69_0x10b4('0x10')]({'status':0x1,'data':_0x2f3121[a69_0x10b4('0x32')]});}}exports['default']=SyncFilesController;