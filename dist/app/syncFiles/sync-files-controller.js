var a104_0x52eb=['replace','longitud','velocidad','ingresos','puerta','salidas','locationPointsModel','__importDefault','__esModule','defineProperty','ftp','../../infrastructure/controller-utils','../../infrastructure/sequelize-utils','moment','media','downloadFtp','bind','processFtp','syncFtp','connecting','default','ready','log','connected','list','colombia','name','endsWith','json','models','syncFilesModel','spread','error','ftp.vivotek.com','ipd','then','get','colombia/','file_name','end','.txt','createWriteStream','status','Downloaded:\x20','fileName','findOne','existsSync','statSync','fileSizeInBytes:\x20','readFile','utf8','parse','Data','Out','EndTime','passCountingsModel','create','save','uploadEvent','zlib','file','path','filename','.json','createGunzip','finish','size','eventos','fecha','latitud'];(function(_0x52a7e4,_0x7653a1){var _0x11be7b=function(_0x2bb420){while(--_0x2bb420){_0x52a7e4['push'](_0x52a7e4['shift']());}};_0x11be7b(++_0x7653a1);}(a104_0x52eb,0xd9));var a104_0x307a=function(_0x41b5ff,_0xff9ae8){_0x41b5ff=_0x41b5ff-0x0;var _0x3e8ff1=a104_0x52eb[_0x41b5ff];return _0x3e8ff1;};'use strict';var __importDefault=this&&this[a104_0x307a('0x0')]||function(_0x36439f){return _0x36439f&&_0x36439f[a104_0x307a('0x1')]?_0x36439f:{'default':_0x36439f};};Object[a104_0x307a('0x2')](exports,a104_0x307a('0x1'),{'value':!![]});const ftp_1=__importDefault(require(a104_0x307a('0x3')));const fs_1=__importDefault(require('fs'));const controller_utils_1=__importDefault(require(a104_0x307a('0x4')));const sequelize_utils_1=__importDefault(require(a104_0x307a('0x5')));const moment_1=__importDefault(require(a104_0x307a('0x6')));const UPLOAD_PATH=a104_0x307a('0x7');class SyncFilesController extends controller_utils_1['default']{constructor(_0x4c2948){super(_0x4c2948,null);this['syncFtp']=this['syncFtp']['bind'](this);this[a104_0x307a('0x8')]=this[a104_0x307a('0x8')][a104_0x307a('0x9')](this);this[a104_0x307a('0xa')]=this[a104_0x307a('0xa')][a104_0x307a('0x9')](this);}[a104_0x307a('0xb')](_0x408049,_0x4780b6,_0x51f63b){console['log'](a104_0x307a('0xc'));const _0x1d78c9=[];const _0x159088=new ftp_1[(a104_0x307a('0xd'))]();_0x159088['on'](a104_0x307a('0xe'),function(){console[a104_0x307a('0xf')](a104_0x307a('0x10'));_0x159088[a104_0x307a('0x11')](a104_0x307a('0x12'),![],function(_0x1fc280,_0x219e79){if(_0x1fc280){console[a104_0x307a('0xf')](_0x1fc280);}else{for(const _0x2d8be2 of _0x219e79){if(_0x2d8be2[a104_0x307a('0x13')][a104_0x307a('0x14')](a104_0x307a('0x15'))&&_0x2d8be2['size']>0x0){sequelize_utils_1[a104_0x307a('0xd')][a104_0x307a('0x16')][a104_0x307a('0x17')]['findOrCreate']({'where':{'file_name':_0x2d8be2[a104_0x307a('0x13')]}})[a104_0x307a('0x18')]((_0x4e3e83,_0x450d31)=>{if(_0x450d31){_0x1d78c9['push'](_0x4e3e83);}});}}}});});_0x159088['on'](a104_0x307a('0x19'),function(_0x535bff){});_0x159088['connect']({'host':a104_0x307a('0x1a'),'port':0x15,'user':a104_0x307a('0x1b'),'password':a104_0x307a('0x1b')});_0x4780b6[a104_0x307a('0x15')]({'data':[]});}[a104_0x307a('0x8')](_0xe95940,_0x295e8c,_0x51d953){sequelize_utils_1[a104_0x307a('0xd')]['models'][a104_0x307a('0x17')]['findOne']({'where':{'status':null}})[a104_0x307a('0x1c')](_0x366624=>{if(_0x366624){const _0xb73ffc=new ftp_1[(a104_0x307a('0xd'))]();_0xb73ffc['on'](a104_0x307a('0xe'),function(){console[a104_0x307a('0xf')]('connected:'+_0x366624['file_name']);_0xb73ffc[a104_0x307a('0x1d')](a104_0x307a('0x1e')+_0x366624[a104_0x307a('0x1f')],function(_0x30d50e,_0x473153){_0xb73ffc[a104_0x307a('0x20')]();if(_0x30d50e){}else{const _0x5cd73e='media/'+_0x366624[a104_0x307a('0x1f')]+a104_0x307a('0x21');_0x473153['pipe'](fs_1['default'][a104_0x307a('0x22')](_0x5cd73e));_0x366624[a104_0x307a('0x23')]=0x1;_0x366624['save']();console[a104_0x307a('0xf')](a104_0x307a('0x24')+_0x366624[a104_0x307a('0x25')]);}});});_0xb73ffc['on'](a104_0x307a('0x19'),function(_0x3ad448){});_0xb73ffc['connect']({'host':a104_0x307a('0x1a'),'port':0x15,'user':a104_0x307a('0x1b'),'password':a104_0x307a('0x1b')});}else{}});_0x295e8c['json']({'data':[]});}[a104_0x307a('0xa')](_0x3677b6,_0x344189,_0x4f8e2c){sequelize_utils_1[a104_0x307a('0xd')][a104_0x307a('0x16')][a104_0x307a('0x17')][a104_0x307a('0x26')]({'where':{'status':0x1}})[a104_0x307a('0x1c')](_0x3a50c3=>{if(_0x3a50c3){const _0x2b163b='media/'+_0x3a50c3[a104_0x307a('0x1f')]+'.txt';if(fs_1['default'][a104_0x307a('0x27')](_0x2b163b)){const _0x5846bf=fs_1['default'][a104_0x307a('0x28')](_0x2b163b);const _0x5cad2f=_0x5846bf['size'];console[a104_0x307a('0xf')]('fileName:\x20'+_0x2b163b);console['log'](a104_0x307a('0x29')+_0x5cad2f);if(_0x5cad2f>0x0){fs_1['default'][a104_0x307a('0x2a')](_0x2b163b,a104_0x307a('0x2b'),function(_0x20b52d,_0x3980bb){if(_0x20b52d){_0x3a50c3[a104_0x307a('0x23')]=null;}else{try{const _0x17cc8e=JSON[a104_0x307a('0x2c')](_0x3980bb);for(const _0x57e8a0 of _0x17cc8e[a104_0x307a('0x2d')][0x0]['CountingInfo']){const _0x24fc57=_0x57e8a0['In'];const _0x22509c=_0x57e8a0[a104_0x307a('0x2e')];const _0x3e0ce5=Date[a104_0x307a('0x2c')](_0x57e8a0[a104_0x307a('0x2f')]);if(_0x24fc57>0x0){sequelize_utils_1[a104_0x307a('0xd')][a104_0x307a('0x16')][a104_0x307a('0x30')][a104_0x307a('0x31')]({'amount':_0x24fc57,'counted_at':_0x3e0ce5});}if(_0x22509c>0x0){sequelize_utils_1[a104_0x307a('0xd')][a104_0x307a('0x16')]['passCountingsModel'][a104_0x307a('0x31')]({'amount':_0x22509c*-0x1,'counted_at':_0x3e0ce5});}}_0x3a50c3['status']=0x2;}catch(_0x47fc10){_0x3a50c3[a104_0x307a('0x23')]=null;}}_0x3a50c3[a104_0x307a('0x32')]();});}else{_0x3a50c3[a104_0x307a('0x23')]=null;_0x3a50c3[a104_0x307a('0x32')]();}}else{_0x3a50c3[a104_0x307a('0x23')]=null;_0x3a50c3['save']();}}else{}});_0x344189[a104_0x307a('0x15')]({'data':[]});}[a104_0x307a('0x33')](_0x4b3c85,_0x315282,_0x27b165){const _0x5df6ca=require(a104_0x307a('0x34'));const _0xa6a9e0=_0x4b3c85[a104_0x307a('0x35')][a104_0x307a('0x36')];const _0x2dde39=UPLOAD_PATH+'/'+_0x4b3c85[a104_0x307a('0x35')][a104_0x307a('0x37')]+a104_0x307a('0x38');const _0x4f70bf=fs_1[a104_0x307a('0xd')]['createReadStream'](_0xa6a9e0);const _0x272374=fs_1[a104_0x307a('0xd')][a104_0x307a('0x22')](_0x2dde39);const _0x161250=_0x5df6ca[a104_0x307a('0x39')]();console[a104_0x307a('0xf')](_0x4b3c85[a104_0x307a('0x35')]);_0x4f70bf['pipe'](_0x161250)['pipe'](_0x272374)['on'](a104_0x307a('0x3a'),_0x28d1ff=>{if(_0x28d1ff)return console[a104_0x307a('0x19')](_0x28d1ff);else{const _0x4ec19c=fs_1[a104_0x307a('0xd')][a104_0x307a('0x28')](_0xa6a9e0);const _0x933acf=_0x4ec19c[a104_0x307a('0x3b')];if(_0x933acf>0x0){fs_1[a104_0x307a('0xd')]['readFile'](_0x2dde39,'utf8',function(_0x28d1ff,_0x988463){if(_0x28d1ff){return console['error'](_0x28d1ff);}else{try{const _0x72fcb=JSON['parse'](_0x988463);console[a104_0x307a('0xf')](_0x72fcb);const _0x44028e=_0x72fcb[a104_0x307a('0x3c')][0x0][a104_0x307a('0x3d')];const _0x2d80e5=_0x72fcb[a104_0x307a('0x3c')][0x0]['hora'];const _0x501312=moment_1['default'](_0x44028e+'\x20'+_0x2d80e5+'\x20-05:00','YYYYMMDD\x20HHmmss\x20Z');const _0x4f2070=parseFloat(_0x72fcb[a104_0x307a('0x3c')][0x0][a104_0x307a('0x3e')][a104_0x307a('0x3f')](',','.'));const _0x35398a=parseFloat(_0x72fcb[a104_0x307a('0x3c')][0x0][a104_0x307a('0x40')][a104_0x307a('0x3f')](',','.'));const _0x3cbe09=_0x72fcb['eventos'][0x0][a104_0x307a('0x41')];const _0x4f9c84=_0x72fcb['eventos'][0x0]['puerta'][0x0][a104_0x307a('0x42')];const _0x39415c=_0x72fcb[a104_0x307a('0x3c')][0x0][a104_0x307a('0x43')][0x0][a104_0x307a('0x44')];console[a104_0x307a('0xf')](_0x4f2070);console['log'](_0x35398a);console[a104_0x307a('0xf')](_0x3cbe09);console[a104_0x307a('0xf')](_0x4f9c84);console['log'](_0x39415c);console[a104_0x307a('0xf')](_0x501312);if(_0x4f9c84>0x0){sequelize_utils_1['default'][a104_0x307a('0x16')][a104_0x307a('0x30')][a104_0x307a('0x31')]({'amount':_0x4f9c84,'counted_at':_0x501312});}sequelize_utils_1[a104_0x307a('0xd')][a104_0x307a('0x16')][a104_0x307a('0x45')][a104_0x307a('0x31')]({'device_id':null,'lat':''+_0x4f2070,'lon':''+_0x35398a,'tracked_at':_0x501312});}catch(_0x1f7396){return console[a104_0x307a('0x19')](_0x1f7396);}}});}}});_0x315282[a104_0x307a('0x15')]({'status':0x1,'data':_0x4b3c85[a104_0x307a('0x35')]});}}exports['default']=SyncFilesController;