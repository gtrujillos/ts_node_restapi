var a73_0x3728=['status','save','Downloaded:\x20','error','then','existsSync','statSync','fileSizeInBytes:\x20','readFile','utf8','parse','Out','EndTime','passCountingsModel','create','zlib','file','path','filename','.json','createReadStream','createGunzip','finish','eventos','hora','YYYYMMDD\x20HHmmss\x20Z','longitud','replace','velocidad','ingresos','puerta','salidas','locationPointsModel','__importDefault','__esModule','ftp','../../infrastructure/controller-utils','moment','default','syncFtp','bind','downloadFtp','processFtp','log','connecting','ready','connected','list','colombia','name','endsWith','size','models','findOrCreate','spread','push','connect','ftp.vivotek.com','ipd','json','syncFilesModel','findOne','get','file_name','end','media/','.txt','pipe','createWriteStream'];(function(_0xb3797c,_0x46ef3d){var _0x22f16a=function(_0x2e0325){while(--_0x2e0325){_0xb3797c['push'](_0xb3797c['shift']());}};_0x22f16a(++_0x46ef3d);}(a73_0x3728,0x135));var a73_0x88bd=function(_0x969037,_0x5a6717){_0x969037=_0x969037-0x0;var _0x596d51=a73_0x3728[_0x969037];return _0x596d51;};'use strict';var __importDefault=this&&this[a73_0x88bd('0x0')]||function(_0x9d6380){return _0x9d6380&&_0x9d6380[a73_0x88bd('0x1')]?_0x9d6380:{'default':_0x9d6380};};Object['defineProperty'](exports,a73_0x88bd('0x1'),{'value':!![]});const ftp_1=__importDefault(require(a73_0x88bd('0x2')));const fs_1=__importDefault(require('fs'));const controller_utils_1=__importDefault(require(a73_0x88bd('0x3')));const sequelize_utils_1=__importDefault(require('../../infrastructure/sequelize-utils'));const moment_1=__importDefault(require(a73_0x88bd('0x4')));const UPLOAD_PATH='media';class SyncFilesController extends controller_utils_1[a73_0x88bd('0x5')]{constructor(_0x517c1c){super(_0x517c1c,null);this[a73_0x88bd('0x6')]=this['syncFtp'][a73_0x88bd('0x7')](this);this[a73_0x88bd('0x8')]=this['downloadFtp'][a73_0x88bd('0x7')](this);this[a73_0x88bd('0x9')]=this[a73_0x88bd('0x9')][a73_0x88bd('0x7')](this);}[a73_0x88bd('0x6')](_0x11dae6,_0x48c232,_0x40d293){console[a73_0x88bd('0xa')](a73_0x88bd('0xb'));const _0xcf895b=[];const _0x4fd8bb=new ftp_1[(a73_0x88bd('0x5'))]();_0x4fd8bb['on'](a73_0x88bd('0xc'),function(){console['log'](a73_0x88bd('0xd'));_0x4fd8bb[a73_0x88bd('0xe')](a73_0x88bd('0xf'),![],function(_0x127008,_0x4fca1a){if(_0x127008){console[a73_0x88bd('0xa')](_0x127008);}else{for(const _0x180be8 of _0x4fca1a){if(_0x180be8[a73_0x88bd('0x10')][a73_0x88bd('0x11')]('json')&&_0x180be8[a73_0x88bd('0x12')]>0x0){sequelize_utils_1[a73_0x88bd('0x5')][a73_0x88bd('0x13')]['syncFilesModel'][a73_0x88bd('0x14')]({'where':{'file_name':_0x180be8[a73_0x88bd('0x10')]}})[a73_0x88bd('0x15')]((_0x1164c3,_0x52c10b)=>{if(_0x52c10b){_0xcf895b[a73_0x88bd('0x16')](_0x1164c3);}});}}}});});_0x4fd8bb['on']('error',function(_0x113908){});_0x4fd8bb[a73_0x88bd('0x17')]({'host':a73_0x88bd('0x18'),'port':0x15,'user':a73_0x88bd('0x19'),'password':a73_0x88bd('0x19')});_0x48c232[a73_0x88bd('0x1a')]({'data':[]});}[a73_0x88bd('0x8')](_0x42fe6a,_0x184db6,_0xd30465){sequelize_utils_1[a73_0x88bd('0x5')][a73_0x88bd('0x13')][a73_0x88bd('0x1b')][a73_0x88bd('0x1c')]({'where':{'status':null}})['then'](_0x3b09c1=>{if(_0x3b09c1){const _0x1bd956=new ftp_1[(a73_0x88bd('0x5'))]();_0x1bd956['on'](a73_0x88bd('0xc'),function(){console['log']('connected:'+_0x3b09c1['file_name']);_0x1bd956[a73_0x88bd('0x1d')]('colombia/'+_0x3b09c1[a73_0x88bd('0x1e')],function(_0x376afb,_0x2b9180){_0x1bd956[a73_0x88bd('0x1f')]();if(_0x376afb){}else{const _0x27638d=a73_0x88bd('0x20')+_0x3b09c1['file_name']+a73_0x88bd('0x21');_0x2b9180[a73_0x88bd('0x22')](fs_1[a73_0x88bd('0x5')][a73_0x88bd('0x23')](_0x27638d));_0x3b09c1[a73_0x88bd('0x24')]=0x1;_0x3b09c1[a73_0x88bd('0x25')]();console[a73_0x88bd('0xa')](a73_0x88bd('0x26')+_0x3b09c1['fileName']);}});});_0x1bd956['on'](a73_0x88bd('0x27'),function(_0x12ccc3){});_0x1bd956[a73_0x88bd('0x17')]({'host':a73_0x88bd('0x18'),'port':0x15,'user':a73_0x88bd('0x19'),'password':a73_0x88bd('0x19')});}else{}});_0x184db6[a73_0x88bd('0x1a')]({'data':[]});}[a73_0x88bd('0x9')](_0x319f87,_0xb3c0a1,_0x10a30a){sequelize_utils_1[a73_0x88bd('0x5')]['models'][a73_0x88bd('0x1b')][a73_0x88bd('0x1c')]({'where':{'status':0x1}})[a73_0x88bd('0x28')](_0x239b01=>{if(_0x239b01){const _0x32b048=a73_0x88bd('0x20')+_0x239b01[a73_0x88bd('0x1e')]+a73_0x88bd('0x21');if(fs_1['default'][a73_0x88bd('0x29')](_0x32b048)){const _0x592714=fs_1[a73_0x88bd('0x5')][a73_0x88bd('0x2a')](_0x32b048);const _0x3bf95a=_0x592714[a73_0x88bd('0x12')];console[a73_0x88bd('0xa')]('fileName:\x20'+_0x32b048);console['log'](a73_0x88bd('0x2b')+_0x3bf95a);if(_0x3bf95a>0x0){fs_1[a73_0x88bd('0x5')][a73_0x88bd('0x2c')](_0x32b048,a73_0x88bd('0x2d'),function(_0x588bec,_0xf5351){if(_0x588bec){_0x239b01[a73_0x88bd('0x24')]=null;}else{try{const _0x3291ba=JSON[a73_0x88bd('0x2e')](_0xf5351);for(const _0x2f697e of _0x3291ba['Data'][0x0]['CountingInfo']){const _0x447ba1=_0x2f697e['In'];const _0x2867f8=_0x2f697e[a73_0x88bd('0x2f')];const _0x169e05=Date[a73_0x88bd('0x2e')](_0x2f697e[a73_0x88bd('0x30')]);if(_0x447ba1>0x0){sequelize_utils_1[a73_0x88bd('0x5')][a73_0x88bd('0x13')][a73_0x88bd('0x31')][a73_0x88bd('0x32')]({'amount':_0x447ba1,'counted_at':_0x169e05});}if(_0x2867f8>0x0){sequelize_utils_1['default'][a73_0x88bd('0x13')][a73_0x88bd('0x31')][a73_0x88bd('0x32')]({'amount':_0x2867f8*-0x1,'counted_at':_0x169e05});}}_0x239b01[a73_0x88bd('0x24')]=0x2;}catch(_0x16ee17){_0x239b01[a73_0x88bd('0x24')]=null;}}_0x239b01[a73_0x88bd('0x25')]();});}else{_0x239b01[a73_0x88bd('0x24')]=null;_0x239b01[a73_0x88bd('0x25')]();}}else{_0x239b01[a73_0x88bd('0x24')]=null;_0x239b01['save']();}}else{}});_0xb3c0a1[a73_0x88bd('0x1a')]({'data':[]});}['uploadEvent'](_0x213ace,_0x5963bf,_0x51b565){const _0x29d017=require(a73_0x88bd('0x33'));const _0x5dd4b6=_0x213ace[a73_0x88bd('0x34')][a73_0x88bd('0x35')];const _0x50351d=UPLOAD_PATH+'/'+_0x213ace[a73_0x88bd('0x34')][a73_0x88bd('0x36')]+a73_0x88bd('0x37');const _0x168ca4=fs_1[a73_0x88bd('0x5')][a73_0x88bd('0x38')](_0x5dd4b6);const _0x40286c=fs_1[a73_0x88bd('0x5')][a73_0x88bd('0x23')](_0x50351d);const _0x4966e8=_0x29d017[a73_0x88bd('0x39')]();console[a73_0x88bd('0xa')](_0x213ace[a73_0x88bd('0x34')]);_0x168ca4['pipe'](_0x4966e8)[a73_0x88bd('0x22')](_0x40286c)['on'](a73_0x88bd('0x3a'),_0x2c064d=>{if(_0x2c064d)return console['error'](_0x2c064d);else{const _0x5eb764=fs_1[a73_0x88bd('0x5')][a73_0x88bd('0x2a')](_0x5dd4b6);const _0x41a1d6=_0x5eb764[a73_0x88bd('0x12')];if(_0x41a1d6>0x0){fs_1['default']['readFile'](_0x50351d,a73_0x88bd('0x2d'),function(_0x2c064d,_0x3f7201){if(_0x2c064d){return console['error'](_0x2c064d);}else{try{const _0x2c0d00=JSON[a73_0x88bd('0x2e')](_0x3f7201);console[a73_0x88bd('0xa')](_0x2c0d00);const _0x2b62c2=_0x2c0d00[a73_0x88bd('0x3b')][0x0]['fecha'];const _0x3b96f8=_0x2c0d00['eventos'][0x0][a73_0x88bd('0x3c')];const _0x39361a=moment_1[a73_0x88bd('0x5')](_0x2b62c2+'\x20'+_0x3b96f8+'\x20-05:00',a73_0x88bd('0x3d'));const _0x1baf76=parseFloat(_0x2c0d00['eventos'][0x0]['latitud']['replace'](',','.'));const _0x116d2c=parseFloat(_0x2c0d00[a73_0x88bd('0x3b')][0x0][a73_0x88bd('0x3e')][a73_0x88bd('0x3f')](',','.'));const _0x489e79=_0x2c0d00[a73_0x88bd('0x3b')][0x0][a73_0x88bd('0x40')];const _0x230e38=_0x2c0d00[a73_0x88bd('0x3b')][0x0]['puerta'][0x0][a73_0x88bd('0x41')];const _0x2fe3ba=_0x2c0d00[a73_0x88bd('0x3b')][0x0][a73_0x88bd('0x42')][0x0][a73_0x88bd('0x43')];console['log'](_0x1baf76);console[a73_0x88bd('0xa')](_0x116d2c);console[a73_0x88bd('0xa')](_0x489e79);console['log'](_0x230e38);console[a73_0x88bd('0xa')](_0x2fe3ba);console[a73_0x88bd('0xa')](_0x39361a);if(_0x230e38>0x0){sequelize_utils_1[a73_0x88bd('0x5')][a73_0x88bd('0x13')][a73_0x88bd('0x31')][a73_0x88bd('0x32')]({'amount':_0x230e38,'counted_at':_0x39361a});}sequelize_utils_1[a73_0x88bd('0x5')][a73_0x88bd('0x13')][a73_0x88bd('0x44')][a73_0x88bd('0x32')]({'device_id':null,'lat':''+_0x1baf76,'lon':''+_0x116d2c,'tracked_at':_0x39361a});}catch(_0x259cab){return console[a73_0x88bd('0x27')](_0x259cab);}}});}}});_0x5963bf['json']({'status':0x1,'data':_0x213ace[a73_0x88bd('0x34')]});}}exports[a73_0x88bd('0x5')]=SyncFilesController;