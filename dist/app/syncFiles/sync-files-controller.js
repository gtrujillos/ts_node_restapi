var a73_0x41e3=['defineProperty','../../infrastructure/controller-utils','moment','media','syncFtp','bind','downloadFtp','processFtp','log','connecting','default','ready','connected','list','colombia','endsWith','json','size','syncFilesModel','findOrCreate','name','spread','push','error','connect','ftp.vivotek.com','ipd','models','findOne','then','get','colombia/','file_name','end','media/','createWriteStream','save','Downloaded:\x20','fileName','.txt','existsSync','fileName:\x20','readFile','utf8','status','Data','CountingInfo','Out','passCountingsModel','create','uploadEvent','zlib','filename','.json','createReadStream','createGunzip','pipe','finish','statSync','fecha','hora','\x20-05:00','eventos','latitud','replace','longitud','velocidad','ingresos','puerta','salidas','file','__esModule'];(function(_0x2376d4,_0x6fa57){var _0x1cbd84=function(_0x4a77f7){while(--_0x4a77f7){_0x2376d4['push'](_0x2376d4['shift']());}};_0x1cbd84(++_0x6fa57);}(a73_0x41e3,0x167));var a73_0x1779=function(_0x246902,_0x453411){_0x246902=_0x246902-0x0;var _0x35bccc=a73_0x41e3[_0x246902];return _0x35bccc;};'use strict';var __importDefault=this&&this['__importDefault']||function(_0x25d3ca){return _0x25d3ca&&_0x25d3ca[a73_0x1779('0x0')]?_0x25d3ca:{'default':_0x25d3ca};};Object[a73_0x1779('0x1')](exports,a73_0x1779('0x0'),{'value':!![]});const ftp_1=__importDefault(require('ftp'));const fs_1=__importDefault(require('fs'));const controller_utils_1=__importDefault(require(a73_0x1779('0x2')));const sequelize_utils_1=__importDefault(require('../../infrastructure/sequelize-utils'));const moment_1=__importDefault(require(a73_0x1779('0x3')));const UPLOAD_PATH=a73_0x1779('0x4');class SyncFilesController extends controller_utils_1['default']{constructor(_0x496f0f){super(_0x496f0f,null);this[a73_0x1779('0x5')]=this[a73_0x1779('0x5')][a73_0x1779('0x6')](this);this['downloadFtp']=this[a73_0x1779('0x7')][a73_0x1779('0x6')](this);this[a73_0x1779('0x8')]=this[a73_0x1779('0x8')][a73_0x1779('0x6')](this);}[a73_0x1779('0x5')](_0x518d65,_0x197984,_0x14a993){console[a73_0x1779('0x9')](a73_0x1779('0xa'));const _0x20b679=[];const _0x31f19c=new ftp_1[(a73_0x1779('0xb'))]();_0x31f19c['on'](a73_0x1779('0xc'),function(){console[a73_0x1779('0x9')](a73_0x1779('0xd'));_0x31f19c[a73_0x1779('0xe')](a73_0x1779('0xf'),![],function(_0x36bbc2,_0x15ab89){if(_0x36bbc2){console['log'](_0x36bbc2);}else{for(const _0x295029 of _0x15ab89){if(_0x295029['name'][a73_0x1779('0x10')](a73_0x1779('0x11'))&&_0x295029[a73_0x1779('0x12')]>0x0){sequelize_utils_1[a73_0x1779('0xb')]['models'][a73_0x1779('0x13')][a73_0x1779('0x14')]({'where':{'file_name':_0x295029[a73_0x1779('0x15')]}})[a73_0x1779('0x16')]((_0x4bab93,_0x28f0a1)=>{if(_0x28f0a1){_0x20b679[a73_0x1779('0x17')](_0x4bab93);}});}}}});});_0x31f19c['on'](a73_0x1779('0x18'),function(_0x209215){});_0x31f19c[a73_0x1779('0x19')]({'host':a73_0x1779('0x1a'),'port':0x15,'user':a73_0x1779('0x1b'),'password':a73_0x1779('0x1b')});_0x197984[a73_0x1779('0x11')]({'data':[]});}['downloadFtp'](_0x33c607,_0x6914a2,_0x26e94d){sequelize_utils_1[a73_0x1779('0xb')][a73_0x1779('0x1c')]['syncFilesModel'][a73_0x1779('0x1d')]({'where':{'status':null}})[a73_0x1779('0x1e')](_0xd23f11=>{if(_0xd23f11){const _0x39ce18=new ftp_1[(a73_0x1779('0xb'))]();_0x39ce18['on'](a73_0x1779('0xc'),function(){console[a73_0x1779('0x9')]('connected:'+_0xd23f11['file_name']);_0x39ce18[a73_0x1779('0x1f')](a73_0x1779('0x20')+_0xd23f11[a73_0x1779('0x21')],function(_0x390a93,_0x1c1279){_0x39ce18[a73_0x1779('0x22')]();if(_0x390a93){}else{const _0x279017=a73_0x1779('0x23')+_0xd23f11[a73_0x1779('0x21')]+'.txt';_0x1c1279['pipe'](fs_1['default'][a73_0x1779('0x24')](_0x279017));_0xd23f11['status']=0x1;_0xd23f11[a73_0x1779('0x25')]();console[a73_0x1779('0x9')](a73_0x1779('0x26')+_0xd23f11[a73_0x1779('0x27')]);}});});_0x39ce18['on']('error',function(_0x291865){});_0x39ce18['connect']({'host':a73_0x1779('0x1a'),'port':0x15,'user':a73_0x1779('0x1b'),'password':a73_0x1779('0x1b')});}else{}});_0x6914a2['json']({'data':[]});}[a73_0x1779('0x8')](_0x548b5e,_0x294112,_0x4da13b){sequelize_utils_1[a73_0x1779('0xb')][a73_0x1779('0x1c')][a73_0x1779('0x13')][a73_0x1779('0x1d')]({'where':{'status':0x1}})['then'](_0x946c49=>{if(_0x946c49){const _0x535d33='media/'+_0x946c49[a73_0x1779('0x21')]+a73_0x1779('0x28');if(fs_1[a73_0x1779('0xb')][a73_0x1779('0x29')](_0x535d33)){const _0x1a4339=fs_1[a73_0x1779('0xb')]['statSync'](_0x535d33);const _0x4e9533=_0x1a4339['size'];console[a73_0x1779('0x9')](a73_0x1779('0x2a')+_0x535d33);console[a73_0x1779('0x9')]('fileSizeInBytes:\x20'+_0x4e9533);if(_0x4e9533>0x0){fs_1[a73_0x1779('0xb')][a73_0x1779('0x2b')](_0x535d33,a73_0x1779('0x2c'),function(_0x11db54,_0x5c6276){if(_0x11db54){_0x946c49[a73_0x1779('0x2d')]=null;}else{try{const _0x2c5e82=JSON['parse'](_0x5c6276);for(const _0x5618f1 of _0x2c5e82[a73_0x1779('0x2e')][0x0][a73_0x1779('0x2f')]){const _0x492b7d=_0x5618f1['In'];const _0x1acbe6=_0x5618f1[a73_0x1779('0x30')];const _0x13e7c7=Date['parse'](_0x5618f1['EndTime']);if(_0x492b7d>0x0){sequelize_utils_1[a73_0x1779('0xb')][a73_0x1779('0x1c')][a73_0x1779('0x31')]['create']({'amount':_0x492b7d,'counted_at':_0x13e7c7});}if(_0x1acbe6>0x0){sequelize_utils_1[a73_0x1779('0xb')][a73_0x1779('0x1c')]['passCountingsModel'][a73_0x1779('0x32')]({'amount':_0x1acbe6*-0x1,'counted_at':_0x13e7c7});}}_0x946c49[a73_0x1779('0x2d')]=0x2;}catch(_0x2145b8){_0x946c49[a73_0x1779('0x2d')]=null;}}_0x946c49['save']();});}else{_0x946c49['status']=null;_0x946c49[a73_0x1779('0x25')]();}}else{_0x946c49[a73_0x1779('0x2d')]=null;_0x946c49['save']();}}else{}});_0x294112['json']({'data':[]});}[a73_0x1779('0x33')](_0x14abd5,_0x3fdce6,_0x57770f){const _0x4d26cf=require(a73_0x1779('0x34'));const _0xfdaa3e=_0x14abd5['file']['path'];const _0x28e6aa=UPLOAD_PATH+'/'+_0x14abd5['file'][a73_0x1779('0x35')]+a73_0x1779('0x36');const _0xe92557=fs_1[a73_0x1779('0xb')][a73_0x1779('0x37')](_0xfdaa3e);const _0x299674=fs_1[a73_0x1779('0xb')]['createWriteStream'](_0x28e6aa);const _0x45670a=_0x4d26cf[a73_0x1779('0x38')]();console[a73_0x1779('0x9')](_0x14abd5['file']);_0xe92557[a73_0x1779('0x39')](_0x45670a)[a73_0x1779('0x39')](_0x299674)['on'](a73_0x1779('0x3a'),_0x47e9cb=>{if(_0x47e9cb)return console[a73_0x1779('0x18')](_0x47e9cb);else{const _0x13c680=fs_1[a73_0x1779('0xb')][a73_0x1779('0x3b')](_0xfdaa3e);const _0x1d5070=_0x13c680[a73_0x1779('0x12')];if(_0x1d5070>0x0){fs_1[a73_0x1779('0xb')]['readFile'](_0x28e6aa,a73_0x1779('0x2c'),function(_0x47e9cb,_0xfaf19b){if(_0x47e9cb){return console[a73_0x1779('0x18')](_0x47e9cb);}else{try{const _0x33463f=JSON['parse'](_0xfaf19b);console[a73_0x1779('0x9')](_0x33463f);const _0x480409=_0x33463f['eventos'][0x0][a73_0x1779('0x3c')];const _0xd228eb=_0x33463f['eventos'][0x0][a73_0x1779('0x3d')];const _0x4ed4a9=moment_1[a73_0x1779('0xb')](_0x480409+'\x20'+_0xd228eb+a73_0x1779('0x3e'),'YYYYMMDD\x20HHmmss\x20Z');const _0x428c1c=parseFloat(_0x33463f[a73_0x1779('0x3f')][0x0][a73_0x1779('0x40')][a73_0x1779('0x41')](',','.'));const _0x197690=parseFloat(_0x33463f[a73_0x1779('0x3f')][0x0][a73_0x1779('0x42')][a73_0x1779('0x41')](',','.'));const _0x3470d2=_0x33463f['eventos'][0x0][a73_0x1779('0x43')];const _0xa5f625=_0x33463f['eventos'][0x0]['puerta'][0x0][a73_0x1779('0x44')];const _0xda608d=_0x33463f[a73_0x1779('0x3f')][0x0][a73_0x1779('0x45')][0x0][a73_0x1779('0x46')];console[a73_0x1779('0x9')](_0x428c1c);console[a73_0x1779('0x9')](_0x197690);console[a73_0x1779('0x9')](_0x3470d2);console['log'](_0xa5f625);console[a73_0x1779('0x9')](_0xda608d);console[a73_0x1779('0x9')](_0x4ed4a9);if(_0xa5f625>0x0){sequelize_utils_1['default'][a73_0x1779('0x1c')][a73_0x1779('0x31')][a73_0x1779('0x32')]({'amount':_0xa5f625,'counted_at':_0x4ed4a9});}sequelize_utils_1['default']['models']['locationPointsModel'][a73_0x1779('0x32')]({'device_id':null,'lat':''+_0x428c1c,'lon':''+_0x197690,'tracked_at':_0x4ed4a9});}catch(_0x4a225c){return console['error'](_0x4a225c);}}});}}});_0x3fdce6[a73_0x1779('0x11')]({'status':0x1,'data':_0x14abd5[a73_0x1779('0x47')]});}}exports['default']=SyncFilesController;