var a73_0x4f48=['longitud','velocidad','puerta','ingresos','salidas','__esModule','defineProperty','ftp','../../infrastructure/controller-utils','moment','media','default','syncFtp','bind','downloadFtp','processFtp','log','connecting','ready','connected','list','colombia','name','endsWith','json','size','models','syncFilesModel','findOrCreate','spread','push','error','connect','ipd','then','connected:','file_name','get','end','media/','.txt','pipe','status','save','fileName','findOne','existsSync','fileSizeInBytes:\x20','readFile','utf8','parse','Out','EndTime','create','uploadEvent','zlib','path','file','filename','.json','createReadStream','createWriteStream','createGunzip','finish','fecha','eventos','hora','\x20-05:00','replace'];(function(_0x469317,_0x34e6ac){var _0x347d4=function(_0x505437){while(--_0x505437){_0x469317['push'](_0x469317['shift']());}};_0x347d4(++_0x34e6ac);}(a73_0x4f48,0x1a3));var a73_0x2023=function(_0x426feb,_0x39c2eb){_0x426feb=_0x426feb-0x0;var _0x291985=a73_0x4f48[_0x426feb];return _0x291985;};'use strict';var __importDefault=this&&this['__importDefault']||function(_0x5b1a9d){return _0x5b1a9d&&_0x5b1a9d[a73_0x2023('0x0')]?_0x5b1a9d:{'default':_0x5b1a9d};};Object[a73_0x2023('0x1')](exports,a73_0x2023('0x0'),{'value':!![]});const ftp_1=__importDefault(require(a73_0x2023('0x2')));const fs_1=__importDefault(require('fs'));const controller_utils_1=__importDefault(require(a73_0x2023('0x3')));const sequelize_utils_1=__importDefault(require('../../infrastructure/sequelize-utils'));const moment_1=__importDefault(require(a73_0x2023('0x4')));const UPLOAD_PATH=a73_0x2023('0x5');class SyncFilesController extends controller_utils_1[a73_0x2023('0x6')]{constructor(_0x1ab27e){super(_0x1ab27e,null);this[a73_0x2023('0x7')]=this['syncFtp'][a73_0x2023('0x8')](this);this[a73_0x2023('0x9')]=this['downloadFtp'][a73_0x2023('0x8')](this);this[a73_0x2023('0xa')]=this[a73_0x2023('0xa')][a73_0x2023('0x8')](this);}[a73_0x2023('0x7')](_0x38a422,_0x135d5e,_0x257c4b){console[a73_0x2023('0xb')](a73_0x2023('0xc'));const _0x463a2e=[];const _0x47f003=new ftp_1['default']();_0x47f003['on'](a73_0x2023('0xd'),function(){console[a73_0x2023('0xb')](a73_0x2023('0xe'));_0x47f003[a73_0x2023('0xf')](a73_0x2023('0x10'),![],function(_0x524852,_0x5c96ff){if(_0x524852){console[a73_0x2023('0xb')](_0x524852);}else{for(const _0x1d7b65 of _0x5c96ff){if(_0x1d7b65[a73_0x2023('0x11')][a73_0x2023('0x12')](a73_0x2023('0x13'))&&_0x1d7b65[a73_0x2023('0x14')]>0x0){sequelize_utils_1['default'][a73_0x2023('0x15')][a73_0x2023('0x16')][a73_0x2023('0x17')]({'where':{'file_name':_0x1d7b65['name']}})[a73_0x2023('0x18')]((_0x47ab98,_0x44485b)=>{if(_0x44485b){_0x463a2e[a73_0x2023('0x19')](_0x47ab98);}});}}}});});_0x47f003['on'](a73_0x2023('0x1a'),function(_0x59f670){});_0x47f003[a73_0x2023('0x1b')]({'host':'ftp.vivotek.com','port':0x15,'user':'ipd','password':a73_0x2023('0x1c')});_0x135d5e[a73_0x2023('0x13')]({'data':[]});}['downloadFtp'](_0x3bd1eb,_0x32d1c7,_0x38a24a){sequelize_utils_1[a73_0x2023('0x6')][a73_0x2023('0x15')]['syncFilesModel']['findOne']({'where':{'status':null}})[a73_0x2023('0x1d')](_0x1c05be=>{if(_0x1c05be){const _0x5199a6=new ftp_1[(a73_0x2023('0x6'))]();_0x5199a6['on'](a73_0x2023('0xd'),function(){console['log'](a73_0x2023('0x1e')+_0x1c05be[a73_0x2023('0x1f')]);_0x5199a6[a73_0x2023('0x20')]('colombia/'+_0x1c05be[a73_0x2023('0x1f')],function(_0x1751c6,_0x5b267a){_0x5199a6[a73_0x2023('0x21')]();if(_0x1751c6){}else{const _0x48afcc=a73_0x2023('0x22')+_0x1c05be[a73_0x2023('0x1f')]+a73_0x2023('0x23');_0x5b267a[a73_0x2023('0x24')](fs_1[a73_0x2023('0x6')]['createWriteStream'](_0x48afcc));_0x1c05be[a73_0x2023('0x25')]=0x1;_0x1c05be[a73_0x2023('0x26')]();console['log']('Downloaded:\x20'+_0x1c05be[a73_0x2023('0x27')]);}});});_0x5199a6['on'](a73_0x2023('0x1a'),function(_0x458735){});_0x5199a6[a73_0x2023('0x1b')]({'host':'ftp.vivotek.com','port':0x15,'user':a73_0x2023('0x1c'),'password':a73_0x2023('0x1c')});}else{}});_0x32d1c7[a73_0x2023('0x13')]({'data':[]});}[a73_0x2023('0xa')](_0xe41c4f,_0x572d84,_0x3ee6d4){sequelize_utils_1['default'][a73_0x2023('0x15')][a73_0x2023('0x16')][a73_0x2023('0x28')]({'where':{'status':0x1}})[a73_0x2023('0x1d')](_0x359529=>{if(_0x359529){const _0x312b6a=a73_0x2023('0x22')+_0x359529['file_name']+a73_0x2023('0x23');if(fs_1[a73_0x2023('0x6')][a73_0x2023('0x29')](_0x312b6a)){const _0x16167e=fs_1[a73_0x2023('0x6')]['statSync'](_0x312b6a);const _0x1cdc97=_0x16167e[a73_0x2023('0x14')];console[a73_0x2023('0xb')]('fileName:\x20'+_0x312b6a);console[a73_0x2023('0xb')](a73_0x2023('0x2a')+_0x1cdc97);if(_0x1cdc97>0x0){fs_1[a73_0x2023('0x6')][a73_0x2023('0x2b')](_0x312b6a,a73_0x2023('0x2c'),function(_0x26e1b1,_0x3e55cb){if(_0x26e1b1){_0x359529[a73_0x2023('0x25')]=null;}else{try{const _0x2d98dd=JSON[a73_0x2023('0x2d')](_0x3e55cb);for(const _0x22c1fe of _0x2d98dd['Data'][0x0]['CountingInfo']){const _0x4b0700=_0x22c1fe['In'];const _0x2a2134=_0x22c1fe[a73_0x2023('0x2e')];const _0x5bb54a=Date['parse'](_0x22c1fe[a73_0x2023('0x2f')]);if(_0x4b0700>0x0){sequelize_utils_1[a73_0x2023('0x6')][a73_0x2023('0x15')]['passCountingsModel']['create']({'amount':_0x4b0700,'counted_at':_0x5bb54a});}if(_0x2a2134>0x0){sequelize_utils_1[a73_0x2023('0x6')][a73_0x2023('0x15')]['passCountingsModel'][a73_0x2023('0x30')]({'amount':_0x2a2134*-0x1,'counted_at':_0x5bb54a});}}_0x359529['status']=0x2;}catch(_0x58edc2){_0x359529[a73_0x2023('0x25')]=null;}}_0x359529[a73_0x2023('0x26')]();});}else{_0x359529['status']=null;_0x359529[a73_0x2023('0x26')]();}}else{_0x359529['status']=null;_0x359529[a73_0x2023('0x26')]();}}else{}});_0x572d84['json']({'data':[]});}[a73_0x2023('0x31')](_0x1d54fc,_0x21127c,_0x3e1fab){const _0x5e5db3=require(a73_0x2023('0x32'));const _0x461d5a=_0x1d54fc['file'][a73_0x2023('0x33')];const _0x5e616a=UPLOAD_PATH+'/'+_0x1d54fc[a73_0x2023('0x34')][a73_0x2023('0x35')]+a73_0x2023('0x36');const _0x4df256=fs_1['default'][a73_0x2023('0x37')](_0x461d5a);const _0x3940d5=fs_1[a73_0x2023('0x6')][a73_0x2023('0x38')](_0x5e616a);const _0x5b66bd=_0x5e5db3[a73_0x2023('0x39')]();console[a73_0x2023('0xb')](_0x1d54fc[a73_0x2023('0x34')]);_0x4df256[a73_0x2023('0x24')](_0x5b66bd)[a73_0x2023('0x24')](_0x3940d5)['on'](a73_0x2023('0x3a'),_0x676f98=>{if(_0x676f98)return console[a73_0x2023('0x1a')](_0x676f98);else{const _0x39e855=fs_1[a73_0x2023('0x6')]['statSync'](_0x461d5a);const _0x317282=_0x39e855[a73_0x2023('0x14')];if(_0x317282>0x0){fs_1[a73_0x2023('0x6')][a73_0x2023('0x2b')](_0x5e616a,a73_0x2023('0x2c'),function(_0x676f98,_0x2c88fe){if(_0x676f98){return console[a73_0x2023('0x1a')](_0x676f98);}else{try{const _0x383237=JSON[a73_0x2023('0x2d')](_0x2c88fe);console[a73_0x2023('0xb')](_0x383237);const _0x5bb1a2=_0x383237['eventos'][0x0][a73_0x2023('0x3b')];const _0x1391c8=_0x383237[a73_0x2023('0x3c')][0x0][a73_0x2023('0x3d')];const _0x1ee43d=moment_1[a73_0x2023('0x6')](_0x5bb1a2+'\x20'+_0x1391c8+a73_0x2023('0x3e'),'YYYYMMDD\x20HHmmss\x20Z');const _0x35cb8b=parseFloat(_0x383237[a73_0x2023('0x3c')][0x0]['latitud'][a73_0x2023('0x3f')](',','.'));const _0x5146df=parseFloat(_0x383237[a73_0x2023('0x3c')][0x0][a73_0x2023('0x40')][a73_0x2023('0x3f')](',','.'));const _0x302082=_0x383237[a73_0x2023('0x3c')][0x0][a73_0x2023('0x41')];const _0xe8a9c5=_0x383237[a73_0x2023('0x3c')][0x0][a73_0x2023('0x42')][0x0][a73_0x2023('0x43')];const _0x8c256f=_0x383237[a73_0x2023('0x3c')][0x0][a73_0x2023('0x42')][0x0][a73_0x2023('0x44')];console[a73_0x2023('0xb')](_0x35cb8b);console[a73_0x2023('0xb')](_0x5146df);console['log'](_0x302082);console[a73_0x2023('0xb')](_0xe8a9c5);console['log'](_0x8c256f);console['log'](_0x1ee43d);if(_0xe8a9c5>0x0){sequelize_utils_1['default'][a73_0x2023('0x15')]['passCountingsModel'][a73_0x2023('0x30')]({'amount':_0xe8a9c5,'counted_at':_0x1ee43d});}sequelize_utils_1['default']['models']['locationPointsModel'][a73_0x2023('0x30')]({'device_id':null,'lat':''+_0x35cb8b,'lon':''+_0x5146df,'tracked_at':_0x1ee43d});}catch(_0x248bf4){return console[a73_0x2023('0x1a')](_0x248bf4);}}});}}});_0x21127c[a73_0x2023('0x13')]({'status':0x1,'data':_0x1d54fc[a73_0x2023('0x34')]});}}exports['default']=SyncFilesController;